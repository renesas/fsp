<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: AWS Device Provisioning</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v2.1.1</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___d_e_v_i_c_e___p_r_o_v_i_s_i_o_n_i_n_g.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AWS Device Provisioning<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>AWS Device Provisioning example software. </p>
<h1>Overview</h1>
<h2>Terminology</h2>
<p>The terminology defined below will be used in the following sections.</p>
<table class="doxtable">
<tr>
<th>Term </th><th>Description  </th></tr>
<tr>
<td>Service Provider </td><td>Entity that provides the cloud infrastructure and associated services, for example, AWS/Azure. </td></tr>
<tr>
<td>Device Manufacturer </td><td>Entity that provides the MCU, for example, Renesas. </td></tr>
<tr>
<td>OEM </td><td>Entity that uses the MCU to create a product. </td></tr>
<tr>
<td>Customer </td><td>End user of OEM product. </td></tr>
</table>
<h2>Device ID</h2>
<p>For systems that intend to use Public Key Certificate (PKC), the Device ID is in the form of a key pair (RSA or ECC). A PKC comprises of a <b>public key</b>, metadata, and finally a signature over all that. This signature is generated by the entity that issues the certificate and is known as a CA (Certificate Authority). The most common format for a public certificate is the <a href="https://tools.ietf.org/html/rfc5280#section-4.1">X.509 format</a> which is typically PEM (base 64) encoded such that the certificate is human-readable. It can also be DER encoded which is binary encoding and thus not human readable. The <b>public key</b> portion of the Device ID is used for the Device Certificate. </p>
<h2>Provisioning</h2>
<p>Device Provisioning refers to the process by which a service provider links a certificate to a Device ID and thus a device. Depending on the provisioning model, an existing certificate from the device may be used or a new one will be issued at this stage.  Provisioning (also referred to as Registration) occurs with respect to a particular service provider, for example, AWS or Azure. It is necessary that the certificate is issued by the service provider or a CA known to those providers. When a device is provisioned with AWS for example, the AWS IoT service associates the Device ID (and thus the device) with a specific certificate. The certificate will be programmed into the device and for all future transactions with AWS, the certificate will be used as the means of identifying the device. The public and private key are also stored on the MCU.</p>
<h2>Provisioning Models</h2>
<p>Provisioning services vary between <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-provision.html">service providers</a>. There are essentially three general provisioning models. </p>
<ol type="1">
<li>Provisioning happens on the production line. This requires the provisioning Infrastructure to be present on the production line. This is the most secure model, but is expensive. </li>
<li>Devices are programmed with a shared credential that is linked into the code at build time and the provisioning occurs when a customer uses the device for the first time. The shared credential and a unique device serial number are used to uniquely identify the device during the provisioning process. So long as the product only has the shared credential, it will only operate with limited (as defined by certificate policy) functionality .Once the provisioning is done, then the device will be fully functional. This is the most common use case for consumer products where no sensitive information is being transmitted. AWS provides an <a href="https://aws.amazon.com/blogs/iot/provisioning-with-a-bootstrap-certificate-in-aws-iot-core/">example</a> of this model.</li>
<li>Devices have no identity programmed in the factory; provisioning occurs through some other device like a smartphone which is already trusted by the service provider. </li>
</ol>
<p>In all these cases, the Device Identity </p>
<ol type="1">
<li>Is unique to the device</li>
<li>Must have restricted access within the device</li>
<li>Can be used to issue more than one certificate and the certificates themselves have to be updatable in the field. </li>
</ol>
<p>AWS uses the PKCS11 API to erase, store and retrieve certificates. These PKCS11 functions (Write, Read and Erase) are separated out into a Physical Abstraction Layer (PAL) which the OEM/Device Manufacturer is expected to implement for the type of memory that they intend to use. The internal rm_aws_pkcs11_pal module implements these requirements on RA MCU data flash. </p>
<h1>AWS Provisioning Example</h1>
<p>AWS provides an <b>example</b> implementation to support device provisioning. This implementation uses the PKCS11 API to store device credentials into the PKCS11 defined memory. The implementation (aws_dev_mode_key_provisioning.c) exposes two functions:</p><ol type="1">
<li>vDevModeKeyProvisioning()</li>
<li>vAlternateKeyProvisioning()</li>
</ol>
<p>Both of these functions require that the device credentials be provided in PEM format. Using either of these example functions as is in production is not recommended; but vAlternateKeyProvisioning() provides more flexibility because of the ability to provide credentials as arguments.</p>
<p>Credentials can be created as follows:</p><ul>
<li><a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-certs-your-own.html">Create your own CA</a> and use that to generate the device certificate. This CA will have to be registered with the service provider with which the product will be used, for example <a href="https://docs.aws.amazon.com/cli/latest/reference/iot/register-ca-certificate.html">Register your CA with AWS</a>.</li>
<li><a href="https://docs.aws.amazon.com/iot/latest/developerguide/create-device-certificate.html">Use AWS</a> to generate the device certificate.</li>
</ul>
<h1><a class="anchor" id="renesas-aws-device_provisioning-examples"></a>
Examples</h1>
<h2>Basic Example</h2>
<p>This is a basic example of provisioning a device using the AWS demo implementation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define keyCLIENT_CERTIFICATE_PEM                                        \</span></div><div class="line"><span class="preprocessor">    &quot;-----BEGIN CERTIFICATE-----\n&quot;                                      \</span></div><div class="line"><span class="preprocessor">    &quot;MIIDETCCAfkCFHwd2yn8zn5qB2ChYUT9Mvbi9Xp1MA0GCSqGSIb3DQEBCwUAMEUx\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;CzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRl\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;cm5ldCBXaWRnaXRzIFB0eSBMdGQwHhcNMTkwOTExMjEyMjU0WhcNMjAwOTEwMjEy\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;MjU0WjBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UE\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;CgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOC\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;AQ8AMIIBCgKCAQEAo8oThJXSMDo41oL7HTpC4TX8NalBvnkFw30Av67dl/oZDjVA\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;iXPnZkhVppLnj++0/Oed0M7UwNUO2nurQt6yTYrvW7E8ZPjAlC7ueJcGYZhOaVv2\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;bhSmigjFQru2lw5odSuYy5+22CCgxft58nrRCo5Bk+GwWgZmcrxe/BzutRHQ7X4x\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;dYJhyhBOi2R1Kt8XsbuWilfgfkVhhkVklFeKqiypdQM6cnPWo/G4DyW34jOXzzEM\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;FLWvQOQLCKUZOgjJBnFdbx8oOOwMkYCChbV7gqPE6cw0Zy26CvlLQiINyonLPbNT\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;c64sS/ZBGPZFOPJmb4tG2nipYgZ1hO/r++jCbwIDAQABMA0GCSqGSIb3DQEBCwUA\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;A4IBAQCdqq59ubdRY9EiV3bleKXeqG7+8HgBHdm0X9dgq10nD37p00YLyuZLE9NM\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;066G/VcflGrx/Nzw+/UuI7/UuBbBS/3ppHRnsZqBIl8nnr/ULrFQy8z3vKtL1q3C\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;DxabjPONlPO2keJeTTA71N/RCEMwJoa8i0XKXGdu/hQo6x4n+Gq73fEiGCl99xsc\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;4tIO4yPS4lv+uXBzEUzoEy0CLIkiDesnT5lLeCyPmUNoU89HU95IusZT7kygCHHd\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;72am1ic3X8PKc268KT3ilr3VMhK67C+iIIkfrM5AiU+oOIRrIHSC/p0RigJg3rXA\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;GBIRHvt+OYF9fDeG7U4QDJNCfGW+\n&quot;                                     \</span></div><div class="line"><span class="preprocessor">    &quot;-----END CERTIFICATE-----&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define keyCLIENT_PRIVATE_KEY_PEM                                        \</span></div><div class="line"><span class="preprocessor">    &quot;-----BEGIN RSA PRIVATE KEY-----\n&quot;                                  \</span></div><div class="line"><span class="preprocessor">    &quot;MIIEowIBAAKCAQEAo8oThJXSMDo41oL7HTpC4TX8NalBvnkFw30Av67dl/oZDjVA\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;iXPnZkhVppLnj++0/Oed0M7UwNUO2nurQt6yTYrvW7E8ZPjAlC7ueJcGYZhOaVv2\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;bhSmigjFQru2lw5odSuYy5+22CCgxft58nrRCo5Bk+GwWgZmcrxe/BzutRHQ7X4x\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;dYJhyhBOi2R1Kt8XsbuWilfgfkVhhkVklFeKqiypdQM6cnPWo/G4DyW34jOXzzEM\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;FLWvQOQLCKUZOgjJBnFdbx8oOOwMkYCChbV7gqPE6cw0Zy26CvlLQiINyonLPbNT\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;c64sS/ZBGPZFOPJmb4tG2nipYgZ1hO/r++jCbwIDAQABAoIBAQCGR2hC/ZVJhqIM\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;c2uuJZKpElpIIBBPOObZwwS3IYR4UUjzVgMn7UbbmxflLXD8lzfZU4YVp0vTH5lC\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;07qvYuXpHqtnj+GEok837VYCtUY9AuHeDM/2paV3awNV15E1PFG1Jd3pqnH7tJw6\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;VBZBDiGNNt1agN/UnoSlMfvpU0r8VGPXCBNxe3JY5QyBJPI1wF4LcxRI+eYmr7Ja\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;/cjn97DZotgz4B7gUNu8XIEkUOTwPabZINY1zcLWiXTMA+8qTniPVk653h14Xqt4\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;4o4D4YCTpwJcmxSV1m21/6+uyuXr9SIKAE+Ys2cYLA46x+rwLaW5fUoQ5hHa0Ytb\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;RYJ4SrtBAoGBANWtwlE69N0hq5xDPckSbNGubIeG8P4mBhGkJxIqYoqugGLMDiGX\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;4bltrjr2TPWaxTo3pPavLJiBMIsENA5KU+c/r0jLkxgEp9MIVJrtNgkCiDQqogBG\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;j4IJL2iQwXoLCqk2tx/dh9Mww+7SETE7EPNrv4UrYaGN5AEvpf5W+NHPAoGBAMQ6\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;wVa0Mx1PlA4enY2rfE3WXP8bzjleSOwR75JXqG2WbPC0/cszwbyPWOEqRpBZfvD/\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;QFkKx06xp1C09XwiQanr2gDucYXHeEKg/9iuJV1UkMQp95ojlhtSXdRZV7/l4pmN\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;fpB2vcAptX/4gY4tDrWMO08JNnRjE7duC+rmmk1hAoGAS4L0QLCNB/h2JOq+Uuhn\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;/FGfmOVfFPFrA6D3DbxcxpWUWVWzSLvb0SOphryzxbfEKyau7V5KbDp7ZSU/IC20\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;KOygjSEkAkDi7fjrrTRW/Cgg6g6G4YIOBO4qCtHdDbwJMHNdk6096qw5EZS67qLp\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;Apz5OZ5zChySjri/+HnTxJECgYBysGSP6IJ3fytplTtAshnU5JU2BWpi3ViBoXoE\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;bndilajWhvJO8dEqBB5OfAcCF0y6TnWtlT8oH21LHnjcNKlsRw0Dvllbd1oylybx\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;3da41dRG0sCEtoflMB7nHdDLt/DZDnoKtVvyFG6gfP47utn+Ahgn+Zp6K+46J3eP\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;s3g8AQKBgE/PJiaF8pbBXaZOuwRRA9GOMSbDIF6+jBYTYp4L9wk4+LZArKtyI+4k\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;Md2DUvHwMC+ddOtKqjYnLm+V5cSbvu7aPvBZtwxghzTUDcf7EvnA3V/bQBh3R0z7\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;pVsxTyGRmBSeLdbUWACUbX9LXdpudarPAJ59daWmP3mBEVmWdzUw\n&quot;             \</span></div><div class="line"><span class="preprocessor">    &quot;-----END RSA PRIVATE KEY-----&quot;</span></div><div class="line"><span class="keywordtype">void</span> device_provisioning_example (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Initialize the crypto hardware acceleration. */</span></div><div class="line">    <a class="code" href="group___r_m___p_s_a___c_r_y_p_t_o.html#gaf0f37c11be234650bec95ce37e9a4a6b">mbedtls_platform_setup</a>(NULL);</div><div class="line"></div><div class="line">    ProvisioningParams_t params;</div><div class="line"></div><div class="line">    <span class="comment">/* Provision device with provided credentials. The provided credentials are written to data flash.</span></div><div class="line"><span class="comment">     * In production, the credentials can be provided over a comms channel instead of being linked into the image.</span></div><div class="line"><span class="comment">     * The same example provisioning function, vAlternateKeyProvisioning, can be used in that case. */</span></div><div class="line">    params.pucClientPrivateKey       = (uint8_t *) keyCLIENT_PRIVATE_KEY_PEM;</div><div class="line">    params.pucClientCertificate      = (uint8_t *) keyCLIENT_CERTIFICATE_PEM;</div><div class="line">    params.ulClientPrivateKeyLength  = 1 + strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *) params.pucClientPrivateKey);</div><div class="line">    params.ulClientCertificateLength = 1 + strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *) params.pucClientCertificate);</div><div class="line">    params.pucJITPCertificate        = NULL;</div><div class="line">    params.ulJITPCertificateLength   = 0;</div><div class="line">    vAlternateKeyProvisioning(&amp;params);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h1>Limitations</h1>
<p>The provisioning code is an example provided by AWS. It must be modified to meet product requirements. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v2.1.1 User's Manual Copyright © (2020) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
