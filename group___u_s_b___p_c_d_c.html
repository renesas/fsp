<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: USB Peripheral Communications Device Class (r_usb_pcdc)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/javascript" src="search/lunr.js"></script>
    <link href="search/lunrsearch.css" rel="stylesheet" type="text/css">
    <script src="search/lunr_index.js"></script>
    <script src="search/lunrclient.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v3.3.0</span>
   </div>
  </td>
   <td>        <br /><div id="MSearchBox" class="MSearchBoxInactive">
 
    <form id="lunrSearchForm" name="lunrSearchForm">
      <span class="left" >
          <img id="MSearchSelect" src="search/mag_sel.png"
               alt=""/>
         <input class="search-input" id="MSearchField" name="q" placeholder="Search" type="text"> 
      </span>
      <span class="right">
          &nbsp; 
      </span>
        <!--<input type="submit" value="Search">-->
    </form>
</div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___u_s_b___p_c_d_c.html','');});
</script>

<script src="search/mark.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() { 
    var options = {         // allows highlighting across element boundaries.
      "acrossElements": true
    };
    var bodyText = $("div.contents").text(); // try contents instead of body. 
    // If using body: Problem may be that text inside <script> tags is included in .text() - but not in cheerio?
    // If using div.contents - works 
    var fullURL = $(location).attr('href');
    var splitURL = fullURL.split("?");  // Get param string: content after "?" in URL
    if (splitURL.length > 1) {          // If any content after "?"
      var paramStr = splitURL[1];
      var params = paramStr.split("&"); // Split params on "&"
      for (i = 0; i < params.length; i++) {
        var paramPair = params[i].split("=");
        if (paramPair[0] == "pos") {     // If any param starts "pos", get the content after "="
          posStr = paramPair[1];
          var splitPos = posStr.split(",");
          var termArray = [];
        // termArray will have the search terms
            for (i=0; i < splitPos.length; i += 2) {
            start = splitPos[i];
            len = splitPos[i+1]; // Needs error detection! Vulnerable if non-even # of pos entries
            term = bodyText.substr(start,len);
            if (termArray.includes(term) == false) {     // List all unique terms
                termArray.push(bodyText.substr(start,len)); 
            }
          } 
    //      console.log(termArray);
          var context = document.querySelector("div.contents");
          var instance = new Mark(context);
          for(i=0;i<termArray.length; i+=1) {
            instance.mark(termArray[i],options);  // Use Mark.js to mark all terms in termArray
            }    
          var firstMark = document.querySelector("mark");
          firstMark.scrollIntoView(true);
          //      console.log($("mark").first().text()); // Trying to scroll to first Mark element. 
        }
            }
    }
  });
</script>

<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />

<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<!-- Lunr search results -->
<div id="lunrResultBox" style="
        position: fixed;
        border: 1px solid black;
        background-color: WhiteSmoke;  
        padding: 10px;
        width: 500px;
        height: 500px;
        top: 30;
        right: 0;
        overflow: auto;
        display: none">
    <button onclick="closeLunrResults()" style="float: right;">X</button>
    <div class="resultCount" id="resultCount"></div>
    <div id="searchResults"></div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">USB Peripheral Communications Device Class (r_usb_pcdc)<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>This module provides a USB Peripheral Communications Device Class Driver (PCDC). It implements the <a class="el" href="group___u_s_b___p_c_d_c___a_p_i.html">USB PCDC Interface</a>. </p>
<p><a class="anchor" id="functionss"></a></p><h2 class="groupheader">Functions</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> for the common API (r_usb_basic) to be called from the application. <a class="anchor" id="details"></a></p><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="r-usb_pcdc-overview"></a>
Overview</h1>
<p>The r_usb_pcdc module combines with the r_usb_basic module to provide a USB Peripheral Communications Device Class (PCDC) driver. The PCDC driver conforms to Abstract Control Model of the USB Communications Device Class (CDC) specification and enables communication with a CDC host device.</p>
<h2><a class="anchor" id="r-usb_pcdc-features"></a>
Features</h2>
<p>The r_usb_pcdc module has the following key features:</p><ul>
<li>Data transfer to and from a USB host</li>
<li>Response to CDC class requests</li>
<li>Supports CDC notifications</li>
</ul>
<h1><a class="anchor" id="r-usb_pcdc-configuration"></a>
Configuration</h1>
<p><h2>Build Time Configurations for r_usb_pcdc</h2>
The following build time configurations are defined in fsp_cfg/r_usb_pcdc_cfg.h:<br />
</p><table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Default</th><th>Description </th></tr>
<tr>
<td>Bulk In Pipe</td><td><ul style="margin-top:0;margin-bottom:0;">
<li>
USB PIPE1</li>
<li>
USB PIPE2</li>
<li>
USB PIPE3</li>
<li>
USB PIPE4</li>
<li>
USB PIPE5</li>
</ul>
</td><td>USB PIPE1 </td><td>Select the USB pipe to use for bulk input transfers. </td></tr>
<tr>
<td>Bulk Out Pipe</td><td><ul style="margin-top:0;margin-bottom:0;">
<li>
USB PIPE1</li>
<li>
USB PIPE2</li>
<li>
USB PIPE3</li>
<li>
USB PIPE4</li>
<li>
USB PIPE5</li>
</ul>
</td><td>USB PIPE2 </td><td>Select the USB pipe to use for bulk output transfers. </td></tr>
<tr>
<td>Interrupt Out Pipe</td><td><ul style="margin-top:0;margin-bottom:0;">
<li>
USB PIPE6</li>
<li>
USB PIPE7</li>
<li>
USB PIPE8</li>
<li>
USB PIPE9</li>
</ul>
</td><td>USB PIPE6 </td><td>Select the USB pipe to use for interrupts. </td></tr>
</table>
 <h2>Configurations for Middleware &gt; USB &gt; USB PCDC driver on r_usb_pcdc</h2>
This module can be added to the Stacks tab via New Stack &gt; Middleware &gt; USB &gt; USB PCDC driver on r_usb_pcdc.<br />
</p><table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Default</th><th>Description </th></tr>
<tr>
<td>Name</td><td>Name must be a valid C symbol</td><td>g_pcdc0 </td><td>Module name. </td></tr>
</table>
</p>
<dl class="section note"><dt>Note</dt><dd>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module for hardware configuration options.</dd></dl>
<h2><a class="anchor" id="r-usb_pcdc-clock-configuration"></a>
Clock Configuration</h2>
<p>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module.</p>
<h2><a class="anchor" id="r-usb_pcdc-pin-configuration"></a>
Pin Configuration</h2>
<p>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module.</p>
<h1><a class="anchor" id="r-usb_pcdc-usage_notes"></a>
Usage Notes</h1>
<h2>Abstract Control Model Overview</h2>
<p>The Abstract Control Model subclass of CDC is a technology that bridges the gap between USB devices and earlier modems (employing RS-232C connections), enabling use of application programs designed for older modems.</p>
<h3>Class Requests (Host to Peripheral)</h3>
<p>This driver notifies the application when receiving the following class requests:</p>
<table class="doxtable">
<tr>
<th align="left">Request </th><th align="left">Code </th><th align="left">Description  </th></tr>
<tr>
<td align="left">SetLineCoding </td><td align="left">0x20 </td><td align="left">Sets communication line settings (bitrate, data length, parity, and stop bit length) </td></tr>
<tr>
<td align="left">GetLineCoding </td><td align="left">0x21 </td><td align="left">Acquires the communication line setting state </td></tr>
<tr>
<td align="left">SetControlLineState </td><td align="left">0x22 </td><td align="left">Set communication line control signals (RTS, DTR) </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>For details concerning the Abstract Control Model requests, refer to Table 11 "Requests - Abstract Control Model" in the "USB Communications Class Subclass Specification for PSTN Devices", Revision 1.2.</dd></dl>
<h3>Data Format of Class Requests</h3>
<p>The data format of supported class requests is described below:</p>
<table class="doxtable">
<tr>
<th align="center">bmRequestType </th><th align="center">bRequest </th><th align="center">wValue </th><th align="center">wIndex </th><th align="center">wLength </th><th align="left">Data  </th></tr>
<tr>
<td align="center">0x21 </td><td align="center">SET_LINE_CODING (0x20) </td><td align="center">0x0000 </td><td align="center">0x0000 </td><td align="center">0x0007 </td><td align="left"><a class="el" href="group___u_s_b___p_c_d_c___a_p_i.html#structusb__pcdc__linecoding__t">usb_pcdc_linecoding_t</a> </td></tr>
<tr>
<td align="center">0xA1 </td><td align="center">GET_LINE_CODING (0x21) </td><td align="center">0x0000 </td><td align="center">0x0000 </td><td align="center">0x0007 </td><td align="left"><a class="el" href="group___u_s_b___p_c_d_c___a_p_i.html#structusb__pcdc__linecoding__t">usb_pcdc_linecoding_t</a> </td></tr>
<tr>
<td align="center">0x21 </td><td align="center">SET_CONTROL_LINE_STATE (0x22) </td><td align="center"><a class="el" href="group___u_s_b___p_c_d_c___a_p_i.html#structusb__pcdc__ctrllinestate__t">usb_pcdc_ctrllinestate_t</a> </td><td align="center">0x0000 </td><td align="center">0x0000 </td><td align="left">None </td></tr>
</table>
<h3>Class Notifications (Peripheral to Host)</h3>
<p>The following class notifications are supported:</p>
<table class="doxtable">
<tr>
<th align="left">Notification </th><th align="center">Code </th><th align="left">Description  </th></tr>
<tr>
<td align="left">SERIAL_STATE </td><td align="center">0x20 </td><td align="left">Notification of serial line state </td></tr>
</table>
<p>The data types returned are as follows:</p>
<table class="doxtable">
<tr>
<th align="center">bmRequestType </th><th align="left">bRequest </th><th align="center">wValue </th><th align="center">wIndex </th><th align="center">wLength </th><th align="left">Data  </th></tr>
<tr>
<td align="center">0xA1 </td><td align="left">SERIAL_STATE (0x20) </td><td align="center">0x0000 </td><td align="center">0x0000 </td><td align="center">0x0002 </td><td align="left"><a class="el" href="group___u_s_b___p_c_d_c___a_p_i.html#structusb__serial__state__bitmap__t">usb_serial_state_bitmap_t</a> </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>The host is notified with SERIAL_STATE whenever a change in the UART port state is detected. This driver will automatically detect overrun, parity and framing errors. A state notification is performed when a transition from normal to error state is detected.</dd></dl>
<h3>Virtual COM-port Usage</h3>
<p>When connected to a PC the CDC device can be used as a virtual COM port. After enumeration, the CDC class requests GetLineCoding and SetControlLineState are executed by the target, and the CDC device is registered in Windows Device Manager as a virtual COM device.</p>
<p>Registering the CDC device as a virtual COM-port in Windows Device Manager enables data communication with the CDC device via a terminal app such as <a href="https://www.putty.org/">PuTTY</a>. When changing settings of the serial port in the terminal application, the UART setting is propagated to the firmware via the class request SetLineCoding.</p>
<p>Data input (or file transmission) from the terminal app window is transmitted to the board using endpoint 2 (EP2); data from the board side is transmitted to the PC using EP1.</p>
<p>When the last packet of data received is the maximum packet size, and the terminal determines that there is continuous data, the received data may not be displayed in the terminal. If the received data is smaller than the maximum packet size, the data received up to that point is displayed in the terminal.</p>
<h2>Multi Port</h2>
<p>This driver supports simultaneous operation with Host Mass Storage Class(HMSC). If the user are using MCU that supports 2 USB modules, such as RA6M3, the user can run PCDC on one USB module and HMSC on the other. This driver does not support simultaneous operation using device classes other than HMSC.</p>
<h2><a class="anchor" id="r-usb_pcdc-limitations"></a>
Limitations</h2>
<ul>
<li>This module must be incorporated into a project using r_usb_basic and does not provide any public APIs.</li>
<li>This driver does not support Low-speed.</li>
</ul>
<h1><a class="anchor" id="r-usb_pcdc-examples"></a>
Examples</h1>
<h2>USB PCDC Loopback Example</h2>
<p>The main functions of the PCDC loopback example are as follows:</p>
<ol type="1">
<li>Receives virtual UART configuration data from the host terminal</li>
<li>Loops all other received data back to the host terminal</li>
</ol>
<div class="image">
<img src="r_usb_pcdc_operating_environment_echo.png" alt="r_usb_pcdc_operating_environment_echo.png"/>
<div class="caption">
Example Operating Environment</div></div>
 <div class="image">
<img src="r_usb_pcdc_task_flow_sample.png" alt="r_usb_pcdc_task_flow_sample.png"/>
<div class="caption">
Main Loop processing (Echo mode)</div></div>
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> usb_basic_example (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    usb_event_info_t event_info;</div><div class="line">    <a class="code" href="group___u_s_b___a_p_i.html#ga56bea25fbffdbda134044c49d40d5e40">usb_status_t</a>     event;</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line"></div><div class="line">        <span class="comment">/* Get USB event data */</span></div><div class="line">        g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a3acf29ae5b0455d82149e36b5387d02d">eventGet</a>(&amp;event_info, &amp;event);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">/* Handle the received event (if any) */</span></div><div class="line">        <span class="keywordflow">switch</span> (event)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ab5c3bd23fe62533150eef3a4e8c8d13c">USB_STATUS_CONFIGURED</a>:</div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ad44448290b4f36868a09b48e4588b29d">USB_STATUS_WRITE_COMPLETE</a>:</div><div class="line"></div><div class="line"></div><div class="line">                <span class="comment">/* Initialization complete; get data from host */</span></div><div class="line">                g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a1f8293d27b1dee87d1e925800c70edb3">read</a>(&amp;g_basic0_ctrl, g_buf, DATA_LEN, <a class="code" href="group___u_s_b___a_p_i.html#ggab1dc4a2240edf1a50cca3945f31dc9f2a80c133e3ac3ddabc6aa656c3daf78c5e">USB_CLASS_PCDC</a>);</div><div class="line"></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40a63dd4552584256ef9d1a0d5da2159e9c">USB_STATUS_READ_COMPLETE</a>:</div><div class="line"></div><div class="line"></div><div class="line">                <span class="comment">/* Loop back received data to host */</span></div><div class="line">                g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a6eb4c329c32333e7475202b7f5825bce">write</a>(&amp;g_basic0_ctrl, g_buf, event_info.data_size, <a class="code" href="group___u_s_b___a_p_i.html#ggab1dc4a2240edf1a50cca3945f31dc9f2a80c133e3ac3ddabc6aa656c3daf78c5e">USB_CLASS_PCDC</a>);</div><div class="line"></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40a8b49ebc4d15054963bdbe8d843a2cf5a">USB_STATUS_REQUEST</a>:   <span class="comment">/* Receive Class Request */</span></div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___u_s_b___p_c_d_c___a_p_i.html#ga9e76ac14dae5e5e44b5df6e8cbee6bd0">USB_PCDC_SET_LINE_CODING</a> == (event_info.setup.request_type &amp; <a class="code" href="group___u_s_b___a_p_i.html#ga3a6743f3e336fc05e70e59b05206f634">USB_BREQUEST</a>))</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Configure virtual UART settings */</span></div><div class="line">                    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#acfd255be34c610f854f8bedb4a1a0a4f">periControlDataGet</a>(&amp;g_basic0_ctrl, (uint8_t *) &amp;g_line_coding, LINE_CODING_LENGTH);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group___u_s_b___p_c_d_c___a_p_i.html#ga3e7ae95dcfc42bd8912fe18339893d82">USB_PCDC_GET_LINE_CODING</a> == (event_info.setup.request_type &amp; <a class="code" href="group___u_s_b___a_p_i.html#ga3a6743f3e336fc05e70e59b05206f634">USB_BREQUEST</a>))</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Send virtual UART settings back to host */</span></div><div class="line">                    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ada9e58c96ca03bf9140ba2db36a4214c">periControlDataSet</a>(&amp;g_basic0_ctrl, (uint8_t *) &amp;g_line_coding, LINE_CODING_LENGTH);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="comment">/* ACK all other status requests */</span></div><div class="line">                    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a29903dba1e2952e264159322340db640">periControlStatusSet</a>(&amp;g_basic0_ctrl, <a class="code" href="group___u_s_b___a_p_i.html#gga386cabe04206e06b3be8dbafc0bc3d86a20a1e7b4a77141981d824649cab7554b">USB_SETUP_STATUS_ACK</a>);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40adb879552af43dda95b70261eaa810777">USB_STATUS_SUSPEND</a>:</div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ae9bcf94bdb90960ca692b1dfecb98e78">USB_STATUS_DETACH</a>:</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h1><a class="anchor" id="r-usb_pcdc-descriptor"></a>
Descriptor</h1>
<p>A template for PCDC descriptors can be found in ra/fsp/src/r_usb_pcdc/r_usb_pcdc_descriptor.c.template. Also, please be sure to use your vendor ID.</p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v3.3.0 User's Manual Copyright Â© (2021) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
