<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: USB Peripheral Mass Storage Class (r_usb_pmsc)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v2.1.1</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___u_s_b___p_m_s_c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB Peripheral Mass Storage Class (r_usb_pmsc)<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>This module provides a USB Peripheral Mass Storage Class (PMSC) driver. It implements the <a class="el" href="group___u_s_b___p_m_s_c___a_p_i.html">USB PMSC Interface</a>. </p>
<p><a class="anchor" id="functionss"></a></p><h2 class="groupheader">Functions</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> for the common API (r_usb_basic) to be called from the application. <a class="anchor" id="details"></a></p><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="r-usb_pmsc-overview"></a>
Overview</h1>
<p>The r_usb_pmsc module combines with the r_usb_basic module to provide USB Peripheral It operates as a Mass Storage class driver (hereinafter referred to as PMSC). <br />
The USB peripheral mass storage class driver (PMSC) comprises a USB mass storage class bulk-only transport (BOT) protocol. <br />
When combined with a USB peripheral control driver and media driver, it enables communication with a USB host as a BOT-compatible storage device.</p>
<h2><a class="anchor" id="r-usb_pmsc-features"></a>
Features</h2>
<p>The r_usb_pmsc module has the following key features:</p><ul>
<li>Storage command control using the BOT protocol</li>
<li>Supports SFF-8070i (ATAPI)</li>
<li>Response to mass storage device class requests from a USB host</li>
</ul>
<h1><a class="anchor" id="r-usb_pmsc-configuration"></a>
Configuration</h1>
<p><h2>Build Time Configurations for r_usb_pmsc</h2>
The following build time configurations are defined in fsp_cfg/r_usb_pmsc_cfg.h:<br />
</p><table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Default</th><th>Description </th></tr>
<tr>
<td>Bulk Input Transfer Pipe</td><td><ul style="margin-top:0;margin-bottom:0;">
<li>
USB PIPE1</li>
<li>
USB PIPE2</li>
<li>
USB PIPE3</li>
<li>
USB PIPE4</li>
<li>
USB PIPE5</li>
</ul>
</td><td>USB PIPE1 </td><td>Select the USB pipe to use for bulk input transfers. </td></tr>
<tr>
<td>Bulk Output Transfer Pipe</td><td><ul style="margin-top:0;margin-bottom:0;">
<li>
USB PIPE1</li>
<li>
USB PIPE2</li>
<li>
USB PIPE3</li>
<li>
USB PIPE4</li>
<li>
USB PIPE5</li>
</ul>
</td><td>USB PIPE2 </td><td>Select the USB pipe to use for bulk output transfers. </td></tr>
<tr>
<td>Vendor Information</td><td>Vendor Information must be 8 bytes long; pad with spaces if shorter.</td><td>Vendor </td><td>Specify the vendor information field (part of the Inquiry command response). </td></tr>
<tr>
<td>Product Information</td><td>Product Information must be 16 bytes long; pad with spaces if shorter.</td><td>Mass Storage </td><td>Specify the product information field (part of the Inquiry command response). </td></tr>
<tr>
<td>Product Revision Level.</td><td>Product Revision Level must be 4 bytes long; pad with spaces if shorter.</td><td>1.00 </td><td>Specify the product revision level field (part of the Inquiry command response). </td></tr>
<tr>
<td>Number of Transfer Sectors</td><td>Please enter a number between 1 and 255.</td><td>8 </td><td>Specify the maximum sector size to request with one data transfer. </td></tr>
</table>
 <h2>Configurations for Middleware &gt; USB &gt; USB PMSC driver on r_usb_pmsc</h2>
This module can be added to the Stacks tab via New Stack &gt; Middleware &gt; USB &gt; USB PMSC driver on r_usb_pmsc.<br />
</p><table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Default</th><th>Description </th></tr>
<tr>
<td>Name</td><td>Name must be a valid C symbol</td><td>g_pmsc0 </td><td>Module name. </td></tr>
</table>
</p>
<p>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module for hardware configuration options.</p>
<h2><a class="anchor" id="r-usb_pmsc-clock-configuration"></a>
Clock Configuration</h2>
<p>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module.</p>
<h2><a class="anchor" id="r-usb_pmsc-pin-configuration"></a>
Pin Configuration</h2>
<p>Refer to the <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> module.</p>
<h1><a class="anchor" id="r-usb_pmsc-usage_notes"></a>
Usage Notes</h1>
<h2>Class Requests</h2>
<p>The class requests supported by this driver are shown below.</p>
<table class="doxtable">
<tr>
<th align="left">Request </th><th align="left">Code </th><th align="left">Description  </th></tr>
<tr>
<td align="left">Bulk-Only Mass Storage Reset </td><td align="left">0xFF </td><td align="left">Resets the connection interface to the mass storage device. </td></tr>
<tr>
<td align="left">Get Max Logical Unit Number </td><td align="left">0xFE </td><td align="left">Reports the logical numbers supported by the device. </td></tr>
</table>
<h2>Storage Commands</h2>
<p>This driver supports the following storage commands.</p>
<table class="doxtable">
<tr>
<th align="left">Command </th><th align="left">Code </th><th align="left">Description  </th></tr>
<tr>
<td align="left">TEST_UNIT_READY </td><td align="left">0x00 </td><td align="left">Checks the state of the peripheral device. </td></tr>
<tr>
<td align="left">REQUEST_SENSE </td><td align="left">0x03 </td><td align="left">Gets the error information of the previous storage command execution result. </td></tr>
<tr>
<td align="left">INQUIRY </td><td align="left">0x12 </td><td align="left">Gets the parameter information of the logical unit. </td></tr>
<tr>
<td align="left">READ_FORMAT_CAPACITY </td><td align="left">0x23 </td><td align="left">Gets the formattable capacity. </td></tr>
<tr>
<td align="left">READ_CAPACITY </td><td align="left">0x25 </td><td align="left">Gets the capacity information of the logical unit. </td></tr>
<tr>
<td align="left">READ10 </td><td align="left">0x28 </td><td align="left">Reads data. </td></tr>
<tr>
<td align="left">WRITE10 </td><td align="left">0x1A </td><td align="left">Writes data. </td></tr>
<tr>
<td align="left">MODE_SENSE10 </td><td align="left">0x5A </td><td align="left">Gets the parameters of the logical unit. </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>A STALL or FAIL error is sent to the host upon receipt of any command not listed in the above table.</dd></dl>
<h2>BOT Protocol Overview</h2>
<p>BOT (USB MSC Bulk-Only Transport) is a transfer protocol that encapsulates command, data, and status (results of commands) using only two endpoints (one bulk in and one bulk out). The ATAPI storage commands and the response status are embedded in a Command Block Wrapper (CBW) and a Command Status Wrapper (CSW). The below image shows an overview of how the BOT protocol progresses with command and status data flowing between USB host and peripheral.</p>
<div class="image">
<object type="image/svg+xml" data="r_usb_pmsc_bot_protocol_overview.svg">r_usb_pmsc_bot_protocol_overview.svg</object>
<div class="caption">
BOT protocol Overview</div></div>
 <h2>Block Media Interface</h2>
<p>PMSC implements a block media interface to enable access to higher-level modules. If the block media interface supports multiple media, users can select any media to access. </p><dl class="section note"><dt>Note</dt><dd>When the user develops the storage media driver, be sure to define the instance named "g_rm_block_media0".</dd></dl>
<h2><a class="anchor" id="r-usb_pmsc-limitations"></a>
Limitations</h2>
<ol type="1">
<li>The driver always returns 0 in response to the GetMaxLun command.</li>
<li>The driver supports a sector size of 512 bytes only.</li>
<li>The only media currently supported by the block media interface is an SD card. The card must be inserted before initializing the driver.</li>
<li>When using DMA for Hi-Speed transfers continuous transfer mode must not be used in the USB Basic driver.</li>
<li>The storage area must be formatted before use.</li>
<li>When using the SD/MMC Block Media Implementation (rm_block_media_sdmmc), "Card Detection" must be set to "Not Used" in the SD/MMC Host Interface (r_sdhi) settings.</li>
<li>The driver does not support Low-speed.</li>
</ol>
<h1><a class="anchor" id="r-usb_pmsc-examples"></a>
Examples</h1>
<h2>USB PMSC Example</h2>
<p>In this example, when the evaluation board is connected to the host PC it is recognized as a removable disk and reading/writing files is possible. The FAT type is either FAT12, FAT16, or FAT32 depending on the size of the media used.</p>
<div class="image">
<object type="image/svg+xml" data="r_usb_pmsc_operating_environment.svg">r_usb_pmsc_operating_environment.svg</object>
<div class="caption">
Example Operating Environment</div></div>
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> usb_pmsc_example (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    usb_event_info_t usb_event;</div><div class="line"><span class="preprocessor">#if (BSP_CFG_RTOS == 2)</span></div><div class="line">    usb_event_info_t * p_mess;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___u_s_b___a_p_i.html#ga56bea25fbffdbda134044c49d40d5e40">usb_status_t</a> event;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/* Loop back between PC(TerminalSoft) and USB MCU */</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line"><span class="preprocessor">#if (BSP_CFG_RTOS == 2)</span></div><div class="line">        USB_APL_RCV_MSG(USB_APL_MBX, (usb_msg_t **) &amp;p_mess);</div><div class="line">        usb_event = *p_mess;</div><div class="line"></div><div class="line">        <span class="comment">/* Analyzing the received message */</span></div><div class="line">        <span class="keywordflow">switch</span> (usb_event.event)</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* (BSP_CFG_RTOS == 2) */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">        g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a3acf29ae5b0455d82149e36b5387d02d">eventGet</a>(&amp;usb_event, &amp;event);</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (event)</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* (BSP_CFG_RTOS == 2) */</span><span class="preprocessor"></span></div><div class="line">        {</div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ab5c3bd23fe62533150eef3a4e8c8d13c">USB_STATUS_CONFIGURED</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40adb879552af43dda95b70261eaa810777">USB_STATUS_SUSPEND</a>:</div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ae9bcf94bdb90960ca692b1dfecb98e78">USB_STATUS_DETACH</a>:</div><div class="line">            {</div><div class="line"><span class="preprocessor">#if USB_SUPPORT_LPW == USB_APL_ENABLE</span></div><div class="line"></div><div class="line"><span class="comment">// @@                low_power_mcu();</span></div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* USB_SUPPORT_LPW == USB_APL_ENABLE */</span><span class="preprocessor"></span></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}                                      <span class="comment">/* End of function usb_main() */</span></div><div class="line"></div></div><!-- fragment --> <h1><a class="anchor" id="r-usb_pmsc-descriptor"></a>
Descriptor</h1>
<p>A template for PMSC descriptors can be found in ra/fsp/src/r_usb_pmsc/r_usb_pmsc_descriptor.c.template. Also, please be sure to use your vendor ID.</p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v2.1.1 User's Manual Copyright Â© (2020) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
