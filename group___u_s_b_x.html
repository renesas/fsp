<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: USBX Porting Layer (rm_usbx_port)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/javascript" src="search/lunr.js"></script>
    <link href="search/lunrsearch.css" rel="stylesheet" type="text/css">
    <script src="search/lunr_index.js"></script>
    <script src="search/lunrclient.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v3.6.0</span>
   </div>
  </td>
   <td>        <br /><div id="MSearchBox" class="MSearchBoxInactive">
 
    <form id="lunrSearchForm" name="lunrSearchForm">
      <span class="left" >
          <img id="MSearchSelect" src="search/mag_sel.png"
               alt=""/>
         <input class="search-input" id="MSearchField" name="q" placeholder="Search" type="text"> 
      </span>
      <span class="right">
          &nbsp; 
      </span>
        <!--<input type="submit" value="Search">-->
    </form>
</div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___u_s_b_x.html','');});
</script>

<script src="search/mark.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() { 
    var options = {         // allows highlighting across element boundaries.
      "acrossElements": true
    };
    var bodyText = $("div.contents").text(); // try contents instead of body. 
    // If using body: Problem may be that text inside <script> tags is included in .text() - but not in cheerio?
    // If using div.contents - works 
    var fullURL = $(location).attr('href');
    var splitURL = fullURL.split("?");  // Get param string: content after "?" in URL
    if (splitURL.length > 1) {          // If any content after "?"
      var paramStr = splitURL[1];
      var params = paramStr.split("&"); // Split params on "&"
      for (i = 0; i < params.length; i++) {
        var paramPair = params[i].split("=");
        if (paramPair[0] == "pos") {     // If any param starts "pos", get the content after "="
          posStr = paramPair[1];
          var splitPos = posStr.split(",");
          var termArray = [];
        // termArray will have the search terms
            for (i=0; i < splitPos.length; i += 2) {
            start = splitPos[i];
            len = splitPos[i+1]; // Needs error detection! Vulnerable if non-even # of pos entries
            term = bodyText.substr(start,len);
            if (termArray.includes(term) == false) {     // List all unique terms
                termArray.push(bodyText.substr(start,len)); 
            }
          } 
    //      console.log(termArray);
          var context = document.querySelector("div.contents");
          var instance = new Mark(context);
          for(i=0;i<termArray.length; i+=1) {
            instance.mark(termArray[i],options);  // Use Mark.js to mark all terms in termArray
            }    
          var firstMark = document.querySelector("mark");
          firstMark.scrollIntoView(true);
          //      console.log($("mark").first().text()); // Trying to scroll to first Mark element. 
        }
            }
    }
  });
</script>

<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />

<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<!-- Lunr search results -->
<div id="lunrResultBox" style="
        position: fixed;
        border: 1px solid black;
        background-color: WhiteSmoke;  
        padding: 10px;
        width: 500px;
        height: 500px;
        top: 30;
        right: 0;
        overflow: auto;
        display: none">
    <button onclick="closeLunrResults()" style="float: right;">X</button>
    <div class="resultCount" id="resultCount"></div>
    <div id="searchResults"></div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">USBX Porting Layer (rm_usbx_port)<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="anchor" id="functionss"></a></p><h2 class="groupheader">Functions</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> for the common API (r_usb_basic) to be called from the application.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-overview"></a>
Overview</h1>
<p>This USB driver works by combining USBX and r_usb_basic module. <br />
 </p>
<h1><a class="anchor" id="rm_usbx_pcdc-configuration"></a>
How to Configuration</h1>
<ul>
<li><p class="startli">Using a class other than HMSC and OTG. The following describes how to configure USBX using PCDC as an example.</p>
<p class="startli">1.Select [New Stack]-&gt;[Connectivity]-&gt;[Azure RTOS PCDC]</p>
<div class="image">
<img src="rm_usbx_pcdc1.png" alt="rm_usbx_pcdc1.png"/>
<div class="caption">
Select USB Device Class</div></div>
<p> 2.Select the USB pipe to use.</p>
<div class="image">
<img src="rm_usbx_pcdc3.png" alt="rm_usbx_pcdc3.png"/>
<div class="caption">
Select using USB Pipe</div></div>
</li>
<li><p class="startli">Using HMSC. Since HMSC is used in a different way from other USBX modules, the usage is described below. <br />
 1.Select [New Stack]-&gt;[Storage]-&gt;[Azure RTOS FileX on USBX]</p>
<div class="image">
<img src="rm_usbx_hmsc1.png" alt="rm_usbx_hmsc1.png"/>
<div class="caption">
Select USB Device Class</div></div>
<p> 2.The following is displayed when selecting Filex on USBX.</p>
<div class="image">
<object type="image/svg+xml" data="rm_usbx_hmsc2.svg">rm_usbx_hmsc2.svg</object>
<div class="caption">
FileX on USBX Stack</div></div>
</li>
<li><p class="startli">Using OTG. The following describes how to configure USBX using CDC as an example.</p>
<p class="startli">1.Select [New Stack]-&gt;[Connectivity]-&gt;[Azure RTOS USBX OTG CDC]</p>
<div class="image">
<img src="rm_usbx_otg_cdc.png" alt="rm_usbx_otg_cdc.png"/>
<div class="caption">
Select USB Device Class for OTG</div></div>
<p> 2.Select [New Stack]-&gt;[Input] -&gt; [External IRQ(r_icu)] (Be sure to select "r_icu" in OTG. The "r_icu" is used to detect the attaching of A cable.)</p>
<div class="image">
<img src="rm_usbx_otg_irq.png" alt="rm_usbx_otg_irq.png"/>
<div class="caption">
Select USB Device Class for OTG</div></div>
<p> 3.Be sure to set the following to each item in "r_icu". (1). Specify "7" to "Channel" item. (2). Specify "Both Edges" to "Trigger" item. (3). Specify "Enabled" to "Digital Filtering" item. (4). Specify "usb_otg_irq_callback" to "Callback" item.</p>
<div class="image">
<img src="rm_usbx_otg_stack.png" alt="rm_usbx_otg_stack.png"/>
<div class="caption">
Select USB Device Class for OTG</div></div>
<ol type="1">
<li>Set "Full Speed" to "USB Speed" item in r_usb_basic.</li>
<li>Set "USB_IP0 Port" to "USB Module Number" item in r_usb_basic.</li>
<li>Set "Not Supported" to "USBFS Resume Priority" item in r_usb_basic.</li>
</ol>
<div class="image">
<img src="rm_usbx_otg_usb_basic.png" alt="rm_usbx_otg_usb_basic.png"/>
<div class="caption">
Select USB Device Class</div></div>
<ol type="1">
<li><p class="startli">Set the following pins for USB (r_usb_basic).</p>
<p class="startli">(1). VBUSEN</p>
<p class="startli">(2). VBUS</p>
<p class="startli">(3). EXICEN</p>
</li>
<li>Set the following pins for IRQ (r_icu). (1). IRQ07</li>
</ol>
<div class="image">
<img src="rm_usbx_otg_irq_pin.png" alt="rm_usbx_otg_irq_pin.png"/>
<div class="caption">
IRQ Pin Setting</div></div>
</li>
</ul>
<h2>Note</h2>
<ul>
<li>The following are notes on using the ux_host_class_cdc_acm_read function or the ux_device_class_cdc_acm_read function.</li>
</ul>
<ol type="1">
<li>Please specify a multiple of MaxPacketSize to the 3rd argument(requested_length). since If the value of the 3rd argument is not multiple of MaxPacketSize, all data sent by USB Host or USB Peripheral may not be received correctly.</li>
<li>Please specify start address of thr area allocated a size larger than 3rd argument(requested_length) to the 2nd argument(data_pointer or buffer).</li>
</ol>
<ul>
<li>HMSC uses FileX. For more information on FileX, please refer to the following URL. <a href="https://docs.microsoft.com/en-us/azure/rtos/filex/">https://docs.microsoft.com/en-us/azure/rtos/filex/</a></li>
<li>OTG</li>
</ul>
<ol type="1">
<li>Be able to set UX_OTG_HOST_REQUEST_FLAG in USB Peripheral mode or call ux_host_stack_role_swap() function in USB Host mode when data other than control transfer is not being transferred.</li>
<li>Register the callback function for the application using <a class="el" href="group___u_s_b.html#ga66b9f21c7fc7cce60388edeaf7861d0e" title="Set callback function to be called when the OTG role swap was completed on Azure RTOS. ">R_USB_OtgCallbackSet()</a> function. This callback function is called when switching the operation mode(UX_OTG_MODE_IDLE/UX_OTG_MODE_SLAVE/UX_OTG_MODE_HOST).</li>
<li>Use <a class="el" href="group___u_s_b.html#ga1a52197abba908bdd990e9bca22d50a7" title="Start the SRP processing for OTG on Azure RTOS. ">R_USB_OtgSRP()</a> function when doing SRP(Session Request Protocol). The <a class="el" href="group___u_s_b.html#ga1a52197abba908bdd990e9bca22d50a7" title="Start the SRP processing for OTG on Azure RTOS. ">R_USB_OtgSRP()</a> function does not support VBUS pulsing.</li>
<li>After starting up MCU, USB is initialized as USB peripheral mode until connecting A cable.</li>
<li>When A cable is connected, USB module is initialized as USB Host mode.</li>
<li>Call <a class="el" href="group___i_c_u.html#ga036e85b235d213b257cae159b9eba0a3">R_ICU_ExternalIrqOpen()</a> and <a class="el" href="group___i_c_u.html#ga56b7181d7a70a5b8655659d760993ad1">R_ICU_ExternalIrqEnable()</a> function in the application program since the IRQ interrupt is used to detect attaching or detaching of A cable.</li>
<li>Add the OTG descriptor in the configuration descriptor in each descriptor file.</li>
</ol>
<table class="doxtable">
<tr>
<th align="left">Offset </th><th align="left">Field </th><th align="left">Size </th><th align="left">Value </th><th align="left">Description  </th></tr>
<tr>
<td align="left">0 </td><td align="left">bLength </td><td align="left">1 </td><td align="left">5 </td><td align="left">Size of Descriptor </td></tr>
<tr>
<td align="left">1 </td><td align="left">bDescriptor Type</td><td align="left">1 </td><td align="left">9 </td><td align="left">OTG type = 9 </td></tr>
<tr>
<td align="left">2 </td><td align="left">bmAttribute </td><td align="left">1 </td><td align="left">3 or 2 </td><td align="left">D1: HNP support<br />
D0: SRP support </td></tr>
<tr>
<td align="left">3 </td><td align="left">bcdOTG </td><td align="left">2 </td><td align="left">0x200 </td><td align="left">Binary Code Descimal </td></tr>
</table>
<ol type="1">
<li>Please ignore the suspend or resume event occurs when attaching or detaching the USB cable.</li>
</ol>
<h2><a class="anchor" id="rm_usbx_pcdc-limitations"></a>
Limitations</h2>
<p>1.Please call the initialization function in the application program. Please be sure to call <a class="el" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f" title="Applies power to the USB module specified in the argument (p_ctrl). ">R_USB_Open()</a> function after calling the following functions.</p>
<ul>
<li>Peripheral<ul>
<li>PCDC / PHID / PAUD / OTG<ul>
<li>ux_system_initialize</li>
<li>ux_device_stack_initialize</li>
<li>ux_device_stack_class_register</li>
</ul>
</li>
<li>PMSC<ul>
<li>ux_system_initialize</li>
<li>ux_device_stack_initialize</li>
</ul>
</li>
</ul>
</li>
<li>Host<ul>
<li>HCDC / HHID / OTG<ul>
<li>ux_system_initialize</li>
<li>ux_host_stack_initialize</li>
</ul>
</li>
<li>HMSC<ul>
<li>ux_system_initialize</li>
<li>ux_host_stack_initialize</li>
<li>fx_system_initialize</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>2.Set the value for 1000 Ticks per second in the "Timer Ticks Per Second" item. </p><div class="image">
<img src="timer_ticks.png" alt="timer_ticks.png"/>
<div class="caption">
Specify value of Timer Ticks Per Second</div></div>
<p> 3.Set the Thread priority to a value of 21. </p><div class="image">
<img src="thread_priority.png" alt="thread_priority.png"/>
<div class="caption">
Specify value of Thread priority</div></div>
<p> 4.When using the following functions, call the following functions in the following order after calling the R_USB_Close function. NOTE : Do not call R_USB_Close function in Peripheral Audio Class.</p>
<ul>
<li>Peripheral<ul>
<li>PCDC / PHID<ul>
<li>_ux_device_stack_class_unregister</li>
<li>_ux_device_stack_uninitialize</li>
</ul>
</li>
<li>PMSC<ul>
<li>_ux_device_stack_uninitialize</li>
</ul>
</li>
</ul>
</li>
<li>Host<ul>
<li>_ux_host_stack_uninitialize</li>
</ul>
</li>
</ul>
<p>5.The USBX HID class does not support OUT transfer.</p>
<p>6.When using USBX HHID, please use Wired device.</p>
<p>7.This module does not support the MCU(RA4M1 and RA2A1) since the RAM size is small.</p>
<p>8.The OTG for High-speed is not supported.</p>
<p>9.The OTG does not support the DMA transfer.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-descriptor"></a>
Descriptor</h1>
<p>Templates for USBX descriptors can be found in ra/fsp/src/rm_usbx_port folder. Also, please be sure to use your vendor ID.<br />
 Change the descriptor.c.template file for each class as follows if High-speed mode is used.</p>
<ul>
<li>rm_usbx_pcdc_descriptor.c.template<br />
<ol type="1">
<li>Comment on lines 108 and 243.</li>
<li>Delete the "//" on lines 109 and 242.</li>
</ol>
</li>
<li>rm_usbx_pmsc_descriptor.c.template<br />
<ol type="1">
<li>Comment on lines 78 and 153.</li>
<li>Delete the "//" on lines 79 and 152.</li>
</ol>
</li>
<li>rm_usbx_paud_descriptor.c.template<br />
<ol type="1">
<li>Comment on lines 167 and 485.</li>
<li>Delete the "//" on lines 168 and 486.</li>
</ol>
</li>
</ul>
<p>There are two types of templates for PHID descriptor.<br />
 Keyboard templates should be referred to rm_usbx_phid_descriptor_keyboard.c.template.<br />
 Mouse templates should be referred to rm_usbx_phid_descriptor_mouse.c.template.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-examples"></a>
Examples</h1>
<h2>USBX PCDC Example</h2>
<p>PCDC loopback example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #define VALUE_105    (105)</span></div><div class="line"><span class="preprocessor"> #define VALUE_2      (2)</span></div><div class="line"><span class="preprocessor"> #define VALUE_103    (103)</span></div><div class="line"><span class="preprocessor"> #define VALUE_93     (93)</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_cdc = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_cdc = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">            g_attach = USB_YES;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">            g_attach = USB_NO;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pcdc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_pcdc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    uint32_t  ret;</div><div class="line">    uint32_t  size;</div><div class="line"></div><div class="line">    _ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    _ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                                VALUE_103,</div><div class="line">                                g_device_framework_full_speed,</div><div class="line">                                VALUE_93,</div><div class="line">                                g_string_framework,</div><div class="line">                                VALUE_105,</div><div class="line">                                g_language_id_framework,</div><div class="line">                                VALUE_2,</div><div class="line">                                apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate   = ux_cdc_device0_instance_activate;</div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line">    _ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name, _ux_device_class_cdc_acm_entry, 1, 0x00,</div><div class="line">                                    (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_YES == g_attach)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">while</span> (g_cdc == UX_NULL)</div><div class="line">                {</div><div class="line">                    ;</div><div class="line">                }</div><div class="line"></div><div class="line">                ret = _ux_device_class_cdc_acm_read(g_cdc, g_buf, DATA_LEN, &amp;g_actual_length);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (UX_SUCCESS == ret)</div><div class="line">                {</div><div class="line">                    size = g_actual_length;</div><div class="line"></div><div class="line">                    _ux_device_class_cdc_acm_write(g_cdc, g_buf, size, &amp;g_actual_length);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_pcdc_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div></div><!-- fragment --> <h2>USBX HCDC Example</h2>
<p>The main functions of the HCDC loopback example are as follows:</p>
<ol type="1">
<li>Virtual UART control settings are configured by transmitting the class request SET_LINE_CODING to the CDC device.</li>
<li>Sends receive (Bulk In transfer) requests to a CDC peripheral device and receives data.</li>
<li>Loops received data back to the peripheral by means of Bulk Out transfers.</li>
</ol>
<p>The main loop performs loopback processing in which data received from a CDC peripheral device is transmitted unaltered back to the peripheral.</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #define VALUE_100    (100)</span></div><div class="line"></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, VOID * instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (_ux_utility_memory_compare(_ux_system_host_class_cdc_acm_name, host_class,</div><div class="line">                                   _ux_utility_string_length_get(_ux_system_host_class_cdc_acm_name)) ==</div><div class="line">        UX_SUCCESS)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (event == UX_FSP_DEVICE_INSERTION) <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">        {</div><div class="line">            p_cdc_acm = (UX_HOST_CLASS_CDC_ACM *) instance;</div><div class="line">            <span class="keywordflow">if</span> (p_cdc_acm-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass !=</div><div class="line">                UX_HOST_CLASS_CDC_DATA_CLASS)</div><div class="line">            {</div><div class="line">                <span class="comment">/* It seems the DATA class is on the second interface. Or we hope !  */</span></div><div class="line">                p_cdc_acm = p_cdc_acm-&gt;ux_host_class_cdc_acm_next_instance;</div><div class="line"></div><div class="line">                <span class="comment">/* Check again this interface, if this is not the data interface, we give up.  */</span></div><div class="line">                <span class="keywordflow">if</span> (p_cdc_acm-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass !=</div><div class="line">                    UX_HOST_CLASS_CDC_DATA_CLASS)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* We did not find a proper data interface. */</span></div><div class="line">                    p_cdc_acm = UX_NULL;</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (p_cdc_acm != UX_NULL)</div><div class="line">            {</div><div class="line">                tx_event_flags_set(&amp;g_cdcacm_activate_event_flags0, CDCACM_FLAG, TX_OR);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == UX_FSP_DEVICE_REMOVAL) <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">        {</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_activate_event_flags0, ~CDCACM_FLAG, TX_AND);</div><div class="line">            p_cdc_acm = UX_NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> buffer_clear (uint8_t * p)</div><div class="line">{</div><div class="line">    uint16_t counter;</div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        *p = 0U;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_hcdc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* CDCACM Host Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> usbx_hcdc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t status;</div><div class="line">    ULONG    actual_flags;</div><div class="line">    uint16_t counter = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        g_write_buf[counter] = (uint8_t) counter;</div><div class="line">    }</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        tx_event_flags_get(&amp;g_cdcacm_activate_event_flags0, CDCACM_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">        <span class="keywordflow">if</span> (p_cdc_acm != UX_NULL)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (0 == g_is_communicate)</div><div class="line">            {</div><div class="line">                tx_thread_sleep(VALUE_100);</div><div class="line">                g_is_communicate = 1;</div><div class="line">            }</div><div class="line"></div><div class="line">            status = ux_host_class_cdc_acm_write(p_cdc_acm, g_write_buf, DATA_LEN, &amp;g_write_actual_length);</div><div class="line">            <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_write_actual_length))</div><div class="line">            {</div><div class="line">                g_read_actual_length = 0;</div><div class="line">                buffer_clear(g_read_buf);</div><div class="line">                status = ux_host_class_cdc_acm_read(p_cdc_acm, g_read_buf, DATA_LEN, &amp;g_read_actual_length);</div><div class="line">                <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_read_actual_length))</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">if</span> ((uint8_t) counter != g_read_buf[counter])</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">while</span> (1)</div><div class="line">                            {</div><div class="line">                                ;</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PMSC Example</h2>
<p>PMSC storage example is as follows.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#structrm__block__media__cfg__t">rm_block_media_cfg_t</a> g_rm_block_media0_cfg =</div><div class="line">{.<a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#a05aeac48f8dd9b31bdb6d1ca5ddf8600">p_extend</a> = NULL, .p_callback = NULL, .p_context = NULL, };</div><div class="line"></div><div class="line"><a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#structrm__block__media__instance__t">rm_block_media_instance_t</a> g_rm_block_media0 =</div><div class="line">{.<a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#a842bb35277df2dfbe5c79d7b146ae230">p_api</a> = &amp;g_rm_block_media_on_user_media, .p_ctrl = NULL, .p_cfg = &amp;g_rm_block_media0_cfg, };</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pmsc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_pmsc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    UINT      ret;</div><div class="line">    ULONG     size;</div><div class="line"></div><div class="line">    _ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    _ux_device_stack_initialize(</div><div class="line">        g_device_framework_hi_speed,</div><div class="line">        60,</div><div class="line">        g_device_framework_full_speed,</div><div class="line">        50,</div><div class="line">        g_string_framework,</div><div class="line">        93,</div><div class="line">        g_language_id_framework,</div><div class="line">        2,</div><div class="line">        UX_NULL</div><div class="line">        );</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HMSC Example</h2>
<p>HMSC storage example is as follows. See usbx_hmsc_sample for the basic operation of HMSC. Also, please refer to usbx_hmsc_sample_format for the format of the USB memory.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define     UX_STORAGE_BUFFER_SIZE    (64 * 1024)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define     EVENT_USB_PLUG_IN         (1UL &lt;&lt; 0)</span></div><div class="line"><span class="preprocessor">#define     EVENT_USB_PLUG_OUT        (1UL &lt;&lt; 1)</span></div><div class="line"><span class="preprocessor">#define     MEMPOOL_SIZE              (63488)</span></div><div class="line"><span class="preprocessor">#define     DATA_LEN                  (2048)</span></div><div class="line"><span class="preprocessor">#define     VALUE_32                  (32)</span></div><div class="line"><span class="preprocessor">#define     VALUE_100                 (100)</span></div><div class="line"><span class="preprocessor">#define     VALUE_200                 (200)</span></div><div class="line"><span class="preprocessor">#define     VALUE_256                 (256)</span></div><div class="line"><span class="preprocessor">#define     VALUE_1024                (1024)</span></div><div class="line"><span class="preprocessor">#define     DEVICE_INSERTION          (0x01U)</span></div><div class="line"><span class="preprocessor">#define     DEVICE_REMOVAL            (0x02U)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> uint16_t g_read_buf[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> uint16_t g_write_buf[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> FX_FILE  g_file;</div><div class="line"></div><div class="line"><span class="keyword">static</span> UCHAR      g_fx_media0_media_memory[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> uint8_t    g_ux_pool_memory[MEMPOOL_SIZE];</div><div class="line"><span class="keyword">static</span> FX_MEDIA * g_p_media = UX_NULL;</div><div class="line"></div><div class="line">TX_EVENT_FLAGS_GROUP g_usb_plug_events;</div><div class="line"></div><div class="line">UINT usb_host_plug_event_notification(ULONG usb_event, UX_HOST_CLASS * host_class, VOID * instance);</div><div class="line">UINT ux_system_host_storage_fx_media_get(UX_HOST_CLASS_STORAGE        * instance,</div><div class="line">                                         UX_HOST_CLASS_STORAGE_MEDIA ** p_storage_media,</div><div class="line">                                         FX_MEDIA                    ** p_fx_media);</div><div class="line"></div><div class="line"><span class="keyword">static</span> UINT apl_change_function (ULONG event, UX_HOST_CLASS * host_class, VOID * instance)</div><div class="line">{</div><div class="line">    UINT                          status = UX_SUCCESS;</div><div class="line">    UX_HOST_CLASS               * <span class="keyword">class</span>;</div><div class="line">    UX_HOST_CLASS_STORAGE       * storage;</div><div class="line">    UX_HOST_CLASS_STORAGE_MEDIA * storage_media;</div><div class="line">    (void) instance;</div><div class="line"></div><div class="line">    <span class="comment">/* Check the class container if it is for a USBX Host Mass Storage class. */</span></div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS ==</div><div class="line">        _ux_utility_memory_compare(_ux_system_host_class_storage_name,</div><div class="line">                                   host_class,</div><div class="line">                                   _ux_utility_string_length_get(_ux_system_host_class_storage_name)))</div><div class="line">    {</div><div class="line">        <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">        <span class="keywordflow">if</span> (DEVICE_INSERTION == event)</div><div class="line">        {</div><div class="line">            status = ux_host_stack_class_get(_ux_system_host_class_storage_name, &amp;<span class="keyword">class</span>);</div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> status;</div><div class="line">            }</div><div class="line"></div><div class="line">            status = ux_host_stack_class_instance_get(<span class="keyword">class</span>, 0, (<span class="keywordtype">void</span> **) &amp;storage);</div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> status;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_HOST_CLASS_INSTANCE_LIVE != storage-&gt;ux_host_class_storage_state)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> UX_ERROR;</div><div class="line">            }</div><div class="line"></div><div class="line">            storage_media = <span class="keyword">class</span>-&gt;ux_host_class_media;</div><div class="line">            g_p_media     = &amp;storage_media-&gt;ux_host_class_storage_media;</div><div class="line"></div><div class="line">            tx_event_flags_set(&amp;g_usb_plug_events, EVENT_USB_PLUG_IN, TX_OR);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DEVICE_REMOVAL == event) <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">        {</div><div class="line">            g_p_media = UX_NULL;</div><div class="line">            tx_event_flags_set(&amp;g_usb_plug_events, EVENT_USB_PLUG_OUT, TX_OR);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_hmsc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_hmsc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG      actual_length = 0;</div><div class="line">    ULONG      actual_flags;</div><div class="line">    UINT       tx_return;</div><div class="line">    UINT       fx_return;</div><div class="line">    uint16_t   data_count = 0;</div><div class="line">    FX_MEDIA * p_media    = UX_NULL;</div><div class="line">    CHAR       volume[VALUE_32];</div><div class="line"></div><div class="line">    fx_system_initialize();</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(apl_change_function);</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_usb_plug_events, (CHAR *) <span class="stringliteral">&quot;USB Plug Event Flags&quot;</span>);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">// Wait until device inserted.</span></div><div class="line">        tx_return = tx_event_flags_get(&amp;g_usb_plug_events,</div><div class="line">                                       EVENT_USB_PLUG_IN,</div><div class="line">                                       TX_OR_CLEAR,</div><div class="line">                                       &amp;actual_flags,</div><div class="line">                                       TX_WAIT_FOREVER);</div><div class="line">        <span class="keywordflow">if</span> (TX_SUCCESS != tx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Get the pointer to FileX Media Control Block for a USB flash device</span></div><div class="line">        p_media = g_p_media;</div><div class="line"></div><div class="line">        <span class="comment">// Retrieve the volume name of the opened media from the Data sector</span></div><div class="line">        fx_return = fx_media_volume_get(p_media, volume, FX_DIRECTORY_SECTOR);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">        {</div><div class="line">            <span class="comment">// Set the default directory in the opened media, arbitrary name called &quot;firstdir&quot;</span></div><div class="line">            fx_directory_default_set(p_media, <span class="stringliteral">&quot;firstdir&quot;</span>);</div><div class="line"></div><div class="line">            <span class="comment">// Suspend this thread for 200 time-ticks</span></div><div class="line">            tx_thread_sleep(VALUE_100);</div><div class="line"></div><div class="line">            <span class="comment">// Try to open the file, &#39;counter.txt&#39;.</span></div><div class="line">            fx_return = fx_file_open(p_media, &amp;g_file, <span class="stringliteral">&quot;counter.txt&quot;</span>, (FX_OPEN_FOR_READ | FX_OPEN_FOR_WRITE));</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">            {</div><div class="line">                <span class="comment">// The &#39;counter.txt&#39; file is not found, so create a new file</span></div><div class="line">                fx_return = fx_file_create(p_media, <span class="stringliteral">&quot;counter.txt&quot;</span>);</div><div class="line">                <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// Open that file</span></div><div class="line">                fx_return = fx_file_open(p_media, &amp;g_file, <span class="stringliteral">&quot;counter.txt&quot;</span>, (FX_OPEN_FOR_READ | FX_OPEN_FOR_WRITE));</div><div class="line">                <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Already open a file, then read the file in blocks</span></div><div class="line">            <span class="comment">// Set a specified byte offset for reading</span></div><div class="line">            fx_return = fx_file_seek(&amp;g_file, 0);</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">            {</div><div class="line">                fx_return = fx_file_read(&amp;g_file, g_read_buf, DATA_LEN, &amp;actual_length);</div><div class="line">                <span class="keywordflow">if</span> ((FX_SUCCESS == fx_return) || (FX_END_OF_FILE == fx_return))</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">if</span> (data_count == VALUE_1024)</div><div class="line">                    {</div><div class="line">                        <span class="comment">// empty file</span></div><div class="line">                        data_count = 0;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">for</span> (uint16_t data_max_count = data_count; data_count &lt; (data_max_count + VALUE_256); data_count++)</div><div class="line">                    {</div><div class="line">                        g_write_buf[data_count] = data_count;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="comment">// Set the specified byte offset for writing</span></div><div class="line">                    fx_return = fx_file_seek(&amp;g_file, 0);</div><div class="line">                    <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">                    {</div><div class="line">                        <span class="comment">// Write the file in blocks</span></div><div class="line">                        fx_return = fx_file_write(&amp;g_file, g_write_buf, DATA_LEN);</div><div class="line">                        <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">                        {</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                        {</div><div class="line">                            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Close already opened file</span></div><div class="line">            fx_return = fx_file_close(&amp;g_file);</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">            {</div><div class="line">                tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">            }</div><div class="line"></div><div class="line">            tx_thread_sleep(VALUE_200);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* flush the media */</span></div><div class="line">        fx_return = fx_media_flush(p_media);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* close the media */</span></div><div class="line">        fx_return = fx_media_close(p_media);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Wait for unplugging the USB</span></div><div class="line">        tx_event_flags_get(&amp;g_usb_plug_events, EVENT_USB_PLUG_OUT, TX_OR_CLEAR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    }                                  <span class="comment">// while(1)</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_hmsc_sample_format (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG      actual_flags;</div><div class="line">    UINT       tx_return;</div><div class="line">    UINT       status  = UX_SUCCESS;</div><div class="line">    FX_MEDIA * p_media = UX_NULL;</div><div class="line"></div><div class="line">    fx_system_initialize();</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(apl_change_function);</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_usb_plug_events, (CHAR *) <span class="stringliteral">&quot;USB Plug Event Flags&quot;</span>);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="comment">// Wait until device inserted.</span></div><div class="line">    tx_return = tx_event_flags_get(&amp;g_usb_plug_events,</div><div class="line">                                   EVENT_USB_PLUG_IN,</div><div class="line">                                   TX_OR_CLEAR,</div><div class="line">                                   &amp;actual_flags,</div><div class="line">                                   TX_WAIT_FOREVER);</div><div class="line">    <span class="keywordflow">if</span> (TX_SUCCESS != tx_return)</div><div class="line">    {</div><div class="line">        tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Get the pointer to FileX Media Control Block for a USB flash device</span></div><div class="line">    p_media = g_p_media;</div><div class="line"></div><div class="line">    memset(g_fx_media0_media_memory, 0x00, <span class="keyword">sizeof</span>(g_fx_media0_media_memory));</div><div class="line"></div><div class="line">    status = fx_media_format(p_media,                                  <span class="comment">// Pointer to FileX media control block.</span></div><div class="line">                             p_media-&gt;fx_media_driver_entry,           <span class="comment">// Driver entry</span></div><div class="line">                             p_media-&gt;fx_media_driver_info,            <span class="comment">// Pointer to Block Media Driver</span></div><div class="line">                             g_fx_media0_media_memory,                 <span class="comment">// Media buffer pointer</span></div><div class="line">                             p_media-&gt;fx_media_memory_size,            <span class="comment">// Media buffer size</span></div><div class="line">                             <span class="stringliteral">&quot;sample&quot;</span>,                                 <span class="comment">// Volume Name</span></div><div class="line">                             p_media-&gt;fx_media_number_of_FATs,         <span class="comment">// Number of FATs</span></div><div class="line">                             p_media-&gt;fx_media_root_directory_entries, <span class="comment">// Directory Entries</span></div><div class="line">                             p_media-&gt;fx_media_hidden_sectors,         <span class="comment">// Hidden sectors</span></div><div class="line">                             (ULONG) p_media-&gt;fx_media_total_sectors,  <span class="comment">// Total sectors</span></div><div class="line">                             p_media-&gt;fx_media_bytes_per_sector,       <span class="comment">// Sector size</span></div><div class="line">                             p_media-&gt;fx_media_sectors_per_cluster,    <span class="comment">// Sectors per cluster</span></div><div class="line">                             p_media-&gt;fx_media_heads,                  <span class="comment">// Heads (disk media)</span></div><div class="line">                             p_media-&gt;fx_media_sectors_per_track);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((uint8_t) FX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        __BKPT(0);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PHID Example</h2>
<p>PHID keyboard example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_phid_keyboard_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_phid_keyboard_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UX_SLAVE_CLASS_HID_EVENT hid_event;</div><div class="line">    UCHAR     key;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line"></div><div class="line">    _ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    _ux_device_stack_initialize(NULL,</div><div class="line">                                0,</div><div class="line">                                g_device_framework_full_speed,</div><div class="line">                                VALUE_52,</div><div class="line">                                g_string_framework,</div><div class="line">                                VALUE_53,</div><div class="line">                                g_language_id_framework,</div><div class="line">                                VALUE_2,</div><div class="line">                                apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_hid_parameter.ux_slave_class_hid_instance_activate         = ux_hid_instance_activate;</div><div class="line">    g_ux_device_class_hid_parameter.ux_slave_class_hid_instance_deactivate       = ux_hid_instance_deactivate;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_address = g_apl_report;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_length  = REPORT_DESCRIPTOR_LENGTH;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_callback       = apl_hid_set_report_cb;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_id      = 0;</div><div class="line"></div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_hid_name,</div><div class="line">                                   _ux_device_class_hid_entry,</div><div class="line">                                   1,</div><div class="line">                                   0x00,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_hid_parameter);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the first key to &#39;a&#39; which is 04.  */</span></div><div class="line">    key = 0x04;</div><div class="line"></div><div class="line">    <span class="comment">/* reset the HID event structure.  */</span></div><div class="line">    ux_utility_memory_set(&amp;hid_event, 0, <span class="keyword">sizeof</span>(UX_SLAVE_CLASS_HID_EVENT));</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_NO == g_suspend)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">while</span> (UX_NULL == g_hid)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Then wait.  */</span></div><div class="line">                    tx_thread_sleep(10);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">/* 5sec wait */</span></div><div class="line">                usb_cpu_delay_xms((uint16_t) VALUE_5000);</div><div class="line"></div><div class="line">                <span class="comment">/* Then insert a key into the keyboard event.  Length is fixed to 8.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_length = 8;</div><div class="line"></div><div class="line">                <span class="comment">/* First byte is a modifier byte.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[0] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* Second byte is reserved. */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[1] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* The 6 next bytes are keys. We only have one key here.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[2] = key;</div><div class="line"></div><div class="line">                <span class="comment">/* Set the keyboard event.  */</span></div><div class="line">                ux_device_class_hid_event_set(g_hid, &amp;hid_event);</div><div class="line"></div><div class="line">                <span class="comment">/* Next event has the key depressed.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[2] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* Length is fixed to 8.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_length = 8;</div><div class="line"></div><div class="line">                <span class="comment">/* Set the keyboard event.  */</span></div><div class="line">                ux_device_class_hid_event_set(g_hid, &amp;hid_event);</div><div class="line"></div><div class="line">                <span class="comment">/* Are we at the end of alphabet ?  */</span></div><div class="line">                <span class="keywordflow">if</span> (key != (0x04 + 26))</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Next key.  */</span></div><div class="line">                    key++;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="comment">/* Start over again.  */</span></div><div class="line">                    key = 0x04;</div><div class="line">                }</div><div class="line"></div><div class="line">                apl_status_change_cb(UX_DEVICE_SUSPENDED);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (USB_NO == g_remote_wakeup)</div><div class="line">                {</div><div class="line">                    tx_thread_sleep(VALUE_10000);</div><div class="line"></div><div class="line">                    <span class="comment">/* Remote wakeup processing */</span></div><div class="line">                    g_remote_wakeup = USB_YES;</div><div class="line"></div><div class="line">                    ux_device_stack_host_wakeup();</div><div class="line"></div><div class="line">                    apl_status_change_cb(UX_DEVICE_RESUMED);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HHID Example</h2>
<p>HHID user interface example is as follows.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> keyboard_update_task (ULONG thread_input)</div><div class="line">{</div><div class="line">    ULONG usbx_return_value;</div><div class="line"></div><div class="line">    <span class="comment">/* keyboard button masks, set by ux_host_class_hid_keyboard_buttons_get call */</span></div><div class="line">    ULONG keyboard_key = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* keyboard state masks, set by ux_host_class_hid_keyboard_buttons_get call */</span></div><div class="line">    ULONG keyboard_state = 0;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        usbx_return_value = ux_host_class_hid_keyboard_key_get(</div><div class="line">            (UX_HOST_CLASS_HID_KEYBOARD *) hid_keyboard_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">            &amp;keyboard_key,</div><div class="line">            &amp;keyboard_state);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((usbx_return_value == UX_SUCCESS) || (usbx_return_value == UX_NO_KEY_PRESS))</div><div class="line">        {</div><div class="line">            hid_devices_info.device_connected = KEYBOARD_DEVICE;</div><div class="line">            hid_devices_info.key              = keyboard_key;</div><div class="line">            hid_devices_info.keyboard_status  = keyboard_state;</div><div class="line"></div><div class="line">            <span class="comment">/* Clear the states for next read */</span></div><div class="line">            keyboard_key   = 0;</div><div class="line">            keyboard_state = 0;</div><div class="line"></div><div class="line">            <span class="comment">/* copy the keyboard states to queue */</span></div><div class="line">            tx_queue_send(&amp;device_parameters, &amp;hid_devices_info, TX_NO_WAIT);</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(10);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mouse_update_task (ULONG thread_input)</div><div class="line">{</div><div class="line">    <span class="comment">/* mouse button masks, set by ux_host_class_hid_mouse_buttons_get call */</span></div><div class="line">    ULONG mouse_buttons;</div><div class="line"></div><div class="line">    <span class="comment">/* X co-ordinate displacement of mouse */</span></div><div class="line">    SLONG mouse_x_position = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Y co-ordinate displacement of mouse */</span></div><div class="line">    SLONG mouse_y_position = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* variable to hold USBX return values */</span></div><div class="line">    ULONG usbx_return_value;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        usbx_return_value = ux_host_class_hid_mouse_buttons_get(</div><div class="line">            (UX_HOST_CLASS_HID_MOUSE *) hid_mouse_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">            &amp;mouse_buttons);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (usbx_return_value == UX_SUCCESS)</div><div class="line">        {</div><div class="line">            usbx_return_value = ux_host_class_hid_mouse_position_get(</div><div class="line">                (UX_HOST_CLASS_HID_MOUSE *) hid_mouse_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">                &amp;mouse_x_position,</div><div class="line">                &amp;mouse_y_position);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (usbx_return_value == UX_SUCCESS)</div><div class="line">        {</div><div class="line">            hid_devices_info.device_connected  = MOUSE_DEVICE;</div><div class="line">            hid_devices_info.key               = mouse_buttons;</div><div class="line">            hid_devices_info.mouse_direction_X = mouse_x_position;</div><div class="line">            hid_devices_info.mouse_direction_Y = mouse_y_position;</div><div class="line">            tx_queue_send(&amp;device_parameters, &amp;hid_devices_info, TX_NO_WAIT);</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(10);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_hhid_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t i;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(ux_system_host_hid_change_function);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    tx_thread_create(&amp;keyboard_update,</div><div class="line">                     (CHAR *) <span class="stringliteral">&quot;keyboard_update_task&quot;</span>,</div><div class="line">                     keyboard_update_task,</div><div class="line">                     (ULONG) NULL,</div><div class="line">                     &amp;keyboard_update_stack,</div><div class="line">                     2048,</div><div class="line">                     22,</div><div class="line">                     2,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line"></div><div class="line">    tx_thread_create(&amp;mouse_update,</div><div class="line">                     (CHAR *) <span class="stringliteral">&quot;mouse_update_task&quot;</span>,</div><div class="line">                     mouse_update_task,</div><div class="line">                     (ULONG) NULL,</div><div class="line">                     &amp;mouse_update_stack,</div><div class="line">                     1024,</div><div class="line">                     22,</div><div class="line">                     2,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; UX_HOST_CLASS_HID_MAX_CLIENTS; i++)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Check whether the instance registered? through USB HID device insertion callback? */</span></div><div class="line">            <span class="keywordflow">if</span> (NULL != hid_class_keyboard_instance[i])</div><div class="line">            {</div><div class="line">                UX_HOST_CLASS_HID_CLIENT * hid_client = hid_class_keyboard_instance[i]-&gt;ux_host_class_hid_client;</div><div class="line">                hid_keyboard_client = hid_client;</div><div class="line">                tx_thread_sleep(10);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* Check whether the instance registered? through USB HID device insertion callback? */</span></div><div class="line">            <span class="keywordflow">if</span> (NULL != hid_class_mouse_instance[i])</div><div class="line">            {</div><div class="line">                UX_HOST_CLASS_HID_CLIENT * hid_client = hid_class_mouse_instance[i]-&gt;ux_host_class_hid_client;</div><div class="line">                hid_mouse_client = hid_client;</div><div class="line">                tx_thread_sleep(10);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* If multiple similar type devices are connected, allow them one by one share data with application */</span></div><div class="line">            tx_thread_sleep(10);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PAUD Example</h2>
<p>PAUD example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define VALUE_275                  (275)</span></div><div class="line"><span class="preprocessor">#define VALUE_226                  (226)</span></div><div class="line"><span class="preprocessor">#define VALUE_93                   (93)</span></div><div class="line"><span class="preprocessor">#define VALUE_2                    (2)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define STACK_SIZE                 (1024U)</span></div><div class="line"><span class="preprocessor">#define NUM_OF_FRAME               (8U)</span></div><div class="line"><span class="preprocessor">#define USB_MAX_PACKET_SIZE_IN     (200U)</span></div><div class="line"><span class="preprocessor">#define USB_MAX_PACKET_SZIE_OUT    (192U)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define USB_APL_ON                 (1U)</span></div><div class="line"><span class="preprocessor">#define USB_APL_OFF                (0U)</span></div><div class="line"></div><div class="line"><span class="comment">/*** Please enable the following macro when supporting High-speed. ***/</span></div><div class="line"></div><div class="line"><span class="comment">// #define APL_AUDIO_20</span></div><div class="line"></div><div class="line"><span class="comment">/*********************************************************************/</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t g_read_buf[NUM_OF_FRAME][USB_MAX_PACKET_SZIE_OUT];</div><div class="line"><span class="keyword">static</span> uint8_t g_write_buf[USB_MAX_PACKET_SIZE_IN];</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO * <span class="keyword">volatile</span> g_p_audio = UX_NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint8_t g_read_wp = 0U;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint32_t g_read_alternate_setting  = USB_APL_OFF;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint32_t g_write_alternate_setting = USB_APL_OFF;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint8_t  g_apl_usb_status          = USB_APL_DETACH;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_GROUP g_audio20_control_group;</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO20_CONTROL       g_audio20_control[2];</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_GROUP g_audio_control_group;</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO10_CONTROL       g_audio_control[2];</div><div class="line"><span class="preprocessor">#endif  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_DEFAULT;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_CONFIGURED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_CONFIGURED;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_DETACH;</div><div class="line"></div><div class="line">            g_read_wp                 = 0U;</div><div class="line">            g_read_alternate_setting  = USB_APL_OFF;</div><div class="line">            g_write_alternate_setting = USB_APL_OFF;</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_SUSPENDED:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_APL_CONFIGURED == g_apl_usb_status)</div><div class="line">            {</div><div class="line">                g_apl_usb_status = USB_APL_SUSPEND;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_RESUMED:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_APL_SUSPEND == g_apl_usb_status)</div><div class="line">            {</div><div class="line">                g_apl_usb_status = USB_APL_CONFIGURED;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * p_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_instance_activate (<span class="keywordtype">void</span> * p_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_audio = (UX_DEVICE_CLASS_AUDIO *) p_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * p_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_instance_deactivate (<span class="keywordtype">void</span> * p_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(p_instance);</div><div class="line"></div><div class="line">    g_p_audio = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio20_request_process</span></div><div class="line"><span class="comment"> * Description     : Audio20 Control Request Processing</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO * : Pointer to Audio instance</span></div><div class="line"><span class="comment"> *                 : UX_SLAVE_TRANSFER * : Pointer to UX_SLAVE_TRANSFER structure</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_audio20_request_process (UX_DEVICE_CLASS_AUDIO * p_audio, UX_SLAVE_TRANSFER * p_transfer)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    uint8_t i;</div><div class="line">    uint8_t number;</div><div class="line"></div><div class="line">    ux_err = ux_device_class_audio20_control_process(p_audio, p_transfer, &amp;g_audio20_control_group);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Request handled, check changes */</span></div><div class="line">        number = (uint8_t) g_audio20_control_group.ux_device_class_audio20_control_group_controls_nb;</div><div class="line"></div><div class="line">        for (i = 0; i &lt; number; i++)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (g_audio20_control[i].ux_device_class_audio20_control_changed)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_MUTE_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_mute[i] = g_audio20_control[i].ux_device_class_audio20_control_mute[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_VOLUME_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_volume[i] = g_audio20_control[i].ux_device_class_audio20_control_volume[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio20_request_process</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio10_request_process</span></div><div class="line"><span class="comment"> * Description     : Audio10 Control Request Processing</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO * : Pointer to Audio instance</span></div><div class="line"><span class="comment"> *                 : UX_SLAVE_TRANSFER * : Pointer to UX_SLAVE_TRANSFER structure</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_audio10_request_process (UX_DEVICE_CLASS_AUDIO * p_audio, UX_SLAVE_TRANSFER * p_transfer)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    uint8_t i;</div><div class="line">    uint8_t number;</div><div class="line"></div><div class="line">    ux_err = ux_device_class_audio10_control_process(p_audio, p_transfer, &amp;g_audio_control_group);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Request handled, check changes */</span></div><div class="line">        number = (uint8_t) g_audio_control_group.ux_device_class_audio10_control_group_controls_nb;</div><div class="line"></div><div class="line">        for (i = 0; i &lt; number; i++)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (g_audio_control[i].ux_device_class_audio10_control_changed)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_MUTE_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_mute[i] = g_audio_control[i].ux_device_class_audio10_control_mute[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_VOLUME_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_volume[i] = g_audio_control[i].ux_device_class_audio10_control_volume[0];;</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio10_request_process</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_change</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switching alternate setting value of OUT transfer</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Alternate Setting Value</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_read_change (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG alternate_setting)</div><div class="line">{</div><div class="line">    UINT ux_err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == alternate_setting)</div><div class="line">    {</div><div class="line">        ux_device_class_audio_reception_start(p_stream);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (USB_APL_ON == g_read_alternate_setting)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Alternate Setting 1 --&gt; 0 */</span></div><div class="line">            g_read_wp = 0U;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    g_read_alternate_setting = alternate_setting;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_change</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_done</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing of OUT transfer reception</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Actual Length</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_read_done (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG actual_length)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    UCHAR * p_buffer;</div><div class="line">    ULONG   length;</div><div class="line">    UINT    i;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(actual_length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == g_read_alternate_setting)</div><div class="line">    {</div><div class="line">        ux_err = ux_device_class_audio_read_frame_get(p_stream, &amp;p_buffer, &amp;length);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; length; i++)</div><div class="line">            {</div><div class="line">                g_read_buf[g_read_wp][i] = *(p_buffer + i);</div><div class="line">            }</div><div class="line"></div><div class="line">            g_read_wp++;</div><div class="line">            g_read_wp %= NUM_OF_FRAME;</div><div class="line">            ux_device_class_audio_read_frame_free(p_stream);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_done</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_write_change</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switching alternate setting value of IN transfer</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Alternate Setting Value</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_write_change (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG alternate_setting)</div><div class="line">{</div><div class="line">    UINT ux_err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == alternate_setting)</div><div class="line">    {</div><div class="line">        ux_err = ux_device_class_audio_frame_write(p_stream, g_write_buf, USB_MAX_PACKET_SIZE_IN);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">        {</div><div class="line">            ux_device_class_audio_transmission_start(p_stream);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    g_write_alternate_setting = alternate_setting;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_write_change</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_write_done</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing of IN transfer transmission</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Actual Length</span></div><div class="line"><span class="comment"> * Return value    : None</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_write_done (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG actual_length)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(actual_length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == g_write_alternate_setting)</div><div class="line">    {</div><div class="line">        ux_device_class_audio_frame_write(p_stream, g_write_buf, USB_MAX_PACKET_SIZE_IN);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_write_done</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_paudio_apl_init</span></div><div class="line"><span class="comment"> * Description     : Initialization processing</span></div><div class="line"><span class="comment"> * Arguments       : None</span></div><div class="line"><span class="comment"> * Return value    : None</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_paudio_apl_init (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    UINT      ux_err;</div><div class="line">    uint16_t  i = 0;</div><div class="line">    UX_DEVICE_CLASS_AUDIO_STREAM_PARAMETER audio_stream_parameter[2];</div><div class="line">    UX_DEVICE_CLASS_AUDIO_PARAMETER        audio_parameter;</div><div class="line"></div><div class="line">    _ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    _ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                                VALUE_275,</div><div class="line">                                g_device_framework_full_speed,</div><div class="line">                                VALUE_226,</div><div class="line">                                g_string_framework,</div><div class="line">                                VALUE_93,</div><div class="line">                                g_language_id_framework,</div><div class="line">                                VALUE_2,</div><div class="line">                                apl_status_change_cb);</div><div class="line"></div><div class="line">    <span class="comment">/* Read Initialization */</span></div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_change =</div><div class="line">        apl_audio_read_change;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_frame_done =</div><div class="line">        apl_audio_read_done;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_thread_stack_size     = STACK_SIZE;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_max_frame_buffer_nb   = NUM_OF_FRAME;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_max_frame_buffer_size = USB_MAX_PACKET_SZIE_OUT;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_thread_entry          =</div><div class="line">        ux_device_class_audio_read_thread_entry;</div><div class="line"></div><div class="line">    <span class="comment">/* Write Initialization */</span></div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_change =</div><div class="line">        apl_audio_write_change;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_frame_done =</div><div class="line">        apl_audio_write_done;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_thread_stack_size     = STACK_SIZE;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_max_frame_buffer_nb   = NUM_OF_FRAME;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_max_frame_buffer_size = USB_MAX_PACKET_SIZE_IN;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_thread_entry          =</div><div class="line">        ux_device_class_audio_write_thread_entry;</div><div class="line"></div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_slave_class_audio_instance_activate =</div><div class="line">        apl_audio_instance_activate;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_slave_class_audio_instance_deactivate =</div><div class="line">        apl_audio_instance_deactivate;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_device_class_audio_control_process</div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line">        = apl_audio20_request_process;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        = apl_audio10_request_process;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    audio_parameter.ux_device_class_audio_parameter_streams_nb = 2;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_streams    = &amp;audio_stream_parameter[0];</div><div class="line"></div><div class="line">    ux_err =</div><div class="line">        ux_device_stack_class_register(_ux_system_slave_class_audio_name,</div><div class="line">                                       _ux_device_class_audio_entry,</div><div class="line">                                       1,</div><div class="line">                                       0x00,</div><div class="line">                                       (<span class="keywordtype">void</span> *) &amp;audio_parameter);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != ux_err)</div><div class="line">    {</div><div class="line">        USB_APL_AUDIO_ERROR();</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_cs_id              = 0x10;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_sampling_frequency = 48000;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_fu_id              = 5;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_mute[0]            = 0;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume_min[0]      = 0;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume_max[0]      = 100;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume[0]          = 50;</div><div class="line"></div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_cs_id              = 0x10;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_sampling_frequency = 48000;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_fu_id              = 8;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_mute[0]            = 0;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume_min[0]      = 0;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume_max[0]      = 200;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume[0]          = 100;</div><div class="line"></div><div class="line">    g_audio20_control_group.ux_device_class_audio20_control_group_controls_nb = 2;</div><div class="line">    g_audio20_control_group.ux_device_class_audio20_control_group_controls    = &amp;g_audio20_control[0];</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_fu_id         = 5;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_mute[0]       = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume[0]     = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_min[0] = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_max[0] = 0x80;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_res[0] = 0x40;</div><div class="line"></div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_fu_id                = 8;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_mute[0]              = 0x10;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume[0]            = 0x00;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_min[0]        = 0;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_max[0]        = 0xF0;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_res[0]        = 0x80;</div><div class="line">    g_audio_control_group.ux_device_class_audio10_control_group_controls_nb = 2;</div><div class="line">    g_audio_control_group.ux_device_class_audio10_control_group_controls    = &amp;g_audio_control[0];</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; USB_MAX_PACKET_SIZE_IN; i++)</div><div class="line">    {</div><div class="line">        g_write_buf[i] = (UCHAR) (i &amp; 0xFF);</div><div class="line">    }</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        USB_APL_AUDIO_ERROR();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_paudio_apl_init</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_paudio_apl</span></div><div class="line"><span class="comment"> * Description     : Application task for USB Audio</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_paud_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    usbx_paudio_apl_init();</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">switch</span> (g_apl_usb_status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">case</span> USB_APL_CONFIGURED:</div><div class="line">            {</div><div class="line">                <span class="comment">/* Application Processing */</span></div><div class="line"></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> USB_APL_DETACH:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> USB_APL_SUSPEND:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><p> OTG example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define VALUE_108    (108)</span></div><div class="line"><span class="preprocessor">#define VALUE_105    (105)</span></div><div class="line"><span class="preprocessor">#define VALUE_98     (98)</span></div><div class="line"><span class="preprocessor">#define VALUE_2      (2)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_apl_status_peri = 0;</div><div class="line"></div><div class="line"><span class="keyword">volatile</span> uint8_t      g_apl_state          = UX_DEVICE_REMOVED;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_apl_usb_mode       = UX_OTG_MODE_IDLE;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_change_device_mode = UX_OTG_MODE_IDLE;</div><div class="line"></div><div class="line"><span class="keyword">static</span> UX_HOST_CLASS_CDC_ACM           * g_p_cdc_acm_host = UX_NULL;</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM * <span class="keyword">volatile</span> g_p_cdc_peri     = UX_NULL;</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="comment">// Debug OTG-A Detach</span></div><div class="line">    <span class="keywordflow">if</span> ((UX_DEVICE_REMOVED == g_apl_status_peri) &amp;&amp; (UX_DEVICE_RESUMED == status))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_apl_status_peri = status;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_cdc_peri = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_p_cdc_peri = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* USB OTG Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_device_swich_complete_cb</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switcning Host or Peri</span></div><div class="line"><span class="comment"> * Arguments       : UX_OTG_MODE_SLAVE/UX_OTG_MODE_HOST/UX_OTG_MODE_IDLE</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> apl_device_swich_complete_cb (ULONG mode)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (UX_OTG_MODE_SLAVE == mode)</div><div class="line">    {</div><div class="line">        _ux_system_otg-&gt;ux_system_otg_slave_role_swap_flag = 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_change_device_mode = mode;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_host_apl</span></div><div class="line"><span class="comment"> * Description     : OTG sample program</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> apl_otg_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t   is_host_request_flag = USB_NO;</div><div class="line">    uint8_t   is_host_apl_complete = USB_NO;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line"></div><div class="line">    _ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    <span class="comment">// B device initialization</span></div><div class="line">    _ux_device_stack_initialize(UX_NULL,</div><div class="line">                                UX_NULL,</div><div class="line">                                g_device_framework_full_speed,</div><div class="line">                                VALUE_98,</div><div class="line">                                g_string_framework,</div><div class="line">                                VALUE_105,</div><div class="line">                                g_language_id_framework,</div><div class="line">                                VALUE_2,</div><div class="line">                                apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate   = ux_cdc_device0_instance_activate;</div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line">    _ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name, _ux_device_class_cdc_acm_entry, 1, 0x00,</div><div class="line">                                    (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    <span class="comment">// A device initialization</span></div><div class="line">    ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line"></div><div class="line">    <a class="code" href="group___u_s_b.html#ga66b9f21c7fc7cce60388edeaf7861d0e">R_USB_OtgCallbackSet</a>(&amp;g_basic0_ctrl, apl_device_swich_complete_cb);</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined(APL_USB_OTG_A_DEVICE)</span></div><div class="line">    err = <a class="code" href="group___i_c_u.html#ga036e85b235d213b257cae159b9eba0a3">R_ICU_ExternalIrqOpen</a>(&amp;g_external_irq0_ctrl, &amp;g_external_irq0_cfg);</div><div class="line">    assert(FSP_SUCCESS == err);</div><div class="line">    err = <a class="code" href="group___i_c_u.html#ga56b7181d7a70a5b8655659d760993ad1">R_ICU_ExternalIrqEnable</a>(&amp;g_external_irq0_ctrl);</div><div class="line">    assert(FSP_SUCCESS == err);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#ad92d0a1d797e8e806082b4fb6cf65f03">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined(APL_USB_OTG_A_DEVICE)</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (g_change_device_mode == UX_OTG_MODE_HOST)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(APL_USB_OTG_A_DEVICE) */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (g_change_device_mode != g_apl_usb_mode)</div><div class="line">        {</div><div class="line">            g_apl_usb_mode = g_change_device_mode;</div><div class="line"></div><div class="line">            <span class="keywordflow">switch</span> (g_apl_usb_mode)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_OTG_MODE_HOST:</div><div class="line">                {</div><div class="line">                    is_host_request_flag = USB_NO;</div><div class="line"></div><div class="line">                    <span class="keywordflow">if</span> (USB_NO == is_host_apl_complete)</div><div class="line">                    {</div><div class="line">                        otg_host_apl();</div><div class="line">                        is_host_apl_complete = USB_YES;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_OTG_MODE_SLAVE:</div><div class="line">                {</div><div class="line">                    is_host_apl_complete = USB_NO;</div><div class="line">                    <span class="keywordflow">if</span> (USB_NO == is_host_request_flag)</div><div class="line">                    {</div><div class="line">                        err = otg_peri_apl();</div><div class="line">                        <span class="keywordflow">if</span> (0 == err)</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">if</span> (UX_OTG_FEATURE_A_HNP_SUPPORT ==</div><div class="line">                                (_ux_system_otg-&gt;ux_system_otg_slave_set_feature_flag &amp; UX_OTG_FEATURE_A_HNP_SUPPORT))</div><div class="line">                            {</div><div class="line">                                _ux_system_otg-&gt;ux_system_otg_slave_role_swap_flag = UX_OTG_HOST_REQUEST_FLAG;</div><div class="line">                                is_host_request_flag = USB_YES;</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="comment">/* UX_MODE_IDLE */</span></div><div class="line">                    is_host_request_flag = USB_NO;</div><div class="line">                    is_host_apl_complete = USB_NO;</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_otg_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* USB Host Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_host_usr_event_notification</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing USB event</span></div><div class="line"><span class="comment"> * Arguments       : ULONG event               : Completed USB Event</span></div><div class="line"><span class="comment"> *                 : UX_HOST_CLASS *host_class : Pointer to UX_HOST_CLASS structure</span></div><div class="line"><span class="comment"> *                 : VOID * instance           : Pointer to HCDC instance</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, VOID * instance)</div><div class="line">{</div><div class="line">    (void) host_class;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (event == UX_DEVICE_INSERTION)  <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">    {</div><div class="line">        g_p_cdc_host = (UX_HOST_CLASS_CDC_ACM *) instance;</div><div class="line">        <span class="keywordflow">if</span> (g_p_cdc_host-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass !=</div><div class="line">            UX_HOST_CLASS_CDC_DATA_CLASS)</div><div class="line">        {</div><div class="line">            <span class="comment">/* It seems the DATA class is on the second interface. Or we hope !  */</span></div><div class="line">            g_p_cdc_host = g_p_cdc_host-&gt;ux_host_class_cdc_acm_next_instance;</div><div class="line"></div><div class="line">            <span class="comment">/* Check again this interface, if this is not the data interface, we give up.  */</span></div><div class="line">            <span class="keywordflow">if</span> (g_p_cdc_host-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass !=</div><div class="line">                UX_HOST_CLASS_CDC_DATA_CLASS)</div><div class="line">            {</div><div class="line">                <span class="comment">/* We did not find a proper data interface. */</span></div><div class="line">                g_p_cdc_host = UX_NULL;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (g_p_cdc_host != UX_NULL)</div><div class="line">        {</div><div class="line">            g_host_apl_event = UX_DEVICE_INSERTION;</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_wait_abort(&amp;new_thread0);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((event == UX_DEVICE_REMOVAL) || (event == UX_DEVICE_DISCONNECTION)) <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">    {</div><div class="line">        g_host_apl_event = UX_DEVICE_REMOVAL;</div><div class="line">        g_p_cdc_host     = UX_NULL;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_host_usr_event_notification</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_host_apl</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> otg_host_apl (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG status;</div><div class="line">    m</div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        g_write_buf_host[counter] = (uint8_t) counter;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_host_apl_event = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_INSERTION == g_host_apl_event)</div><div class="line">        {</div><div class="line">            g_host_apl_event = 0;</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (countor = 0; countor &lt; 5000; countor++)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (0 == g_is_communicate)</div><div class="line">                {</div><div class="line">                    tx_thread_sleep(100);</div><div class="line">                    g_is_communicate = 1;</div><div class="line">                }</div><div class="line"></div><div class="line">                g_write_actual_length = 0;</div><div class="line">                status                = ux_host_class_cdc_acm_write(g_p_cdc_host,</div><div class="line">                                                                    g_write_buf_host,</div><div class="line">                                                                    DATA_LEN,</div><div class="line">                                                                    &amp;g_write_actual_length_host);</div><div class="line">                <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_write_actual_length_host))</div><div class="line">                {</div><div class="line">                    g_read_actual_length_host = 0;</div><div class="line">                    buffer_clear(g_host_read_buf);</div><div class="line">                    status = ux_host_class_cdc_acm_read(g_p_cdc_host,</div><div class="line">                                                        g_read_buf_host,</div><div class="line">                                                        DATA_LEN,</div><div class="line">                                                        &amp;g_read_actual_length_host);</div><div class="line">                    <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_read_actual_length_host))</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">if</span> ((uint8_t) counter != g_read_buf_host[counter])</div><div class="line">                            {</div><div class="line">                                <span class="keywordflow">while</span> (1)</div><div class="line">                                {</div><div class="line">                                    ;</div><div class="line">                                }</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVAL == g_host_apl_event)</div><div class="line">        {</div><div class="line">            g_host_apl_event = 0;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function otg_host_apl</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* USB Peripheral Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_cdc_peri = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_p_cdc_peri = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_peri_apl</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">uint8_t otg_peri_apl (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UINT     ret;</div><div class="line">    ULONG    size;</div><div class="line">    uint16_t counter = 0;</div><div class="line"></div><div class="line">    g_apl_status_peri = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; 5000; )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_CONFIGURED == g_apl_status_peri)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">while</span> (g_p_cdc_peri == UX_NULL)</div><div class="line">            {</div><div class="line">                ;</div><div class="line">            }</div><div class="line"></div><div class="line">            ret = _ux_device_class_cdc_acm_read(g_p_cdc_peri, g_buf_peri, DATA_LEN, &amp;g_actual_length_peri);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS == ret)</div><div class="line">            {</div><div class="line">                size = g_actual_length_peri;</div><div class="line">                ux_device_class_cdc_acm_write(g_p_cdc_peri, g_buf_peri, size, &amp;g_actual_length_peri);</div><div class="line">                counter++;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVED == g_apl_status_peri)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (0 != counter)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (5000 == counter)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> APL_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> APL_ERROR;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function otg_peri_apl</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v3.6.0 User's Manual Copyright  (2022) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
