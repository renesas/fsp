<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: Azure RTOS USBX Port (rm_usbx_port)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/javascript" src="search/lunr.js"></script>
    <link href="search/lunrsearch.css" rel="stylesheet" type="text/css">
    <script src="search/lunr_index.js"></script>
    <script src="search/lunrclient.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
    $(document).ready(function() {
        $("tr.tree_lvl_1").nextUntil("tr.tree_lvl_1,tr.tree_none").hide();
		$("tr.tree_lvl_1").data("expanded","0");
		$("tr.tree_lvl_2").data("expanded","0");
		$("tr.tree_lvl_3").data("expanded","0");
		$("tr.tree_lvl_4").data("expanded","0");
		$("tr.tree_lvl_5").data("expanded","0");
        $("tr.tree_lvl_1").click(function() {
		    var lvl_1_is_open = $(this).data("expanded");
		    if (lvl_1_is_open == "0") {
                $(this).nextUntil("tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_2, tr.tree_lvl_1_item").show();
                $(this).find("span").removeClass("chevron-collapsed").addClass("chevron-expanded");
				$(this).data("expanded","1");
			} else {
			    $(this).nextUntil("tr.tree_lvl_1,tr.tree_none").hide();
                $(this).nextUntil("tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_2,tr.tree_lvl_3,tr.tree_lvl_4,tr.tree_lvl_5").find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).nextUntil("tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_2,tr.tree_lvl_3,tr.tree_lvl_4,tr.tree_lvl_5").data("expanded","0");
				$(this).find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).data("expanded","0");
			    }
        });
		$("tr.tree_lvl_2").click(function() {
		    var lvl_2_is_open = $(this).data("expanded");
		    if (lvl_2_is_open == "0") {
                $(this).nextUntil("tr.tree_lvl_2,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_3, tr.tree_lvl_2_item").show();
                $(this).find("span").removeClass("chevron-collapsed").addClass("chevron-expanded");
				$(this).data("expanded","1");
			} else {
			    $(this).nextUntil("tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none").hide();
				$(this).nextUntil("tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_3,tr.tree_lvl_4,tr.tree_lvl_5").find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).nextUntil("tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_3,tr.tree_lvl_4,tr.tree_lvl_5").data("expanded","0");
				$(this).find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).data("expanded","0");
			    }
        });
		$("tr.tree_lvl_3").click(function() {
		    var lvl_3_is_open = $(this).data("expanded");
		    if (lvl_3_is_open == "0") {
                $(this).nextUntil("tr.tree_lvl_3,tr.tree_lvl_2,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_4, tr.tree_lvl_3_item").show();
                $(this).find("span").removeClass("chevron-collapsed").addClass("chevron-expanded");
				$(this).data("expanded","1");
			} else {
			    $(this).nextUntil("tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none").hide();
                $(this).nextUntil("tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_4, tr.tree_lvl_5").find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).nextUntil("tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_4, tr.tree_lvl_5").data("expanded","0");
				$(this).find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).data("expanded","0");
			    }
        });
		$("tr.tree_lvl_4").click(function() {
		    var lvl_4_is_open = $(this).data("expanded");
		    if (lvl_4_is_open == "0") {
                $(this).nextUntil("tr.tree_lvl_4,tr.tree_lvl_3,tr.tree_lvl_2,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_5, tr.tree_lvl_4_item").show();
                $(this).find("span").removeClass("chevron-collapsed").addClass("chevron-expanded");
				$(this).data("expanded","1");
			} else {
			    $(this).nextUntil("tr.tree_lvl_4,tr.tree_lvl_3_item,tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none").hide();
                $(this).nextUntil("tr.tree_lvl_4,tr.tree_lvl_3_item,tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_5").find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).nextUntil("tr.tree_lvl_4,tr.tree_lvl_3_item,tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_5").data("expanded","0");
				$(this).find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).data("expanded","0");
			    }
        });
		$("tr.tree_lvl_5").click(function() {
		    var lvl_5_is_open = $(this).data("expanded");
		    if (lvl_5_is_open == "0") {
                $(this).nextUntil("tr.tree_lvl_5,tr.tree_lvl_4,tr.tree_lvl_3,tr.tree_lvl_2,tr.tree_lvl_1,tr.tree_none", "tr.tree_lvl_5_item").show();
                $(this).find("span").removeClass("chevron-collapsed").addClass("chevron-expanded");
				$(this).data("expanded","1");
			} else {
			    $(this).nextUntil("tr.tree_lvl_5,tr.tree_lvl_4_item,tr.tree_lvl_4,tr.tree_lvl_3_item,tr.tree_lvl_3,tr.tree_lvl_2_item,tr.tree_lvl_2,tr.tree_lvl_1_item,tr.tree_lvl_1,tr.tree_none").hide();
				$(this).find("span").removeClass("chevron-expanded").addClass("chevron-collapsed");
				$(this).data("expanded","0");
			    }
        });
     });
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v6.2.0</span>
   </div>
  </td>
   <td>        <br /><div id="MSearchBox" class="MSearchBoxInactive">

    <form id="lunrSearchForm" name="lunrSearchForm">
      <span class="left" >
          <img id="MSearchSelect" src="search/mag_sel.png"
               alt=""/>
         <input class="search-input" id="MSearchField" name="q" placeholder="Search" type="text">
      </span>
      <span class="right">
          &nbsp;
      </span>
        <!--<input type="submit" value="Search">-->
    </form>
</div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___u_s_b_x.html','');});
</script>

<script src="search/mark.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    var options = {         // allows highlighting across element boundaries.
      "acrossElements": true
    };
    var bodyText = $("div.contents").text(); // try contents instead of body.
    // If using body: Problem may be that text inside <script> tags is included in .text() - but not in cheerio?
    // If using div.contents - works
    var fullURL = $(location).attr('href');
    var splitURL = fullURL.split("?");  // Get param string: content after "?" in URL
    if (splitURL.length > 1) {          // If any content after "?"
      var paramStr = splitURL[1];
      var params = paramStr.split("&"); // Split params on "&"
      for (i = 0; i < params.length; i++) {
        var paramPair = params[i].split("=");
        if (paramPair[0] == "pos") {     // If any param starts "pos", get the content after "="
          posStr = paramPair[1];
          var splitPos = posStr.split(",");
          var termArray = [];
        // termArray will have the search terms
            for (i=0; i < splitPos.length; i += 2) {
            start = splitPos[i];
            len = splitPos[i+1]; // Needs error detection! Vulnerable if non-even # of pos entries
            term = bodyText.substr(start,len);
            if (termArray.includes(term) == false) {     // List all unique terms
                termArray.push(bodyText.substr(start,len));
            }
          }
    //      console.log(termArray);
          var context = document.querySelector("div.contents");
          var instance = new Mark(context);
          for(i=0;i<termArray.length; i+=1) {
            instance.mark(termArray[i],options);  // Use Mark.js to mark all terms in termArray
            }
          var firstMark = document.querySelector("mark");
          firstMark.scrollIntoView(true);
          //      console.log($("mark").first().text()); // Trying to scroll to first Mark element.
        }
            }
    }
  });
</script>

<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />

<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<!-- Lunr search results -->
<div id="lunrResultBox" style="
        position: fixed;
        border: 1px solid black;
        background-color: WhiteSmoke;
        padding: 10px;
        width: 500px;
        height: 500px;
        top: 30;
        right: 0;
        overflow: auto;
        display: none">
    <button onclick="closeLunrResults()" style="float: right;">X</button>
    <div class="resultCount" id="resultCount"></div>
    <div id="searchResults"></div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Azure RTOS USBX Port (rm_usbx_port)<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a> &raquo; <a class="el" href="group___r_e_n_e_s_a_s___c_o_n_n_e_c_t_i_v_i_t_y___m_o_d_u_l_e_s.html">Connectivity</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="anchor" id="functionss"></a></p><h2 class="groupheader">Functions</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">USB (r_usb_basic)</a> for the common API (r_usb_basic) to be called from the application.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-overview"></a>
Overview</h1>
<p>This USB driver works by combining USBX and r_usb_basic module.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-configuration"></a>
How to Configuration</h1>
<h2>Using a class other than Composite(Pereipheral), HMSC and OTG.</h2>
<p>The following describes how to configure USBX using PCDC as an example.</p>
<ul>
<li>Select [New Stack]-&gt;[Connectivity]-&gt;[Azure RTOS PCDC]</li>
</ul>
<div class="image">
<img src="rm_usbx_pcdc1.png" alt="rm_usbx_pcdc1.png"/>
<div class="caption">
Select USB Device Class</div></div>
 <h2>Using Composite (Peripheral)</h2>
<ul>
<li>Select [New Stack]-&gt;[Connectivity]-&gt;[USB Composite]</li>
</ul>
<div class="image">
<img src="rm_usbx_composite1.png" alt="rm_usbx_composite1.png"/>
<div class="caption">
Select USB Composite</div></div>
<ul>
<li>The following is displayed when selecting [USB Composite].</li>
</ul>
<div class="image">
<img src="rm_usbx_composite2.png" alt="rm_usbx_composite2.png"/>
<div class="caption">
USB Composite Stack</div></div>
<ul>
<li>Select the supported 2 device classes as follows.</li>
</ul>
<div class="image">
<img src="rm_usbx_composite3.png" alt="rm_usbx_composite3.png"/>
<div class="caption">
Select Device Classes</div></div>
<ul>
<li>Delete the "g_basic1" instance manually.</li>
</ul>
<div class="image">
<img src="rm_usbx_composite4.png" alt="rm_usbx_composite4.png"/>
<div class="caption">
Delete USB Basic instance</div></div>
<h2>Using HMSC.</h2>
<p>Since HMSC is used in a different way from other USBX modules, the usage is described below.</p>
<ul>
<li>Select [New Stack]-&gt;[Storage]-&gt;[Azure RTOS FileX on USBX]</li>
</ul>
<div class="image">
<img src="rm_usbx_hmsc1.png" alt="rm_usbx_hmsc1.png"/>
<div class="caption">
Select USB Device Class</div></div>
<ul>
<li>The following is displayed when selecting Filex on USBX.</li>
</ul>
<div class="image">
<object type="image/svg+xml" data="rm_usbx_hmsc2.svg">rm_usbx_hmsc2.svg</object>
<div class="caption">
FileX on USBX Stack</div></div>
 <h2>Using OTG.</h2>
<p>The following describes how to configure USBX OTG.</p>
<ul>
<li>When using CDC / HID class<ul>
<li>[New Stack]-&gt;[Connectivity]-&gt;[Azure RTOS USBX OTG CDC] or [Azure RTOS USBX OTG HID])</li>
</ul>
</li>
<li>When using MSC class<ul>
<li>[New Stack]-&gt;[Storage]-&gt;[Azure RTOS FileX on USBX])</li>
<li>[New]-&gt;[Azure RTOS USBX OTG MSC]</li>
</ul>
</li>
<li><p class="startli">Select [New Stack]-&gt;[Input] -&gt; [External IRQ(r_icu)]</p>
<p class="startli">Be sure to select "r_icu" in OTG. The "r_icu" is used to detect the attaching of A cable.</p>
</li>
</ul>
<div class="image">
<img src="rm_usbx_otg_irq.png" alt="rm_usbx_otg_irq.png"/>
<div class="caption">
Select USB Device Class for OTG</div></div>
<ul>
<li>Be sure to set the following to each item in "r_icu".<ul>
<li>Set "7" to "Channel" item.</li>
<li>Set "Both Edges" to "Trigger" item.</li>
<li>Set "Enabled" to "Digital Filtering" item.</li>
<li>Set "usb_otg_irq_callback" to "Callback" item.</li>
</ul>
</li>
</ul>
<div class="image">
<img src="rm_usbx_otg_stack.png" alt="rm_usbx_otg_stack.png"/>
<div class="caption">
Select USB Device Class for OTG</div></div>
<ul>
<li>Be sure to set the following to each item in "r_usb_basic".<ul>
<li>Set "Full Speed" to "USB Speed" item.</li>
<li>Set "USB_IP0 Port" to "USB Module Number".</li>
<li>Set "Not Supported" to "USBFS Resume Priority".</li>
</ul>
</li>
</ul>
<div class="image">
<img src="rm_usbx_otg_usb_basic.png" alt="rm_usbx_otg_usb_basic.png"/>
<div class="caption">
Select USB Device Class</div></div>
<ul>
<li>Set the following pins for USB (r_usb_basic)<ul>
<li>VBUSEN</li>
<li>VBUS</li>
<li>EXICEN</li>
</ul>
</li>
</ul>
<div class="image">
<img src="rm_usbx_otg_pin.png" alt="rm_usbx_otg_pin.png"/>
<div class="caption">
USB Pin Setting</div></div>
<ul>
<li>Set the following pins for IRQ (r_icu)<ul>
<li>IRQ07</li>
</ul>
</li>
</ul>
<div class="image">
<img src="rm_usbx_otg_irq_pin.png" alt="rm_usbx_otg_irq_pin.png"/>
<div class="caption">
IRQ Pin Setting</div></div>
 <h2>Using Hub</h2>
<ul>
<li>When the user uses the following device class, the user can use USB Hub.<ul>
<li>Host Communication Device Class (HCDC)</li>
<li>Host Human Interface Device Class (HHID)</li>
<li>Host Mass Storage Class (HMSC)</li>
<li>Host Printer Class (HPRN)</li>
</ul>
</li>
<li>Also be sure to set Enable using HUB.</li>
</ul>
<div class="image">
<img src="rm_usbx_hprn_hub.png" alt="rm_usbx_hprn_hub.png"/>
<div class="caption">
Enable Using Hub PRN-PRN</div></div>
 <h3>Note</h3>
<ul>
<li>Please ignore the suspend or resume event occurs when attaching or detaching the USB cable.</li>
<li>The following are notes on using the ux_host_class_cdc_acm_read function or the ux_device_class_cdc_acm_read function<ul>
<li>Please specify a multiple of MaxPacketSize to the 3rd argument(requested_length) since if the value of the 3rd argument is not multiple of MaxPacketSize, all data sent by USB Host or USB Peripheral may not be received correctly.</li>
<li>Please specify start address of the area allocated a size larger than 3rd argument(requested_length) to the 2nd argument(data_pointer or buffer).</li>
</ul>
</li>
<li>There is no stack for the Hub; please select the stack for USB Host even when using the Hub.</li>
<li>Depending on the Hub used, it may be necessary to supply power to the Hub.</li>
<li>HUVC does not support USB Hub.</li>
</ul>
<h2>HMSC uses FileX.</h2>
<p>For more information on FileX, please refer to the following URL.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/rtos/filex/">https://docs.microsoft.com/en-us/azure/rtos/filex/</a></p>
<h2>OTG</h2>
<ul>
<li>Be able to set UX_OTG_HOST_REQUEST_FLAG in USB Peripheral mode or call ux_host_stack_role_swap() function in USB Host mode when data other than control transfer is not being transferred.</li>
<li>Register the callback function for the application using <a class="el" href="group___u_s_b.html#ga66b9f21c7fc7cce60388edeaf7861d0e" title="Set callback function to be called when the OTG role swap was completed on Azure RTOS. ">R_USB_OtgCallbackSet()</a> function. This callback function is called when switching the operation mode(UX_OTG_MODE_IDLE/UX_OTG_MODE_SLAVE/UX_OTG_MODE_HOST).</li>
<li>Use <a class="el" href="group___u_s_b.html#ga1a52197abba908bdd990e9bca22d50a7" title="Start the SRP processing for OTG on Azure RTOS. ">R_USB_OtgSRP()</a> function when doing SRP(Session Request Protocol). The <a class="el" href="group___u_s_b.html#ga1a52197abba908bdd990e9bca22d50a7" title="Start the SRP processing for OTG on Azure RTOS. ">R_USB_OtgSRP()</a> function does not support VBUS pulsing.</li>
<li>After starting up MCU, USB is initialized as USB peripheral mode until connecting A cable.</li>
<li>Please ignore the suspend or resume event occurs when attaching or detaching the USB cable.</li>
<li>When A cable is connected, USB module is initialized as USB Host mode.</li>
<li>Call <a class="el" href="group___i_c_u.html#ga036e85b235d213b257cae159b9eba0a3">R_ICU_ExternalIrqOpen()</a> and <a class="el" href="group___i_c_u.html#ga56b7181d7a70a5b8655659d760993ad1">R_ICU_ExternalIrqEnable()</a> function in the application program since the IRQ interrupt is used to detect attaching or detaching of A cable.</li>
<li>Add the OTG descriptor in the configuration descriptor in each descriptor file.</li>
</ul>
<table class="doxtable">
<tr>
<th align="left">Offset </th><th align="left">Field </th><th align="left">Size </th><th align="left">Value </th><th align="left">Description  </th></tr>
<tr>
<td align="left">0 </td><td align="left">bLength </td><td align="left">1 </td><td align="left">5 </td><td align="left">Size of Descriptor </td></tr>
<tr>
<td align="left">1 </td><td align="left">bDescriptor Type</td><td align="left">1 </td><td align="left">9 </td><td align="left">OTG type = 9 </td></tr>
<tr>
<td align="left">2 </td><td align="left">bmAttribute </td><td align="left">1 </td><td align="left">3 or 2 </td><td align="left">D1: HNP support<br />
D0: SRP support </td></tr>
<tr>
<td align="left">3 </td><td align="left">bcdOTG </td><td align="left">2 </td><td align="left">0x200 </td><td align="left">Binary Code Descimal </td></tr>
</table>
<h2><a class="anchor" id="rm_usbx-known_issues"></a>
Known Issues</h2>
<ul>
<li>There is compatibility issue for FileX on USBX stack in FSP 5.0.0 while importing from FSP 4.6.0 or earlier. Please refer to "GitHub Issue" about this workaround.</li>
</ul>
<h2><a class="anchor" id="rm_usbx_pcdc-limitations"></a>
Limitations</h2>
<ul>
<li>This USB driver does not support the multiple device class in Host mode.</li>
<li><p class="startli">Please call the initialization function in the application program.</p>
<p class="startli">Please be sure to call <a class="el" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f" title="Applies power to the USB module specified in the argument (p_ctrl). ">R_USB_Open()</a> function after calling the following functions.</p><ul>
<li>Peripheral<ul>
<li>PCDC / PHID / PAUD / PPRN / DFU / OTG<ul>
<li>ux_system_initialize</li>
<li>ux_device_stack_initialize</li>
<li>ux_device_stack_class_register</li>
</ul>
</li>
<li>PMSC<ul>
<li>ux_system_initialize</li>
<li>ux_device_stack_initialize</li>
</ul>
</li>
</ul>
</li>
<li>Host<ul>
<li>HCDC / HHID / HPRN / HUVC / HAUD / OTG<ul>
<li>ux_system_initialize</li>
<li>ux_host_stack_initialize</li>
</ul>
</li>
<li>HMSC<ul>
<li>ux_system_initialize</li>
<li>ux_host_stack_initialize</li>
<li>fx_system_initialize</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Set the value for 1000 Ticks per second in the "Timer Ticks Per Second" item.</li>
</ul>
<div class="image">
<img src="timer_ticks.png" alt="timer_ticks.png"/>
<div class="caption">
Specify value of Timer Ticks Per Second</div></div>
<ul>
<li>Set the Thread priority to a value of 21.</li>
</ul>
<div class="image">
<img src="thread_priority.png" alt="thread_priority.png"/>
<div class="caption">
Specify value of Thread priority</div></div>
<ul>
<li>Call the following functions in the following order after calling the <a class="el" href="group___u_s_b.html#ga42c6c75ae96e3860b726d1b0dcbf110d" title="Terminates power to the USB module specified in argument (p_ctrl). USB0 module stops when USB_IP0 is ...">R_USB_Close()</a> function.<ul>
<li>Peripheral<ul>
<li>PCDC / PHID / PPRN<ul>
<li>ux_device_stack_class_unregister</li>
<li>ux_device_stack_uninitialize</li>
</ul>
</li>
<li>PMSC<ul>
<li>ux_device_stack_uninitialize</li>
</ul>
</li>
</ul>
</li>
<li>Host<ul>
<li>ux_host_stack_uninitialize</li>
</ul>
</li>
</ul>
</li>
<li>USBX Composite (Peripheral) supports the following composite device.<ul>
<li>PCDC + PMSC</li>
</ul>
</li>
<li>USBX Composite (PCDC + PMSC) has the following notes.<ul>
<li>When the user select "Safely Remove Hardware and Eject Media" on Windows and eject the mass storage (PMSC), the Windows Explorer for PMSC does not disappear. But PMSC driver works properly.</li>
<li>PMSC may not work properly when USBX Composite Device(PCDC+PMSC) is connected to linux machine (USB Host).If the user encounter this issue, please update Linux OS.</li>
</ul>
</li>
<li>The FAT file format that HMSC supports is FAT32, FAT16 and FAT12.</li>
<li>When using USBX HMSC, please be sure to check the "fx" checkbox(red frame) of the pack the user is using in the "Components" tab(green frame) as shown below.</li>
</ul>
<div class="image">
<img src="rm_usbx_hmsc_filex.png" alt="rm_usbx_hmsc_filex.png"/>
<div class="caption">
Check the fx checkbox</div></div>
<ul>
<li>When using USBX HPRN, if the internal buffer of the printer is full, USB data transfer speed drops significantly.</li>
<li>When using USBX HHID, please use Wired device.</li>
<li>USBX HUVC driver does not support Full-speed.</li>
<li>USBX HUVC driver does not support the following APIs.<ul>
<li>ux_host_class_video_transfer_buffers_add</li>
<li>ux_host_class_video_read</li>
</ul>
</li>
<li>Note the following when using <em>ux_host_class_video_transfer_buffer_add</em> function (USBX HUVC API)<ul>
<li>Please call <em>ux_host_class_video_transfer_buffer_add</em> function after cofirming that the callback function for data reception completion is called when calling this API again. This callback function is registered by <em>ux_host_class_video_transfer_callback_set</em> function in the application program.</li>
<li>Please specify a 4-byte alignment address for the 2nd argument (<em>buffer</em>) of <em>ux_host_class_video_transfer_buffer_add</em> function when using DMA transfer.</li>
</ul>
</li>
<li>Note the following when using <em>ux_host_class_video_start</em> function (USBX HUVC API)<ul>
<li>Please be sure to confirm return value of the <em>ux_host_class_video_max_payload_get</em> function is less than or equal to 1024. If the return value is greater than 1024, start video streaming by referring to the following. <pre class="fragment">channel.ux_host_class_video_parameter_channel_bandwidth_selection = 1024;
status = ux_host_class_video_ioctl(video, UX_HOST_CLASS_VIDEO_IOCTL_CHANNEL_START, &amp;channel);
</pre></li>
</ul>
</li>
<li><p class="startli">The USBHS module does not support the high-bandwidth isochronous transfer (image below), the maximum packet size for isochronous transfer is 1024 bytes and supports only one transaction per microframe.</p>
<div class="image">
<img src="rm_usbx_uvc_isochronous.png" alt="rm_usbx_uvc_isochronous.png"/>
<div class="caption">
High Bandwidth Isochronous Transfer</div></div>
</li>
<li>This module does not support the MCU(RA4M1 and RA2A1) since the RAM size is small.</li>
<li>Please specify the correct framework size to the 2nd argument(device_framework_length_high_speed) and the 4th argument(device_framework_length_full_speed) in "ux_device_stack_initialize" function. If incorrect size is specified, USB driver does not work properly.</li>
<li>The following is the limitation when using OTG.<ul>
<li>The user can not use High-speed module(USB_IP1).</li>
<li>The DMA transfer is not supported.</li>
<li>The MSC is not supported.</li>
<li>The user can not use USB Hub.</li>
</ul>
</li>
<li>The followings are the limitation when using USB Hub.<ul>
<li>The USB driver allocates USB PIPE9 for USB Hub.</li>
<li>The user can not connect the Hub device under the Hub down port.</li>
<li>For HCDC, the user can not connect more than 2 CDC devices to USB Hub.</li>
<li>For HPRN, the user can not connect more than 2 PRN devices to USB Hub.</li>
<li>For HHID, the user can not connect more than 3 HID devices to USB Hub.</li>
<li>For HMSC, the user can not connect more than 3 MSC devices to USB Hub.</li>
</ul>
</li>
<li><p class="startli">Please use USB Host DFU tool described in the chapter "USB Device DFU Class" in the following page.</p>
<p class="startli"><a href="https://learn.microsoft.com/en-us/azure/rtos/usbx/usbx-device-stack-supplemental-2">https://learn.microsoft.com/en-us/azure/rtos/usbx/usbx-device-stack-supplemental-2</a></p>
</li>
<li>USBX DFU can upgrade the firmware only once after resetting MCU.</li>
<li>USBX DFU does not support the upload feature.</li>
<li><p class="startli">ux_device_class_cdc_acm_read() API, throughput/speed may be similar in following cases.</p><ul>
<li>Read operation in double buffer mode when compared to single buffer mode.</li>
<li>Read operation in continuous transfer mode when compared to non-continuous transfer mode.</li>
</ul>
<p class="startli">Because of the USBX CDC device stack limits the read transfer size buffer to single packet (ie. wMaxPacketSize as per Full-speed or High-speed USB port). Please refer Azure RTOS USBX documentation for more information.</p>
</li>
<li>ux_host_class_cdc_acm_write() and ux_host_class_cdc_acm_read() API, throughput/speed on high-speed port may be similar for CPU read and write operation in double buffer mode when compared to single buffer mode because of the FSP driver limits the maximum transfer request length size to 512 bytes (UX_FSP_MAX_BULK_PAYLOAD).</li>
<li>ux_host_class_cdc_acm_write() and ux_host_class_cdc_acm_read() API, throughput/speed may be less for DMA read and write operation when compared to CPU mode because of the FSP driver limits the maximum transfer request length size to 512 bytes(UX_FSP_MAX_BULK_PAYLOAD).</li>
<li>ux_host_class_cdc_acm_write() and ux_host_class_cdc_acm_read() API, throughput/speed may be less for DMA read and write operation compared to USB FreeRTOS HCDC DMA because of the FSP driver limits the maximum transfer request length size to 512 bytes (UX_FSP_MAX_BULK_PAYLOAD).</li>
</ul>
<h1><a class="anchor" id="rm_usbx_pcdc-descriptor"></a>
Descriptor</h1>
<p>Templates for USBX descriptors can be found in ra/fsp/src/rm_usbx_port folder. Also, please be sure to use your vendor ID.<br />
 Change the descriptor.c.template file for each class as follows if High-speed mode is used.</p>
<ul>
<li>rm_usbx_pcdc_descriptor.c.template<br />
<ul>
<li>Comment on lines 108 and 243.</li>
<li>Delete the "//" on lines 109 and 242.</li>
</ul>
</li>
<li>rm_usbx_pmsc_descriptor.c.template<br />
<ul>
<li>Comment on lines 78 and 153.</li>
<li>Delete the "//" on lines 79 and 152.</li>
</ul>
</li>
<li>rm_usbx_paud_descriptor.c.template<br />
<ul>
<li>Comment on lines 167 and 485.</li>
<li>Delete the "//" on lines 168 and 486.</li>
</ul>
</li>
</ul>
<p>There are two types of templates for PHID descriptor.<br />
 Keyboard templates should be referred to rm_usbx_phid_descriptor_keyboard.c.template.<br />
 Mouse templates should be referred to rm_usbx_phid_descriptor_mouse.c.template.</p>
<h1><a class="anchor" id="rm_usbx_pcdc-examples"></a>
Examples</h1>
<h2>USBX PCDC Example</h2>
<p>PCDC loopback example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #define VALUE_105    (105)</span></div><div class="line"><span class="preprocessor"> #define VALUE_2      (2)</span></div><div class="line"><span class="preprocessor"> #define VALUE_103    (103)</span></div><div class="line"><span class="preprocessor"> #define VALUE_93     (93)</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_cdc = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_cdc = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">            g_attach = USB_YES;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">            g_attach = USB_NO;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pcdc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_pcdc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    uint32_t  ret;</div><div class="line">    uint32_t  size;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                               VALUE_103,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               VALUE_93,</div><div class="line">                               g_string_framework,</div><div class="line">                               VALUE_105,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               VALUE_2,</div><div class="line">                               apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate   = ux_cdc_device0_instance_activate;</div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name,</div><div class="line">                                   _ux_device_class_cdc_acm_entry,</div><div class="line">                                   1,</div><div class="line">                                   0x00,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_YES == g_attach)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">while</span> (g_cdc == UX_NULL)</div><div class="line">                {</div><div class="line">                    ;</div><div class="line">                }</div><div class="line"></div><div class="line">                ret = _ux_device_class_cdc_acm_read(g_cdc, g_buf, DATA_LEN, &amp;g_actual_length);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (UX_SUCCESS == ret)</div><div class="line">                {</div><div class="line">                    size = g_actual_length;</div><div class="line"></div><div class="line">                    _ux_device_class_cdc_acm_write(g_cdc, g_buf, size, &amp;g_actual_length);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_pcdc_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div></div><!-- fragment --> <h2>USBX HCDC Example</h2>
<p>The main functions of the HCDC loopback example are as follows:</p>
<ol type="1">
<li>Virtual UART control settings are configured by transmitting the class request SET_LINE_CODING to the CDC device.</li>
<li>Sends receive (Bulk In transfer) requests to a CDC peripheral device and receives data.</li>
<li>Loops received data back to the peripheral by means of Bulk Out transfers.</li>
</ol>
<p>The main loop performs loopback processing in which data received from a CDC peripheral device is transmitted unaltered back to the peripheral.</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #define VALUE_100    (100)</span></div><div class="line"></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(host_class);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (UX_FSP_DEVICE_INSERTION == event) <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">    {</div><div class="line">        p_cdc_acm = (UX_HOST_CLASS_CDC_ACM *) instance;</div><div class="line">        <span class="keywordflow">if</span> (UX_HOST_CLASS_CDC_DATA_CLASS !=</div><div class="line">            p_cdc_acm-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (UX_NULL != p_cdc_acm-&gt;ux_host_class_cdc_acm_next_instance)</div><div class="line">            {</div><div class="line">                <span class="comment">/* It seems the DATA class is on the second interface. Or we hope !  */</span></div><div class="line">                p_cdc_acm = p_cdc_acm-&gt;ux_host_class_cdc_acm_next_instance;</div><div class="line"></div><div class="line">                <span class="comment">/* Check again this interface, if this is not the data interface, we give up.  */</span></div><div class="line">                <span class="keywordflow">if</span> (p_cdc_acm-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass !=</div><div class="line">                    UX_HOST_CLASS_CDC_DATA_CLASS)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* We did not find a proper data interface. */</span></div><div class="line">                    p_cdc_acm = UX_NULL;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (p_cdc_acm != UX_NULL)</div><div class="line">        {</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_activate_event_flags0, CDCACM_FLAG, TX_OR);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == UX_FSP_DEVICE_REMOVAL) <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">    {</div><div class="line">        tx_event_flags_set(&amp;g_cdcacm_activate_event_flags0, ~CDCACM_FLAG, TX_AND);</div><div class="line">        p_cdc_acm = UX_NULL;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">/* None */</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> buffer_clear (uint8_t * p)</div><div class="line">{</div><div class="line">    uint16_t counter;</div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        *p = 0U;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_hcdc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* CDCACM Host Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> usbx_hcdc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t status;</div><div class="line">    ULONG    actual_flags;</div><div class="line">    uint16_t counter = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        g_write_buf[counter] = (uint8_t) counter;</div><div class="line">    }</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        tx_event_flags_get(&amp;g_cdcacm_activate_event_flags0, CDCACM_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != p_cdc_acm)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (0 == g_is_communicate)</div><div class="line">            {</div><div class="line">                tx_thread_sleep(VALUE_100);</div><div class="line">                g_is_communicate = 1;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_NULL != p_cdc_acm)</div><div class="line">            {</div><div class="line">                status = ux_host_class_cdc_acm_write(p_cdc_acm, g_write_buf, DATA_LEN, &amp;g_write_actual_length);</div><div class="line">                <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_write_actual_length))</div><div class="line">                {</div><div class="line">                    g_read_actual_length = 0;</div><div class="line">                    buffer_clear(g_read_buf);</div><div class="line">                    <span class="keywordflow">if</span> (UX_NULL != p_cdc_acm)</div><div class="line">                    {</div><div class="line">                        status = ux_host_class_cdc_acm_read(p_cdc_acm, g_read_buf, DATA_LEN, &amp;g_read_actual_length);</div><div class="line">                        <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_read_actual_length))</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">                            {</div><div class="line">                                <span class="keywordflow">if</span> ((uint8_t) counter != g_read_buf[counter])</div><div class="line">                                {</div><div class="line">                                    <span class="keywordflow">while</span> (1)</div><div class="line">                                    {</div><div class="line">                                        ;</div><div class="line">                                    }</div><div class="line">                                }</div><div class="line">                            }          <span class="comment">/* for */</span></div><div class="line">                        }</div><div class="line">                    }                  <span class="comment">/* UX_NULL != p_cdc_acm */</span></div><div class="line">                }</div><div class="line">            }                          <span class="comment">/* UX_NULL != p_cdc_acm */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PMSC Example</h2>
<p>PMSC storage example is as follows.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#structrm__block__media__cfg__t">rm_block_media_cfg_t</a> g_rm_block_media0_cfg =</div><div class="line">{.<a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#a05aeac48f8dd9b31bdb6d1ca5ddf8600">p_extend</a> = NULL, .p_callback = NULL, .p_context = NULL, };</div><div class="line"></div><div class="line"><a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#structrm__block__media__info__t">rm_block_media_info_t</a> g_rm_block_info0 =</div><div class="line">{.<a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#a4e46e0d9177f55565fa8ceb002459d96">sector_size_bytes</a> = STRG_MEDIASIZE, .num_sectors = STRG_TOTALSECT, .reentrant = <span class="keyword">false</span>, .write_protected = <span class="keyword">false</span>, };</div><div class="line"></div><div class="line"><a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#structrm__block__media__instance__t">rm_block_media_instance_t</a> g_rm_block_media0 =</div><div class="line">{.<a class="code" href="group___r_m___b_l_o_c_k___m_e_d_i_a___a_p_i.html#a842bb35277df2dfbe5c79d7b146ae230">p_api</a> = &amp;g_rm_block_media_on_user_media, .p_ctrl = &amp;g_rm_block_info0, .p_cfg = &amp;g_rm_block_media0_cfg, };</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pmsc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_pmsc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    UINT      ret;</div><div class="line">    ULONG     size;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                               60,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               50,</div><div class="line">                               g_string_framework,</div><div class="line">                               93,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               2,</div><div class="line">                               UX_NULL);</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HMSC Example</h2>
<p>HMSC storage example is as follows. See usbx_hmsc_sample for the basic operation of HMSC. Also, please refer to usbx_hmsc_sample_format for the format of the USB memory.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define     UX_STORAGE_BUFFER_SIZE    (64 * 1024)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define     EVENT_USB_PLUG_IN         (1UL &lt;&lt; 0)</span></div><div class="line"><span class="preprocessor">#define     EVENT_USB_PLUG_OUT        (1UL &lt;&lt; 1)</span></div><div class="line"><span class="preprocessor">#define     MEMPOOL_SIZE              (63488)</span></div><div class="line"><span class="preprocessor">#define     DATA_LEN                  (2048)</span></div><div class="line"><span class="preprocessor">#define     VALUE_32                  (32)</span></div><div class="line"><span class="preprocessor">#define     VALUE_100                 (100)</span></div><div class="line"><span class="preprocessor">#define     VALUE_200                 (200)</span></div><div class="line"><span class="preprocessor">#define     VALUE_256                 (256)</span></div><div class="line"><span class="preprocessor">#define     VALUE_1024                (1024)</span></div><div class="line"><span class="preprocessor">#define     DEVICE_INSERTION          (0x01U)</span></div><div class="line"><span class="preprocessor">#define     DEVICE_REMOVAL            (0x02U)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> uint16_t g_read_buf[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> uint16_t g_write_buf[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> FX_FILE  g_file;</div><div class="line"></div><div class="line"><span class="keyword">static</span> UCHAR      g_fx_media0_media_memory[UX_STORAGE_BUFFER_SIZE];</div><div class="line"><span class="keyword">static</span> uint8_t    g_ux_pool_memory[MEMPOOL_SIZE];</div><div class="line"><span class="keyword">static</span> FX_MEDIA * g_p_media = UX_NULL;</div><div class="line"></div><div class="line">TX_EVENT_FLAGS_GROUP g_usb_plug_events;</div><div class="line"></div><div class="line">UINT usb_host_plug_event_notification(ULONG usb_event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance);</div><div class="line">UINT ux_system_host_storage_fx_media_get(UX_HOST_CLASS_STORAGE        * instance,</div><div class="line">                                         UX_HOST_CLASS_STORAGE_MEDIA ** p_storage_media,</div><div class="line">                                         FX_MEDIA                    ** p_fx_media);</div><div class="line"></div><div class="line"><span class="keyword">static</span> UINT apl_change_function (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    UINT                          status = UX_SUCCESS;</div><div class="line">    UX_HOST_CLASS               * <span class="keyword">class</span>;</div><div class="line">    UX_HOST_CLASS_STORAGE       * storage;</div><div class="line">    UX_HOST_CLASS_STORAGE_MEDIA * storage_media;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(host_class);</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(instance);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">    <span class="keywordflow">if</span> (DEVICE_INSERTION == event)</div><div class="line">    {</div><div class="line">        status = ux_host_stack_class_get(_ux_system_host_class_storage_name, &amp;<span class="keyword">class</span>);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> status;</div><div class="line">        }</div><div class="line"></div><div class="line">        status = ux_host_stack_class_instance_get(<span class="keyword">class</span>, 0, (<span class="keywordtype">void</span> **) &amp;storage);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> status;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (UX_HOST_CLASS_INSTANCE_LIVE != storage-&gt;ux_host_class_storage_state)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> UX_ERROR;</div><div class="line">        }</div><div class="line"></div><div class="line">        storage_media = <span class="keyword">class</span>-&gt;ux_host_class_media;</div><div class="line">        g_p_media     = &amp;storage_media-&gt;ux_host_class_storage_media;</div><div class="line"></div><div class="line">        tx_event_flags_set(&amp;g_usb_plug_events, EVENT_USB_PLUG_IN, TX_OR);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DEVICE_REMOVAL == event)  <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">    {</div><div class="line">        g_p_media = UX_NULL;</div><div class="line">        tx_event_flags_set(&amp;g_usb_plug_events, EVENT_USB_PLUG_OUT, TX_OR);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">/* None */</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_hmsc_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_hmsc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG      actual_length = 0;</div><div class="line">    ULONG      actual_flags;</div><div class="line">    UINT       tx_return;</div><div class="line">    UINT       fx_return;</div><div class="line">    uint16_t   data_count = 0;</div><div class="line">    FX_MEDIA * p_media    = UX_NULL;</div><div class="line">    CHAR       volume[VALUE_32];</div><div class="line"></div><div class="line">    fx_system_initialize();</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(apl_change_function);</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_usb_plug_events, (CHAR *) <span class="stringliteral">&quot;USB Plug Event Flags&quot;</span>);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">// Wait until device inserted.</span></div><div class="line">        tx_return = tx_event_flags_get(&amp;g_usb_plug_events,</div><div class="line">                                       EVENT_USB_PLUG_IN,</div><div class="line">                                       TX_OR_CLEAR,</div><div class="line">                                       &amp;actual_flags,</div><div class="line">                                       TX_WAIT_FOREVER);</div><div class="line">        <span class="keywordflow">if</span> (TX_SUCCESS != tx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Get the pointer to FileX Media Control Block for a USB flash device</span></div><div class="line">        p_media = g_p_media;</div><div class="line"></div><div class="line">        <span class="comment">// Retrieve the volume name of the opened media from the Data sector</span></div><div class="line">        fx_return = fx_media_volume_get(p_media, volume, FX_DIRECTORY_SECTOR);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">        {</div><div class="line">            <span class="comment">// Set the default directory in the opened media, arbitrary name called &quot;firstdir&quot;</span></div><div class="line">            fx_directory_default_set(p_media, <span class="stringliteral">&quot;firstdir&quot;</span>);</div><div class="line"></div><div class="line">            <span class="comment">// Suspend this thread for 200 time-ticks</span></div><div class="line">            tx_thread_sleep(VALUE_100);</div><div class="line"></div><div class="line">            <span class="comment">// Try to open the file, &#39;counter.txt&#39;.</span></div><div class="line">            fx_return = fx_file_open(p_media, &amp;g_file, <span class="stringliteral">&quot;counter.txt&quot;</span>, (FX_OPEN_FOR_READ | FX_OPEN_FOR_WRITE));</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">            {</div><div class="line">                <span class="comment">// The &#39;counter.txt&#39; file is not found, so create a new file</span></div><div class="line">                fx_return = fx_file_create(p_media, <span class="stringliteral">&quot;counter.txt&quot;</span>);</div><div class="line">                <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// Open that file</span></div><div class="line">                fx_return = fx_file_open(p_media, &amp;g_file, <span class="stringliteral">&quot;counter.txt&quot;</span>, (FX_OPEN_FOR_READ | FX_OPEN_FOR_WRITE));</div><div class="line">                <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Already open a file, then read the file in blocks</span></div><div class="line">            <span class="comment">// Set a specified byte offset for reading</span></div><div class="line">            fx_return = fx_file_seek(&amp;g_file, 0);</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">            {</div><div class="line">                fx_return = fx_file_read(&amp;g_file, g_read_buf, DATA_LEN, &amp;actual_length);</div><div class="line">                <span class="keywordflow">if</span> ((FX_SUCCESS == fx_return) || (FX_END_OF_FILE == fx_return))</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">if</span> (data_count == VALUE_1024)</div><div class="line">                    {</div><div class="line">                        <span class="comment">// empty file</span></div><div class="line">                        data_count = 0;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">for</span> (uint16_t data_max_count = data_count; data_count &lt; (data_max_count + VALUE_256); data_count++)</div><div class="line">                    {</div><div class="line">                        g_write_buf[data_count] = data_count;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="comment">// Set the specified byte offset for writing</span></div><div class="line">                    fx_return = fx_file_seek(&amp;g_file, 0);</div><div class="line">                    <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">                    {</div><div class="line">                        <span class="comment">// Write the file in blocks</span></div><div class="line">                        fx_return = fx_file_write(&amp;g_file, g_write_buf, DATA_LEN);</div><div class="line">                        <span class="keywordflow">if</span> (FX_SUCCESS == fx_return)</div><div class="line">                        {</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                        {</div><div class="line">                            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Close already opened file</span></div><div class="line">            fx_return = fx_file_close(&amp;g_file);</div><div class="line">            <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">            {</div><div class="line">                tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">            }</div><div class="line"></div><div class="line">            tx_thread_sleep(VALUE_200);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* flush the media */</span></div><div class="line">        fx_return = fx_media_flush(p_media);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* close the media */</span></div><div class="line">        fx_return = fx_media_close(p_media);</div><div class="line">        <span class="keywordflow">if</span> (FX_SUCCESS != fx_return)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Wait for unplugging the USB</span></div><div class="line">        tx_event_flags_get(&amp;g_usb_plug_events, EVENT_USB_PLUG_OUT, TX_OR_CLEAR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    }                                  <span class="comment">// while(1)</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_hmsc_sample_format (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG      actual_flags;</div><div class="line">    UINT       tx_return;</div><div class="line">    UINT       status  = UX_SUCCESS;</div><div class="line">    FX_MEDIA * p_media = UX_NULL;</div><div class="line"></div><div class="line">    fx_system_initialize();</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(apl_change_function);</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_usb_plug_events, (CHAR *) <span class="stringliteral">&quot;USB Plug Event Flags&quot;</span>);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="comment">// Wait until device inserted.</span></div><div class="line">    tx_return = tx_event_flags_get(&amp;g_usb_plug_events, EVENT_USB_PLUG_IN, TX_OR_CLEAR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    <span class="keywordflow">if</span> (TX_SUCCESS != tx_return)</div><div class="line">    {</div><div class="line">        tx_thread_sleep(TX_WAIT_FOREVER);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Get the pointer to FileX Media Control Block for a USB flash device</span></div><div class="line">    p_media = g_p_media;</div><div class="line"></div><div class="line">    memset(g_fx_media0_media_memory, 0x00, <span class="keyword">sizeof</span>(g_fx_media0_media_memory));</div><div class="line"></div><div class="line">    status = fx_media_format(p_media,                                  <span class="comment">// Pointer to FileX media control block.</span></div><div class="line">                             p_media-&gt;fx_media_driver_entry,           <span class="comment">// Driver entry</span></div><div class="line">                             p_media-&gt;fx_media_driver_info,            <span class="comment">// Pointer to Block Media Driver</span></div><div class="line">                             g_fx_media0_media_memory,                 <span class="comment">// Media buffer pointer</span></div><div class="line">                             p_media-&gt;fx_media_memory_size,            <span class="comment">// Media buffer size</span></div><div class="line">                             <span class="stringliteral">&quot;sample&quot;</span>,                                 <span class="comment">// Volume Name</span></div><div class="line">                             p_media-&gt;fx_media_number_of_FATs,         <span class="comment">// Number of FATs</span></div><div class="line">                             p_media-&gt;fx_media_root_directory_entries, <span class="comment">// Directory Entries</span></div><div class="line">                             p_media-&gt;fx_media_hidden_sectors,         <span class="comment">// Hidden sectors</span></div><div class="line">                             (ULONG) p_media-&gt;fx_media_total_sectors,  <span class="comment">// Total sectors</span></div><div class="line">                             p_media-&gt;fx_media_bytes_per_sector,       <span class="comment">// Sector size</span></div><div class="line">                             p_media-&gt;fx_media_sectors_per_cluster,    <span class="comment">// Sectors per cluster</span></div><div class="line">                             p_media-&gt;fx_media_heads,                  <span class="comment">// Heads (disk media)</span></div><div class="line">                             p_media-&gt;fx_media_sectors_per_track);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((uint8_t) FX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        __BKPT(0);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PHID Example</h2>
<p>PHID keyboard example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_phid_keyboard_sample</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_phid_keyboard_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UX_SLAVE_CLASS_HID_EVENT hid_event;</div><div class="line">    UCHAR     key;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_device_stack_initialize(NULL,</div><div class="line">                               0,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">#<span class="keywordflow">if</span> defined(APL_OUT_TRANSFER)</div><div class="line">                               VALUE_59,</div><div class="line">#<span class="keywordflow">else</span>                                  <span class="comment">/* defined(APL_OUT_TRANSFER) */</span></div><div class="line">                               VALUE_52,</div><div class="line">#endif  <span class="comment">/* defined(APL_OUT_TRANSFER) */</span></div><div class="line"></div><div class="line">                               g_string_framework,</div><div class="line">                               VALUE_53,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               VALUE_2,</div><div class="line">                               apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_hid_parameter.ux_slave_class_hid_instance_activate         = ux_hid_instance_activate;</div><div class="line">    g_ux_device_class_hid_parameter.ux_slave_class_hid_instance_deactivate       = ux_hid_instance_deactivate;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_address = g_apl_report;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_length  = REPORT_DESCRIPTOR_LENGTH;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_callback       = apl_hid_set_report_cb;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_report_id      = 0;</div><div class="line"><span class="preprocessor">#if defined(APL_OUT_TRANSFER)</span></div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_receiver_initialize =</div><div class="line">        ux_device_class_hid_receiver_initialize;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_receiver_event_max_number = 16;</div><div class="line">    g_ux_device_class_hid_parameter.ux_device_class_hid_parameter_receiver_event_max_length = DATA_LEN;</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(APL_OUT_TRANSFER) */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_hid_name,</div><div class="line">                                   _ux_device_class_hid_entry,</div><div class="line">                                   1,</div><div class="line">                                   0x00,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_hid_parameter);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the first key to &#39;a&#39; which is 04.  */</span></div><div class="line">    key = 0x04;</div><div class="line"></div><div class="line">    <span class="comment">/* reset the HID event structure.  */</span></div><div class="line">    ux_utility_memory_set(&amp;hid_event, 0, <span class="keyword">sizeof</span>(UX_SLAVE_CLASS_HID_EVENT));</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS == err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_NO == g_suspend)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">while</span> (UX_NULL == g_hid)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Then wait.  */</span></div><div class="line">                    tx_thread_sleep(10);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">/* 5sec wait */</span></div><div class="line">                usb_cpu_delay_xms((uint16_t) VALUE_5000);</div><div class="line"></div><div class="line">                <span class="comment">/* Then insert a key into the keyboard event.  Length is fixed to 8.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_length = 8;</div><div class="line"></div><div class="line">                <span class="comment">/* First byte is a modifier byte.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[0] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* Second byte is reserved. */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[1] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* The 6 next bytes are keys. We only have one key here.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[2] = key;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (UX_NULL != g_hid)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Set the keyboard event.  */</span></div><div class="line">                    ux_device_class_hid_event_set(g_hid, &amp;hid_event);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">/* Next event has the key depressed.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_buffer[2] = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* Length is fixed to 8.  */</span></div><div class="line">                hid_event.ux_device_class_hid_event_length = 8;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (UX_NULL != g_hid)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Set the keyboard event.  */</span></div><div class="line">                    ux_device_class_hid_event_set(g_hid, &amp;hid_event);</div><div class="line"></div><div class="line">                    <span class="comment">/* Are we at the end of alphabet ?  */</span></div><div class="line">                    <span class="keywordflow">if</span> (key != (0x04 + 26))</div><div class="line">                    {</div><div class="line">                        <span class="comment">/* Next key.  */</span></div><div class="line">                        key++;</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <span class="comment">/* Start over again.  */</span></div><div class="line">                        key = 0x04;</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined(APL_OUT_TRANSFER)</span></div><div class="line">                <span class="keywordflow">if</span> (UX_NULL != g_hid)</div><div class="line">                {</div><div class="line">                    status = ux_device_class_hid_receiver_event_get(g_hid, &amp;hid_out_event);</div><div class="line">                    <span class="keywordflow">if</span> (UX_SUCCESS == status)</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">for</span> (i = 0; i &lt; hid_out_event.ux_device_class_hid_received_event_length; i++)</div><div class="line">                        {</div><div class="line">                            g_out_buf[i] = *(hid_out_event.ux_device_class_hid_received_event_data + i);</div><div class="line">                        }</div><div class="line"></div><div class="line">                        ux_device_class_hid_receiver_event_free(g_hid);</div><div class="line">                    }</div><div class="line">                }</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(APL_OUT_TRANSFER) */</span><span class="preprocessor"></span></div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (USB_NO == g_remote_wakeup)</div><div class="line">                {</div><div class="line">                    tx_thread_sleep(VALUE_10000);</div><div class="line"></div><div class="line">                    <span class="comment">/* Remote wakeup processing */</span></div><div class="line">                    g_remote_wakeup = USB_YES;</div><div class="line"></div><div class="line">                    ux_device_stack_host_wakeup();</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HHID Example</h2>
<p>HHID user interface example is as follows.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> keyboard_update_task (ULONG thread_input)</div><div class="line">{</div><div class="line">    ULONG usbx_return_value;</div><div class="line"></div><div class="line">    <span class="comment">/* keyboard button masks, set by ux_host_class_hid_keyboard_buttons_get call */</span></div><div class="line">    ULONG keyboard_key = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* keyboard state masks, set by ux_host_class_hid_keyboard_buttons_get call */</span></div><div class="line">    ULONG keyboard_state = 0;</div><div class="line"><span class="preprocessor">#if defined(UX_HOST_CLASS_HID_INTERRUPT_OUT_SUPPORT)</span></div><div class="line">    UX_HOST_CLASS_HID_KEYBOARD * keyboard_instance;</div><div class="line">    ULONG i;</div><div class="line"></div><div class="line">    UX_HOST_CLASS_HID_CLIENT_REPORT client_report;</div><div class="line">    UX_HOST_CLASS_HID_REPORT        hid_report;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; (OUT_DATA_LEN / 4); i++)</div><div class="line">    {</div><div class="line">        g_buf[i] = i;</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(UX_HOST_CLASS_HID_INTERRUPT_OUT_SUPPORT) */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != hid_keyboard_client)</div><div class="line">        {</div><div class="line">            usbx_return_value = ux_host_class_hid_keyboard_key_get(</div><div class="line">                (UX_HOST_CLASS_HID_KEYBOARD *) hid_keyboard_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">                &amp;keyboard_key,</div><div class="line">                &amp;keyboard_state);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> ((usbx_return_value == UX_SUCCESS) || (usbx_return_value == UX_NO_KEY_PRESS))</div><div class="line">            {</div><div class="line">                hid_devices_info.device_connected = KEYBOARD_DEVICE;</div><div class="line">                hid_devices_info.key              = keyboard_key;</div><div class="line">                hid_devices_info.keyboard_status  = keyboard_state;</div><div class="line"></div><div class="line">                <span class="comment">/* Clear the states for next read */</span></div><div class="line">                keyboard_key   = 0;</div><div class="line">                keyboard_state = 0;</div><div class="line"></div><div class="line">                <span class="comment">/* copy the keyboard states to queue */</span></div><div class="line">                tx_queue_send(&amp;device_parameters, &amp;hid_devices_info, TX_NO_WAIT);</div><div class="line"><span class="preprocessor">#if defined(UX_HOST_CLASS_HID_INTERRUPT_OUT_SUPPORT)</span></div><div class="line">                hid_report.ux_host_class_hid_report_id          = 0;</div><div class="line">                hid_report.ux_host_class_hid_report_type        = UX_HOST_CLASS_HID_REPORT_TYPE_OUTPUT;</div><div class="line">                hid_report.ux_host_class_hid_report_byte_length = OUT_DATA_LEN;</div><div class="line"></div><div class="line">                client_report.ux_host_class_hid_client_report        = &amp;hid_report;</div><div class="line">                client_report.ux_host_class_hid_client_report_buffer = g_buf;</div><div class="line">                client_report.ux_host_class_hid_client_report_length = OUT_DATA_LEN;</div><div class="line">                client_report.ux_host_class_hid_client_report_flags  = UX_HOST_CLASS_HID_REPORT_RAW;</div><div class="line"></div><div class="line">                keyboard_instance =</div><div class="line">                    (UX_HOST_CLASS_HID_KEYBOARD *) hid_keyboard_client-&gt;ux_host_class_hid_client_local_instance;</div><div class="line"></div><div class="line">                <span class="comment">/* HID Out Transfer */</span></div><div class="line">                ux_host_class_hid_report_set((UX_HOST_CLASS_HID *) keyboard_instance-&gt;ux_host_class_hid_keyboard_hid,</div><div class="line">                                             &amp;client_report);</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(UX_HOST_CLASS_HID_INTERRUPT_OUT_SUPPORT) */</span><span class="preprocessor"></span></div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(10);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mouse_update_task (ULONG thread_input)</div><div class="line">{</div><div class="line">    <span class="comment">/* mouse button masks, set by ux_host_class_hid_mouse_buttons_get call */</span></div><div class="line">    ULONG mouse_buttons;</div><div class="line"></div><div class="line">    <span class="comment">/* X co-ordinate displacement of mouse */</span></div><div class="line">    SLONG mouse_x_position = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Y co-ordinate displacement of mouse */</span></div><div class="line">    SLONG mouse_y_position = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* variable to hold USBX return values */</span></div><div class="line">    ULONG usbx_return_value;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != hid_mouse_client)</div><div class="line">        {</div><div class="line">            usbx_return_value = ux_host_class_hid_mouse_buttons_get(</div><div class="line">                (UX_HOST_CLASS_HID_MOUSE *) hid_mouse_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">                &amp;mouse_buttons);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS == usbx_return_value)</div><div class="line">            {</div><div class="line">                usbx_return_value = ux_host_class_hid_mouse_position_get(</div><div class="line">                    (UX_HOST_CLASS_HID_MOUSE *) hid_mouse_client-&gt;ux_host_class_hid_client_local_instance,</div><div class="line">                    &amp;mouse_x_position,</div><div class="line">                    &amp;mouse_y_position);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS == usbx_return_value)</div><div class="line">            {</div><div class="line">                hid_devices_info.device_connected  = MOUSE_DEVICE;</div><div class="line">                hid_devices_info.key               = mouse_buttons;</div><div class="line">                hid_devices_info.mouse_direction_X = mouse_x_position;</div><div class="line">                hid_devices_info.mouse_direction_Y = mouse_y_position;</div><div class="line">                tx_queue_send(&amp;device_parameters, &amp;hid_devices_info, TX_NO_WAIT);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(10);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> usbx_hhid_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t i;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_host_stack_initialize(ux_system_host_hid_change_function);</div><div class="line"></div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    tx_thread_create(&amp;keyboard_update,</div><div class="line">                     (CHAR *) <span class="stringliteral">&quot;keyboard_update_task&quot;</span>,</div><div class="line">                     keyboard_update_task,</div><div class="line">                     (ULONG) NULL,</div><div class="line">                     &amp;keyboard_update_stack,</div><div class="line">                     2048,</div><div class="line">                     22,</div><div class="line">                     2,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line"></div><div class="line">    tx_thread_create(&amp;mouse_update,</div><div class="line">                     (CHAR *) <span class="stringliteral">&quot;mouse_update_task&quot;</span>,</div><div class="line">                     mouse_update_task,</div><div class="line">                     (ULONG) NULL,</div><div class="line">                     &amp;mouse_update_stack,</div><div class="line">                     1024,</div><div class="line">                     22,</div><div class="line">                     2,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; UX_HOST_CLASS_HID_MAX_CLIENTS; i++)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Check whether the instance registered? through USB HID device insertion callback? */</span></div><div class="line">            <span class="keywordflow">if</span> (UX_NULL != hid_class_keyboard_instance[i])</div><div class="line">            {</div><div class="line">                UX_HOST_CLASS_HID_CLIENT * hid_client = hid_class_keyboard_instance[i]-&gt;ux_host_class_hid_client;</div><div class="line">                hid_keyboard_client = hid_client;</div><div class="line">                tx_thread_sleep(10);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* Check whether the instance registered? through USB HID device insertion callback? */</span></div><div class="line">            <span class="keywordflow">if</span> (UX_NULL != hid_class_mouse_instance[i])</div><div class="line">            {</div><div class="line">                UX_HOST_CLASS_HID_CLIENT * hid_client = hid_class_mouse_instance[i]-&gt;ux_host_class_hid_client;</div><div class="line">                hid_mouse_client = hid_client;</div><div class="line">                tx_thread_sleep(10);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* If multiple similar type devices are connected, allow them one by one share data with application */</span></div><div class="line">            tx_thread_sleep(10);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PAUD Example</h2>
<p>PAUD example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define VALUE_275                  (275)</span></div><div class="line"><span class="preprocessor">#define VALUE_226                  (226)</span></div><div class="line"><span class="preprocessor">#define VALUE_93                   (93)</span></div><div class="line"><span class="preprocessor">#define VALUE_2                    (2)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define STACK_SIZE                 (1024U)</span></div><div class="line"><span class="preprocessor">#define NUM_OF_FRAME               (8U)</span></div><div class="line"><span class="preprocessor">#define USB_MAX_PACKET_SIZE_IN     (200U)</span></div><div class="line"><span class="preprocessor">#define USB_MAX_PACKET_SZIE_OUT    (192U)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define USB_APL_ON                 (1U)</span></div><div class="line"><span class="preprocessor">#define USB_APL_OFF                (0U)</span></div><div class="line"></div><div class="line"><span class="comment">/*** Please enable the following macro when supporting High-speed. ***/</span></div><div class="line"></div><div class="line"><span class="comment">// #define APL_AUDIO_20</span></div><div class="line"></div><div class="line"><span class="comment">/*********************************************************************/</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t g_read_buf[NUM_OF_FRAME][USB_MAX_PACKET_SZIE_OUT];</div><div class="line"><span class="keyword">static</span> uint8_t g_write_buf[USB_MAX_PACKET_SIZE_IN];</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO * <span class="keyword">volatile</span> g_p_audio = UX_NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint8_t g_read_wp = 0U;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint32_t g_read_alternate_setting  = USB_APL_OFF;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint32_t g_write_alternate_setting = USB_APL_OFF;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint8_t  g_apl_usb_status          = USB_APL_DETACH;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_GROUP g_audio20_control_group;</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO20_CONTROL       g_audio20_control[2];</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_GROUP g_audio_control_group;</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_AUDIO10_CONTROL       g_audio_control[2];</div><div class="line"><span class="preprocessor">#endif  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_DEFAULT;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_CONFIGURED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_CONFIGURED;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">        {</div><div class="line">            g_apl_usb_status = USB_APL_DETACH;</div><div class="line"></div><div class="line">            g_read_wp                 = 0U;</div><div class="line">            g_read_alternate_setting  = USB_APL_OFF;</div><div class="line">            g_write_alternate_setting = USB_APL_OFF;</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_SUSPENDED:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_APL_CONFIGURED == g_apl_usb_status)</div><div class="line">            {</div><div class="line">                g_apl_usb_status = USB_APL_SUSPEND;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_RESUMED:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (USB_APL_SUSPEND == g_apl_usb_status)</div><div class="line">            {</div><div class="line">                g_apl_usb_status = USB_APL_CONFIGURED;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * p_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_instance_activate (<span class="keywordtype">void</span> * p_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_audio = (UX_DEVICE_CLASS_AUDIO *) p_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * p_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_instance_deactivate (<span class="keywordtype">void</span> * p_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(p_instance);</div><div class="line"></div><div class="line">    g_p_audio = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio20_request_process</span></div><div class="line"><span class="comment"> * Description     : Audio20 Control Request Processing</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO * : Pointer to Audio instance</span></div><div class="line"><span class="comment"> *                 : UX_SLAVE_TRANSFER * : Pointer to UX_SLAVE_TRANSFER structure</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_audio20_request_process (UX_DEVICE_CLASS_AUDIO * p_audio, UX_SLAVE_TRANSFER * p_transfer)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    uint8_t i;</div><div class="line">    uint8_t number;</div><div class="line"></div><div class="line">    ux_err = ux_device_class_audio20_control_process(p_audio, p_transfer, &amp;g_audio20_control_group);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Request handled, check changes */</span></div><div class="line">        number = (uint8_t) g_audio20_control_group.ux_device_class_audio20_control_group_controls_nb;</div><div class="line"></div><div class="line">        for (i = 0; i &lt; number; i++)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (g_audio20_control[i].ux_device_class_audio20_control_changed)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_MUTE_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_mute[i] = g_audio20_control[i].ux_device_class_audio20_control_mute[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO20_CONTROL_VOLUME_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_volume[i] = g_audio20_control[i].ux_device_class_audio20_control_volume[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio20_request_process</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio10_request_process</span></div><div class="line"><span class="comment"> * Description     : Audio10 Control Request Processing</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO * : Pointer to Audio instance</span></div><div class="line"><span class="comment"> *                 : UX_SLAVE_TRANSFER * : Pointer to UX_SLAVE_TRANSFER structure</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT apl_audio10_request_process (UX_DEVICE_CLASS_AUDIO * p_audio, UX_SLAVE_TRANSFER * p_transfer)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    uint8_t i;</div><div class="line">    uint8_t number;</div><div class="line"></div><div class="line">    ux_err = ux_device_class_audio10_control_process(p_audio, p_transfer, &amp;g_audio_control_group);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Request handled, check changes */</span></div><div class="line">        number = (uint8_t) g_audio_control_group.ux_device_class_audio10_control_group_controls_nb;</div><div class="line"></div><div class="line">        for (i = 0; i &lt; number; i++)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (g_audio_control[i].ux_device_class_audio10_control_changed)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_MUTE_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_mute[i] = g_audio_control[i].ux_device_class_audio10_control_mute[0];</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_DEVICE_CLASS_AUDIO10_CONTROL_VOLUME_CHANGED:</div><div class="line">                {</div><div class="line">                    g_control_volume[i] = g_audio_control[i].ux_device_class_audio10_control_volume[0];;</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio10_request_process</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_change</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switching alternate setting value of OUT transfer</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Alternate Setting Value</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_read_change (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG alternate_setting)</div><div class="line">{</div><div class="line">    UINT ux_err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == alternate_setting)</div><div class="line">    {</div><div class="line">        ux_device_class_audio_reception_start(p_stream);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (USB_APL_ON == g_read_alternate_setting)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Alternate Setting 1 --&gt; 0 */</span></div><div class="line">            g_read_wp = 0U;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    g_read_alternate_setting = alternate_setting;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_change</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_read_done</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing of OUT transfer reception</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Actual Length</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_read_done (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG actual_length)</div><div class="line">{</div><div class="line">    UINT    ux_err;</div><div class="line">    UCHAR * p_buffer;</div><div class="line">    ULONG   length;</div><div class="line">    UINT    i;</div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(actual_length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == g_read_alternate_setting)</div><div class="line">    {</div><div class="line">        ux_err = ux_device_class_audio_read_frame_get(p_stream, &amp;p_buffer, &amp;length);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; length; i++)</div><div class="line">            {</div><div class="line">                g_read_buf[g_read_wp][i] = *(p_buffer + i);</div><div class="line">            }</div><div class="line"></div><div class="line">            g_read_wp++;</div><div class="line">            g_read_wp %= NUM_OF_FRAME;</div><div class="line">            ux_device_class_audio_read_frame_free(p_stream);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_read_done</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_write_change</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switching alternate setting value of IN transfer</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Alternate Setting Value</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_write_change (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG alternate_setting)</div><div class="line">{</div><div class="line">    UINT ux_err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == alternate_setting)</div><div class="line">    {</div><div class="line">        ux_err = ux_device_class_audio_frame_write(p_stream, g_write_buf, USB_MAX_PACKET_SIZE_IN);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == ux_err)</div><div class="line">        {</div><div class="line">            ux_device_class_audio_transmission_start(p_stream);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    g_write_alternate_setting = alternate_setting;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_write_change</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_audio_write_done</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing of IN transfer transmission</span></div><div class="line"><span class="comment"> * Arguments       : UX_DEVICE_CLASS_AUDIO_STREAM * : Pointer to UX_DEVICE_CLASS_AUDIO_STREAM structure</span></div><div class="line"><span class="comment"> *                 : ULONG : Actual Length</span></div><div class="line"><span class="comment"> * Return value    : None</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_audio_write_done (UX_DEVICE_CLASS_AUDIO_STREAM * p_stream, ULONG actual_length)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(actual_length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (USB_APL_ON == g_write_alternate_setting)</div><div class="line">    {</div><div class="line">        ux_device_class_audio_frame_write(p_stream, g_write_buf, USB_MAX_PACKET_SIZE_IN);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_audio_write_done</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_paudio_apl_init</span></div><div class="line"><span class="comment"> * Description     : Initialization processing</span></div><div class="line"><span class="comment"> * Arguments       : None</span></div><div class="line"><span class="comment"> * Return value    : None</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_paudio_apl_init (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line">    UINT      ux_err;</div><div class="line">    uint16_t  i = 0;</div><div class="line">    UX_DEVICE_CLASS_AUDIO_STREAM_PARAMETER audio_stream_parameter[2];</div><div class="line">    UX_DEVICE_CLASS_AUDIO_PARAMETER        audio_parameter;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                               VALUE_275,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               VALUE_226,</div><div class="line">                               g_string_framework,</div><div class="line">                               VALUE_93,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               VALUE_2,</div><div class="line">                               apl_status_change_cb);</div><div class="line"></div><div class="line">    <span class="comment">/* Read Initialization */</span></div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_change =</div><div class="line">        apl_audio_read_change;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_frame_done =</div><div class="line">        apl_audio_read_done;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_thread_stack_size     = STACK_SIZE;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_max_frame_buffer_nb   = NUM_OF_FRAME;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_max_frame_buffer_size = USB_MAX_PACKET_SZIE_OUT;</div><div class="line">    audio_stream_parameter[0].ux_device_class_audio_stream_parameter_thread_entry          =</div><div class="line">        ux_device_class_audio_read_thread_entry;</div><div class="line"></div><div class="line">    <span class="comment">/* Write Initialization */</span></div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_change =</div><div class="line">        apl_audio_write_change;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_callbacks.ux_device_class_audio_stream_frame_done =</div><div class="line">        apl_audio_write_done;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_thread_stack_size     = STACK_SIZE;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_max_frame_buffer_nb   = NUM_OF_FRAME;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_max_frame_buffer_size = USB_MAX_PACKET_SIZE_IN;</div><div class="line">    audio_stream_parameter[1].ux_device_class_audio_stream_parameter_thread_entry          =</div><div class="line">        ux_device_class_audio_write_thread_entry;</div><div class="line"></div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_slave_class_audio_instance_activate =</div><div class="line">        apl_audio_instance_activate;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_slave_class_audio_instance_deactivate =</div><div class="line">        apl_audio_instance_deactivate;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_callbacks.ux_device_class_audio_control_process</div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line">        = apl_audio20_request_process;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        = apl_audio10_request_process;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    audio_parameter.ux_device_class_audio_parameter_streams_nb = 2;</div><div class="line">    audio_parameter.ux_device_class_audio_parameter_streams    = &amp;audio_stream_parameter[0];</div><div class="line"></div><div class="line">    ux_err =</div><div class="line">        ux_device_stack_class_register(_ux_system_slave_class_audio_name,</div><div class="line">                                       _ux_device_class_audio_entry,</div><div class="line">                                       1,</div><div class="line">                                       0x00,</div><div class="line">                                       (<span class="keywordtype">void</span> *) &amp;audio_parameter);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != ux_err)</div><div class="line">    {</div><div class="line">        USB_APL_AUDIO_ERROR();</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef APL_AUDIO_20</span></div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_cs_id              = 0x10;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_sampling_frequency = 48000;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_fu_id              = 5;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_mute[0]            = 0;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume_min[0]      = 0;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume_max[0]      = 100;</div><div class="line">    g_audio20_control[0].ux_device_class_audio20_control_volume[0]          = 50;</div><div class="line"></div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_cs_id              = 0x10;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_sampling_frequency = 48000;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_fu_id              = 8;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_mute[0]            = 0;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume_min[0]      = 0;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume_max[0]      = 200;</div><div class="line">    g_audio20_control[1].ux_device_class_audio20_control_volume[0]          = 100;</div><div class="line"></div><div class="line">    g_audio20_control_group.ux_device_class_audio20_control_group_controls_nb = 2;</div><div class="line">    g_audio20_control_group.ux_device_class_audio20_control_group_controls    = &amp;g_audio20_control[0];</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_fu_id         = 5;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_mute[0]       = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume[0]     = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_min[0] = 0;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_max[0] = 0x80;</div><div class="line">    g_audio_control[0].ux_device_class_audio10_control_volume_res[0] = 0x40;</div><div class="line"></div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_fu_id                = 8;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_mute[0]              = 0x10;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume[0]            = 0x00;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_min[0]        = 0;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_max[0]        = 0xF0;</div><div class="line">    g_audio_control[1].ux_device_class_audio10_control_volume_res[0]        = 0x80;</div><div class="line">    g_audio_control_group.ux_device_class_audio10_control_group_controls_nb = 2;</div><div class="line">    g_audio_control_group.ux_device_class_audio10_control_group_controls    = &amp;g_audio_control[0];</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* APL_AUDIO_20 */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; USB_MAX_PACKET_SIZE_IN; i++)</div><div class="line">    {</div><div class="line">        g_write_buf[i] = (UCHAR) (i &amp; 0xFF);</div><div class="line">    }</div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        USB_APL_AUDIO_ERROR();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_paudio_apl_init</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_paudio_apl</span></div><div class="line"><span class="comment"> * Description     : Application task for USB Audio</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_paud_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    usbx_paudio_apl_init();</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">switch</span> (g_apl_usb_status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">case</span> USB_APL_CONFIGURED:</div><div class="line">            {</div><div class="line">                <span class="comment">/* Application Processing */</span></div><div class="line"></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> USB_APL_DETACH:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> USB_APL_SUSPEND:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX PPRN Example</h2>
<p>PPRN example is as follows.</p>
<p>Note: Define "2" to "DEMO_PROTOCOL" macro when supporting IN transfer and define "1" to "DEMO_PROTOCOL" macro when not supporting IN transfer.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> *  Macro definitions</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#define DEMO_PROTOCOL                     (1U) </span><span class="comment">/* 1-Uni-dir, 2-Bi-dir */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="preprocessor">#define DEMO_STACK_SIZE                   1024</span></div><div class="line"></div><div class="line"><span class="comment">/* USBx device configuration settings */</span></div><div class="line"><span class="preprocessor">#define DEVICE_FRAME_LENGTH_HIGH_SPEED    (53U) + ((DEMO_PROTOCOL &gt; 1) ? 7 : 0) </span><span class="comment">/* Length of g_device_framework_hi_speed[] */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define DEVICE_FRAME_LENGTH_FULL_SPEED    (43U) + ((DEMO_PROTOCOL &gt; 1) ? 7 : 0) </span><span class="comment">/* Length of g_device_framework_full_speed[] */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define STRING_FRAMEWORK_LENGTH           (53U)                                 </span><span class="comment">/* Length of g_string_framework[]. If edit g_string_framework[], need to change this value. */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define LANGUAGE_ID_FRAME_WORK_LENGTH     (2U)</span></div><div class="line"><span class="preprocessor">#define CONFIG_NUMB                       (1U)</span></div><div class="line"><span class="preprocessor">#define INTERFACE_NUMB0                   (0x00)</span></div><div class="line"><span class="preprocessor">#define INTERFACE_NUMB1                   (0x01)</span></div><div class="line"><span class="preprocessor">#define MEMPOOL_SIZE                      (18432U)</span></div><div class="line"><span class="preprocessor">#define BYTE_SIZE                         (4U)</span></div><div class="line"><span class="preprocessor">#define DATA_LEN                          (512U)</span></div><div class="line"><span class="preprocessor">#define MAX_PACKET_SIZE_HS                (512U)</span></div><div class="line"><span class="preprocessor">#define MAX_PACKET_SIZE_FS                (64U)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define PRINTER_DEVICE_ID_LENGTH          (91U) </span><span class="comment">/* Length of printer_device_id[]. If edit printer_device_id[], need to change this value. */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Exported global variables and functions (to be accessed by other files)</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">extern</span> uint8_t g_device_framework_full_speed[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_device_framework_hi_speed[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_string_framework[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_language_id_framework[];</div><div class="line"><span class="keyword">extern</span> uint8_t printer_device_id[];</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">union </span>_PRINTER_PORT_STATUS</div><div class="line">{</div><div class="line">    <span class="keyword">struct</span></div><div class="line">    {</div><div class="line">        uint8_t reserved    : 3;</div><div class="line">        uint8_t not_error   : 1;</div><div class="line">        uint8_t select      : 1;</div><div class="line">        uint8_t paper_empty : 1;</div><div class="line">    }       bm;</div><div class="line">    uint8_t value;</div><div class="line">} device_printer_port_status;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>TEST_DATA_STRUCT</div><div class="line">{</div><div class="line">    uint32_t mem_usage_max;</div><div class="line">    uint32_t mem_usage;</div><div class="line">} test_data = {0, 0};</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Global functions and variables</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">extern</span> uint32_t usb_peri_usbx_initialize(uint32_t dcd_io);</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Private global variables and functions</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_instance_activate(<span class="keywordtype">void</span> * printer_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_instance_deactivate(<span class="keywordtype">void</span> * printer_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_soft_reset(<span class="keywordtype">void</span> * printer_instance);</div><div class="line"></div><div class="line"><span class="comment">/* Mempool size of 18k is required for USBX device class pre built libraries</span></div><div class="line"><span class="comment"> * and it is valid only if it with default USBX configurations. */</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[(MEMPOOL_SIZE + DEMO_STACK_SIZE * 3) / BYTE_SIZE];</div><div class="line"></div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_PRINTER_PARAMETER device_printer_parameter;</div><div class="line"><span class="keyword">static</span> UX_DEVICE_CLASS_PRINTER         * device_printer = UX_NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> uint8_t device_printer_buffer[DATA_LEN];</div><div class="line"></div><div class="line">uint8_t _ux_system_slave_class_prn_name[] = <span class="stringliteral">&quot;ux_device_class_printer&quot;</span>;</div><div class="line"></div><div class="line"><span class="comment">/* Define local function prototypes.  */</span></div><div class="line"><span class="keywordtype">void</span> demo_thread_entry(uint32_t thread_input);</div><div class="line"><span class="keywordtype">void</span> printer_read_thread_entry(uint32_t thread_input);</div><div class="line"><span class="keywordtype">void</span> printer_write_thread_entry(uint32_t thread_input);</div><div class="line"></div><div class="line"><span class="comment">/* Define global data structures.   */</span></div><div class="line"><span class="keyword">static</span> TX_THREAD demo_thread;</div><div class="line"><span class="keyword">static</span> TX_THREAD printer_read_thread;</div><div class="line"><span class="preprocessor">#if DEMO_PROTOCOL &gt; 1</span></div><div class="line"><span class="keyword">static</span> TX_THREAD printer_write_thread;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_printer_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * printer_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_instance_activate (<span class="keywordtype">void</span> * printer_instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (device_printer == UX_NULL)</div><div class="line">    {</div><div class="line">        device_printer = (UX_DEVICE_CLASS_PRINTER *) printer_instance;</div><div class="line">        ux_device_class_printer_ioctl(device_printer,</div><div class="line">                                      UX_DEVICE_CLASS_PRINTER_IOCTL_PORT_STATUS_SET,</div><div class="line">                                      (<span class="keywordtype">void</span> *) device_printer_port_status.value);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_printer_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_printer_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * printer_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_instance_deactivate (<span class="keywordtype">void</span> * printer_instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> ((<span class="keywordtype">void</span> *) device_printer == printer_instance)</div><div class="line">    {</div><div class="line">        device_printer = UX_NULL;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_printer_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_printer_soft_reset</span></div><div class="line"><span class="comment"> * Description     : This function does nothing in particular.</span></div><div class="line"><span class="comment"> * Arguments       : void * printer_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_printer_soft_reset (<span class="keywordtype">void</span> * printer_instance)</div><div class="line">{</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_printer_soft_reset</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pprn_sample</span></div><div class="line"><span class="comment"> * Description     : Initialization for Peripheral Printer</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_pprn_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="comment">/* To check ux api return status */</span></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line"></div><div class="line"><span class="comment">/* To check fsp api return status */</span></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err = FSP_SUCCESS;</div><div class="line"></div><div class="line">    uint8_t * stack_pointer;</div><div class="line">    uint8_t * memory_pointer;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    stack_pointer  = (uint8_t *) g_ux_pool_memory;</div><div class="line">    memory_pointer = stack_pointer + DEMO_STACK_SIZE * 3;</div><div class="line">    ux_system_initialize(memory_pointer, MEMPOOL_SIZE, UX_NULL, 0x00);</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack initialization */</span></div><div class="line">    ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                               DEVICE_FRAME_LENGTH_HIGH_SPEED,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               DEVICE_FRAME_LENGTH_FULL_SPEED,</div><div class="line">                               g_string_framework,</div><div class="line">                               STRING_FRAMEWORK_LENGTH,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               LANGUAGE_ID_FRAME_WORK_LENGTH,</div><div class="line">                               UX_NULL);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the parameters for callback when insertion/extraction of a printer device.  */</span></div><div class="line">    _ux_utility_memory_set(&amp;device_printer_parameter, 0, <span class="keyword">sizeof</span>(device_printer_parameter));</div><div class="line">    _ux_utility_short_put_big_endian(printer_device_id, PRINTER_DEVICE_ID_LENGTH);</div><div class="line">    device_printer_port_status.value = UX_DEVICE_CLASS_PRINTER_SELECT | UX_DEVICE_CLASS_PRINTER_NOT_ERROR;</div><div class="line">    device_printer_parameter.ux_device_class_printer_device_id           = printer_device_id;</div><div class="line">    device_printer_parameter.ux_device_class_printer_instance_activate   = ux_printer_instance_activate;</div><div class="line">    device_printer_parameter.ux_device_class_printer_instance_deactivate = ux_printer_instance_deactivate;</div><div class="line">    device_printer_parameter.ux_device_class_printer_soft_reset          = ux_printer_soft_reset;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack class registration */</span></div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_prn_name,</div><div class="line">                                   _ux_device_class_printer_entry,</div><div class="line">                                   CONFIG_NUMB,</div><div class="line">                                   INTERFACE_NUMB0,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;device_printer_parameter);</div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="comment">/* Create the main demo thread.  */</span></div><div class="line">    tx_thread_create(&amp;demo_thread,</div><div class="line">                     <span class="stringliteral">&quot;tx demo&quot;</span>,</div><div class="line">                     demo_thread_entry,</div><div class="line">                     0,</div><div class="line">                     stack_pointer,</div><div class="line">                     DEMO_STACK_SIZE,</div><div class="line">                     20,</div><div class="line">                     20,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line">    stack_pointer += DEMO_STACK_SIZE;</div><div class="line"></div><div class="line">    <span class="comment">/* Create the printer read thread.  */</span></div><div class="line">    tx_thread_create(&amp;printer_read_thread,</div><div class="line">                     <span class="stringliteral">&quot;read_thread&quot;</span>,</div><div class="line">                     printer_read_thread_entry,</div><div class="line">                     0,</div><div class="line">                     stack_pointer,</div><div class="line">                     DEMO_STACK_SIZE,</div><div class="line">                     20,</div><div class="line">                     20,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line">    stack_pointer += DEMO_STACK_SIZE;</div><div class="line"></div><div class="line"><span class="preprocessor">#if DEMO_PROTOCOL &gt; 1</span></div><div class="line"></div><div class="line">    <span class="comment">/* Create the main demo thread.  */</span></div><div class="line">    tx_thread_create(&amp;printer_write_thread,</div><div class="line">                     <span class="stringliteral">&quot;write_thread&quot;</span>,</div><div class="line">                     printer_write_thread_entry,</div><div class="line">                     0,</div><div class="line">                     stack_pointer,</div><div class="line">                     DEMO_STACK_SIZE,</div><div class="line">                     20,</div><div class="line">                     20,</div><div class="line">                     1,</div><div class="line">                     TX_AUTO_START);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_pprn_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_mem_usage_update</span></div><div class="line"><span class="comment"> * Description     : Update memory usage</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> apl_mem_usage_update (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t mem_total;</div><div class="line"></div><div class="line">    <span class="comment">/* Update memory usage.  */</span></div><div class="line">    mem_total = _ux_system-&gt;ux_system_regular_memory_pool_size + (uint32_t) (</div><div class="line">        (uint8_t *) _ux_system-&gt;ux_system_regular_memory_pool_start -</div><div class="line">        (uint8_t *) _ux_system);</div><div class="line">    test_data.mem_usage = mem_total - _ux_system-&gt;ux_system_regular_memory_pool_free;</div><div class="line"><span class="preprocessor">#ifdef UX_ENABLE_MEMORY_STATISTICS</span></div><div class="line">    test_data.mem_usage_max = mem_total - _ux_system-&gt;ux_system_regular_memory_pool_min_free;</div><div class="line"><span class="preprocessor">#else                                  </span><span class="comment">/* Not accurate, there could be alloc/free between checks.  */</span><span class="preprocessor"></span></div><div class="line">    <span class="keywordflow">if</span> (test_data.mem_usage &gt; test_data.mem_usage_max)</div><div class="line">    {</div><div class="line">        test_data.mem_usage_max = test_data.mem_usage;</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_mem_usage_update</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_minus</span></div><div class="line"><span class="comment"> * Description     : Adjust timer</span></div><div class="line"><span class="comment"> * Arguments       : uint32_t v_origin</span></div><div class="line"><span class="comment"> *                 : uint32_t v_minus</span></div><div class="line"><span class="comment"> *                 : uint32_t wrap</span></div><div class="line"><span class="comment"> * Return value    : Adjusted Tick Value</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> uint32_t apl_minus (uint32_t v_origin, uint32_t v_minus, uint32_t wrap)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (v_origin &gt;= v_minus)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> v_origin - v_minus;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> v_origin + (wrap - v_minus);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_mem_usage_update</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : demo_thread_entry</span></div><div class="line"><span class="comment"> * Description     : Printer Demo Thread</span></div><div class="line"><span class="comment"> * Arguments       : uint32_t thread_input</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> demo_thread_entry (uint32_t thread_input)</div><div class="line">{</div><div class="line">    uint32_t tick0, tick1, diff;</div><div class="line">    uint32_t pmem        = 0;</div><div class="line">    uint8_t  port_status = device_printer_port_status.value;</div><div class="line"></div><div class="line">    <span class="comment">/* Not currently using thread_input. */</span></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="comment">/* Standalone stack: run tasks in application thread loop.  */</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Update memory usage.  */</span></div><div class="line">        apl_mem_usage_update();</div><div class="line"></div><div class="line">        <span class="comment">/* Let other threads to run.  */</span></div><div class="line">        tx_thread_sleep(1);</div><div class="line"></div><div class="line">        <span class="comment">/* Do status change check.  */</span></div><div class="line">        <span class="keywordflow">if</span> (device_printer &amp;&amp;</div><div class="line">            (port_status != device_printer_port_status.value))</div><div class="line">        {</div><div class="line">            ux_device_class_printer_ioctl(device_printer,</div><div class="line">                                          UX_DEVICE_CLASS_PRINTER_IOCTL_PORT_STATUS_SET,</div><div class="line">                                          (<span class="keywordtype">void</span> *) device_printer_port_status.value);</div><div class="line">            port_status = device_printer_port_status.value;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Check time passed and update speed every 1s.  */</span></div><div class="line">        tick1 = tx_time_get();</div><div class="line">        diff  = apl_minus(tick1, tick0, 0xFFFFFFFF);</div><div class="line">        <span class="keywordflow">if</span> (diff &lt; TX_TIMER_TICKS_PER_SECOND)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        tick0 = tick1;</div><div class="line"></div><div class="line">        <span class="comment">/* Print results.  */</span></div><div class="line">        <span class="keywordflow">if</span> ((pmem != test_data.mem_usage_max))</div><div class="line">        {</div><div class="line">            pmem = test_data.mem_usage_max;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function demo_thread_entry</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : printer_read_thread_entry</span></div><div class="line"><span class="comment"> * Description     : USB read operation and echo back the first part of user input on serial terminal.</span></div><div class="line"><span class="comment"> * Arguments       : uint32_t thread_input</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> printer_read_thread_entry (uint32_t thread_input)</div><div class="line">{</div><div class="line">    UINT     status;</div><div class="line">    uint32_t actual_length;</div><div class="line">    UINT     i;</div><div class="line"></div><div class="line">    <span class="comment">/* Not currently using thread_input. */</span></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (device_printer == UX_NULL)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Wait a while before next check.  */</span></div><div class="line">            tx_thread_sleep(10);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        status = ux_device_class_printer_read(device_printer, device_printer_buffer, DATA_LEN, &amp;actual_length);</div><div class="line">        <span class="keywordflow">if</span> (status != UX_SUCCESS)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (actual_length == 0)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function printer_read_thread_entry</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : printer_write_thread_entry</span></div><div class="line"><span class="comment"> * Description     : Periodically checks the printer status.</span></div><div class="line"><span class="comment"> * Arguments       : uint32_t thread_input</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> printer_write_thread_entry (uint32_t thread_input)</div><div class="line">{</div><div class="line">    uint8_t port_status = device_printer_port_status.value;</div><div class="line"></div><div class="line">    <span class="comment">/* Not currently using thread_input. */</span></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(thread_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Wait 2s.  */</span></div><div class="line">        tx_thread_sleep(TX_TIMER_TICKS_PER_SECOND * 2);</div><div class="line">        <span class="keywordflow">if</span> (device_printer &amp;&amp;</div><div class="line">            (port_status != device_printer_port_status.value))</div><div class="line">        {</div><div class="line">            <span class="comment">/* Send status and other information here.  */</span></div><div class="line">            port_status = device_printer_port_status.value;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HPRN Example</h2>
<p>HPRN example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;r_usb_basic.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;r_usb_basic_cfg.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;ux_api.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;ux_system.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;ux_host_class_printer.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Macro definitions</span></div><div class="line"><span class="comment"> *****************************************************************************/</span></div><div class="line"><span class="preprocessor">#define DATA_LEN                   (1030U)</span></div><div class="line"><span class="preprocessor">#define MAX_REQUEST_SIZE           (2048U)</span></div><div class="line"><span class="preprocessor">#define MEMPOOL_SIZE               (18432)</span></div><div class="line"><span class="preprocessor">#define HPRN_FLAG                  ((uint32_t) 0x0001)</span></div><div class="line"><span class="preprocessor">#define VALUE_4                    (4)</span></div><div class="line"><span class="preprocessor">#define MOD_VAL                    (50)</span></div><div class="line"><span class="preprocessor">#define READ_LEN                   (64)</span></div><div class="line"><span class="preprocessor">#define WAIT_TIME                  (50)</span></div><div class="line"><span class="preprocessor">#define SUCCESS                    (0U)</span></div><div class="line"><span class="preprocessor">#define UX_FSP_DEVICE_INSERTION    (0x01U)</span></div><div class="line"><span class="preprocessor">#define UX_FSP_DEVICE_REMOVAL      (0x02U)</span></div><div class="line"><span class="preprocessor">#define RESET_VALUE                (0x00)</span></div><div class="line"></div><div class="line"><span class="comment">/* Private function */</span></div><div class="line"><span class="keyword">static</span> UINT ux_host_usr_event_notification(ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance);</div><div class="line"></div><div class="line"><span class="comment">/* A pointer to store Printer instance. */</span></div><div class="line"><span class="keyword">static</span> UX_HOST_CLASS_PRINTER * p_printer = UX_NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> ULONG    g_write_actual_length = RESET_VALUE;</div><div class="line"><span class="keyword">static</span> ULONG    g_read_actual_length  = RESET_VALUE;</div><div class="line"><span class="keyword">static</span> uint8_t  g_read_buf[DATA_LEN]  = {RESET_VALUE};</div><div class="line"><span class="keyword">static</span> uint8_t  g_read_buf1[DATA_LEN] = {RESET_VALUE};</div><div class="line"><span class="keyword">static</span> uint8_t  g_write_buf[DATA_LEN] = {RESET_VALUE};</div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / VALUE_4];</div><div class="line"></div><div class="line"><span class="comment">/* HPRN Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> hprn_thread_entry (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t status       = RESET_VALUE;</div><div class="line">    ULONG    actual_flags = RESET_VALUE;</div><div class="line">    uint16_t count        = RESET_VALUE;</div><div class="line">    ULONG    port_status  = RESET_VALUE;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    ux_system_initialize(g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, RESET_VALUE);</div><div class="line"></div><div class="line">    <span class="comment">/* ux host stack initialization */</span></div><div class="line">    ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="comment">/*Fill the write buffer*/</span></div><div class="line">    <span class="keywordflow">for</span> (count = RESET_VALUE; count &lt; DATA_LEN; count++)</div><div class="line">    {</div><div class="line">        g_write_buf[count] = (uint8_t) count;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* retrieves event flags from the specified event flags group.*/</span></div><div class="line">        tx_event_flags_get(&amp;g_printer_activate_event_flags0, HPRN_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != p_printer)</div><div class="line">        {</div><div class="line">            <span class="comment">/* GET_PORT_STATUS */</span></div><div class="line">            ux_host_class_printer_status_get(p_printer, &amp;port_status);</div><div class="line"></div><div class="line">            <span class="comment">/*Send the data to device*/</span></div><div class="line">            ux_host_class_printer_write(p_printer, g_write_buf, DATA_LEN, &amp;g_write_actual_length);</div><div class="line"></div><div class="line">            <span class="comment">/* Clear the buffer */</span></div><div class="line">            memset(g_read_buf, RESET_VALUE, <span class="keyword">sizeof</span>(g_read_buf));</div><div class="line"></div><div class="line">            <span class="comment">/* USB receives the data echoed back */</span></div><div class="line">            ux_host_class_printer_read(p_printer, g_read_buf, MAX_REQUEST_SIZE, &amp;g_read_actual_length);</div><div class="line"></div><div class="line">            <span class="comment">/*compare loop-back data*/</span></div><div class="line">            <span class="keywordflow">if</span> (SUCCESS != (memcmp(g_read_buf, g_write_buf, <span class="keyword">sizeof</span>(g_read_buf))))</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            tx_thread_sleep(WAIT_TIME);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (_ux_utility_memory_compare(_ux_system_host_class_printer_name, host_class,</div><div class="line">                                   _ux_utility_string_length_get(_ux_system_host_class_printer_name)) ==</div><div class="line">        UX_SUCCESS)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">        <span class="keywordflow">if</span> (UX_FSP_DEVICE_INSERTION == event)</div><div class="line">        {</div><div class="line">            p_printer = (UX_HOST_CLASS_PRINTER *) instance;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_NULL != p_printer)</div><div class="line">            {</div><div class="line">                <span class="comment">/* This sets or clears event flags in an event flags group */</span></div><div class="line">                tx_event_flags_set(&amp;g_printer_activate_event_flags0, HPRN_FLAG, TX_OR);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="comment">/* Check if there is a device removal */</span></div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_FSP_DEVICE_REMOVAL == event)</div><div class="line">        {</div><div class="line">            <span class="comment">/* This sets or clears event flags in an event flags group */</span></div><div class="line">            tx_event_flags_set(&amp;g_printer_activate_event_flags0, ~HPRN_FLAG, TX_AND);</div><div class="line">            p_printer = UX_NULL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <span class="comment">/*do nothing */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HUVC Example</h2>
<p>HUVC example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Macro definitions</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><span class="preprocessor"> #define RESET_VALUE                       (0x00)</span></div><div class="line"><span class="preprocessor"> #define MEMPOOL_SIZE                      (18432)</span></div><div class="line"><span class="preprocessor"> #define VALUE_4                           (4)</span></div><div class="line"><span class="preprocessor"> #define EVENTFLAG_USB_DEVICE_INSERTED     (0x01)</span></div><div class="line"></div><div class="line"><span class="comment">/* Define the number of buffers used in this demo. */</span></div><div class="line"><span class="preprocessor"> #define MAX_NUM_BUFFERS                   2</span></div><div class="line"></div><div class="line"><span class="preprocessor"> #define USBFS_ISO_PIPE_MAX_PAKCET_SIZE    (256)</span></div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Private function prototypes</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_transfer_request_done_callback(UX_TRANSFER * transfer_request);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_parameter_interval_list(UX_HOST_CLASS_VIDEO * video);</div><div class="line">UINT uvc_parameter_frame_list(UX_HOST_CLASS_VIDEO * video);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_parameter_list(UX_HOST_CLASS_VIDEO * video);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_process_function(UX_HOST_CLASS_VIDEO * video);</div><div class="line">UINT ux_host_usr_event_notification(ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance);</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Private global variables</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / VALUE_4];</div><div class="line"></div><div class="line"><span class="comment">/* video class instance */</span></div><div class="line">UX_HOST_CLASS_VIDEO * <span class="keyword">volatile</span> video_host_class;</div><div class="line"></div><div class="line">TX_EVENT_FLAGS_GROUP g_device_insert_eventflag;</div><div class="line">TX_SEMAPHORE         g_data_received_semaphore;</div><div class="line"></div><div class="line"><span class="comment">/* video buffer */</span></div><div class="line">UCHAR g_video_buffer[10 * 1024];</div><div class="line"></div><div class="line"><span class="comment">/* Name string of VS types */</span></div><div class="line"><span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span>    type;</div><div class="line">    <span class="keywordtype">char</span> * name;</div><div class="line">} vs_type_name[] =</div><div class="line">{</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_UNDEFINED,           <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_UNDEFINED&quot;</span>                              },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_INPUT_HEADER,        <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_INPUT_HEADER&quot;</span>                           },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_OUTPUT_HEADER,       <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_OUTPUT_HEADER&quot;</span>                          },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_STILL_IMAGE_FRAME,   <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_STILL_IMAGE_FRAME&quot;</span>                      },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_UNCOMPRESSED, <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_UNCOMPRESSED&quot;</span>                    },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FRAME_UNCOMPRESSED,  <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FRAME_UNCOMPRESSED&quot;</span>                     },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_MJPEG,        <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_MJPEG&quot;</span>                           },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FRAME_MJPEG,         <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FRAME_MJPEG&quot;</span>                            },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_MPEG2TS,      <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_MPEG2TS&quot;</span>                         },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_DV,           <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_DV&quot;</span>                              },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_COLORFORMAT,         <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_COLORFORMAT&quot;</span>                            },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_FRAME_BASED,  <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_FRAME_BASED&quot;</span>                     },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FRAME_FRAME_BASED,   <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FRAME_FRAME_BASED&quot;</span>                      },</div><div class="line">    {UX_HOST_CLASS_VIDEO_VS_FORMAT_STREAM_BASED, <span class="stringliteral">&quot;UX_HOST_CLASS_VIDEO_VS_FORMAT_STREAM_BASED&quot;</span>                    }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/* HUVC Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> usbx_huvc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t  status       = RESET_VALUE;</div><div class="line">    ULONG     actual_flags = RESET_VALUE;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err          = FSP_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    status = ux_system_initialize(g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, RESET_VALUE);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* ux host stack initialization */</span></div><div class="line">    status = ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    err = <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_device_insert_eventflag, (CHAR *) <span class="stringliteral">&quot;Device Insert Event Flags&quot;</span>);</div><div class="line">    tx_semaphore_create(&amp;g_data_received_semaphore, <span class="stringliteral">&quot;payload semaphore&quot;</span>, 0);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Suspend here until a USBX Host Class Instance gets ready. */</span></div><div class="line">        tx_event_flags_get(&amp;g_device_insert_eventflag,</div><div class="line">                           EVENTFLAG_USB_DEVICE_INSERTED,</div><div class="line">                           TX_OR,</div><div class="line">                           (ULONG *) &amp;actual_flags,</div><div class="line">                           TX_WAIT_FOREVER);</div><div class="line"></div><div class="line">        <span class="comment">/* This delay is required for now to get valid ISO IN UX_ENDPOINT instance. */</span></div><div class="line">        tx_thread_sleep(100);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != video_host_class)</div><div class="line">        {</div><div class="line">            uvc_process_function(video_host_class);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* USBX Host event notification callback function */</span></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS ==</div><div class="line">        _ux_utility_memory_compare(_ux_system_host_class_video_name, host_class,</div><div class="line">                                   _ux_utility_string_length_get(_ux_system_host_class_video_name)))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_INSERTION == event) <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">        {</div><div class="line">            video_host_class = instance;</div><div class="line"></div><div class="line">            <span class="comment">/* Set the event flag to let application know the device insertion. */</span></div><div class="line">            tx_event_flags_set(&amp;g_device_insert_eventflag, EVENTFLAG_USB_DEVICE_INSERTED, TX_OR);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVAL == event)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Clear the event flag in case the camera was removed before the application could clear it. */</span></div><div class="line">            tx_event_flags_set(&amp;g_device_insert_eventflag, (ULONG) ~EVENTFLAG_USB_DEVICE_INSERTED, TX_AND);</div><div class="line"></div><div class="line">            video_host_class = NULL;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Video data received callback function. */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_transfer_request_done_callback (UX_TRANSFER * transfer_request)</div><div class="line">{</div><div class="line">    <span class="comment">/* This is the callback function invoked by UVC class after a packet of</span></div><div class="line"><span class="comment">     * data is received. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* The actual number of bytes being received into the data buffer is</span></div><div class="line"><span class="comment">     * recorded in tranfer_request -&gt; ux_transfer_request_actual_length. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Since this callback function executes in the USB host controller</span></div><div class="line"><span class="comment">     * thread, a semaphore is released so the application can pick up the</span></div><div class="line"><span class="comment">     * video data in application thread. */</span></div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(transfer_request);</div><div class="line"></div><div class="line">    tx_semaphore_put(&amp;g_data_received_semaphore);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the interval types */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_parameter_interval_list (UX_HOST_CLASS_VIDEO * video)</div><div class="line">{</div><div class="line">    UX_HOST_CLASS_VIDEO_FRAME_DESCRIPTOR frame_descriptor;</div><div class="line"></div><div class="line">    ULONG min_frame_interval;</div><div class="line">    ULONG max_frame_interval;</div><div class="line">    ULONG frame_interval_step;</div><div class="line">    <span class="keywordtype">int</span>   i;</div><div class="line"></div><div class="line">    <span class="comment">/* Make the descriptor machine independent.  */</span></div><div class="line">    _ux_utility_descriptor_parse(video-&gt;ux_host_class_video_current_frame_address,</div><div class="line">                                 _ux_system_class_video_frame_descriptor_structure,</div><div class="line">                                 UX_HOST_CLASS_VIDEO_FRAME_DESCRIPTOR_ENTRIES,</div><div class="line">                                 (UCHAR *) &amp;frame_descriptor);</div><div class="line"></div><div class="line">    <span class="comment">/* Check the frame interval type.  */</span></div><div class="line">    <span class="keywordflow">if</span> (0 == frame_descriptor.bFrameIntervalType)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Frame interval type is continuous.  */</span></div><div class="line">        min_frame_interval  = _ux_utility_long_get(video-&gt;ux_host_class_video_current_frame_address + 26);</div><div class="line">        max_frame_interval  = _ux_utility_long_get(video-&gt;ux_host_class_video_current_frame_address + 30);</div><div class="line">        frame_interval_step = _ux_utility_long_get(video-&gt;ux_host_class_video_current_frame_address + 34);</div><div class="line"></div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(min_frame_interval);</div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(max_frame_interval);</div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(frame_interval_step);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the frame resolutions */</span></div><div class="line">UINT uvc_parameter_frame_list (UX_HOST_CLASS_VIDEO * video)</div><div class="line">{</div><div class="line">    ULONG frame_index;</div><div class="line">    UX_HOST_CLASS_VIDEO_PARAMETER_FRAME_DATA frame_parameter;</div><div class="line"></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">/* frame resolutions */</span></div><div class="line">    <span class="keywordflow">for</span> (frame_index = 1; frame_index &lt;= video-&gt;ux_host_class_video_number_frames; frame_index++)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Get frame data for current frame index.  */</span></div><div class="line">        frame_parameter.ux_host_class_video_parameter_frame_requested = frame_index;</div><div class="line">        status = _ux_host_class_video_frame_data_get(video, &amp;frame_parameter);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> status;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Save the current frame index.  */</span></div><div class="line">        video-&gt;ux_host_class_video_current_frame = frame_index;</div><div class="line"></div><div class="line">        uvc_parameter_interval_list(video);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the device parameters */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_parameter_list (UX_HOST_CLASS_VIDEO * video)</div><div class="line">{</div><div class="line">    ULONG format_index;</div><div class="line">    UX_HOST_CLASS_VIDEO_PARAMETER_FORMAT_DATA format_parameter;</div><div class="line"></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line">    <span class="keywordtype">int</span>  i;</div><div class="line"></div><div class="line">    <span class="comment">/* format types */</span></div><div class="line">    <span class="keywordflow">for</span> (format_index = 1; format_index &lt;= video-&gt;ux_host_class_video_number_formats; format_index++)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Get format data for current format index.  */</span></div><div class="line">        format_parameter.ux_host_class_video_parameter_format_requested = format_index;</div><div class="line">        status = _ux_host_class_video_format_data_get(video, &amp;format_parameter);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Save number of frames in the video instance.  */</span></div><div class="line">            video-&gt;ux_host_class_video_number_frames =</div><div class="line">                format_parameter.ux_host_class_video_parameter_number_frame_descriptors;</div><div class="line"></div><div class="line">            uvc_parameter_frame_list(video);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> uvc_process_function (UX_HOST_CLASS_VIDEO * video)</div><div class="line">{</div><div class="line">    <span class="comment">/* This demo uses two buffers. One buffer is used by video device while the</span></div><div class="line"><span class="comment">     * application consumes data in the other buffer. */</span></div><div class="line">    UCHAR * buffer_ptr[MAX_NUM_BUFFERS];</div><div class="line"></div><div class="line">    <span class="comment">/* Index variable keeping track of the current buffer being used by the video device. */</span></div><div class="line">    ULONG buffer_index;</div><div class="line"></div><div class="line">    <span class="comment">/* Maximum buffer requirement reported by the video device. */</span></div><div class="line">    ULONG max_buffer_size;</div><div class="line"></div><div class="line">    UINT  status;</div><div class="line">    ULONG actual_flags;</div><div class="line">    UINT  frame_count;</div><div class="line"></div><div class="line">    UX_HOST_CLASS_VIDEO_PARAMETER_CHANNEL channel;</div><div class="line"></div><div class="line">    <span class="comment">/* List parameters */</span></div><div class="line">    uvc_parameter_list(video);</div><div class="line"></div><div class="line">    <span class="comment">/* Set video parameters. This setting value is a dummy.</span></div><div class="line"><span class="comment">     * Depending on the application, set the necessary parameters. */</span></div><div class="line">    status = ux_host_class_video_frame_parameters_set(video, UX_HOST_CLASS_VIDEO_VS_FORMAT_MJPEG, 176, 144, 333333);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the user callback function of video class. */</span></div><div class="line">    ux_host_class_video_transfer_callback_set(video, uvc_transfer_request_done_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* Find out the maximum memory buffer size for the video configuration</span></div><div class="line"><span class="comment">     * set above. */</span></div><div class="line">    max_buffer_size = ux_host_class_video_max_payload_get(video);</div><div class="line"></div><div class="line">    <span class="comment">/* USBFS&#39;s Max Packet Size is 256 */</span></div><div class="line">    <span class="keywordflow">if</span> (0 == g_basic0_cfg.module_number) <span class="comment">/* 0 : USBFS */</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (max_buffer_size &gt; USBFS_ISO_PIPE_MAX_PAKCET_SIZE)</div><div class="line">        {</div><div class="line">            max_buffer_size = USBFS_ISO_PIPE_MAX_PAKCET_SIZE;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Clear semaphore to zero */</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (TX_NO_INSTANCE == tx_semaphore_get(&amp;g_data_received_semaphore, 0))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (0 == g_basic0_cfg.module_number) <span class="comment">/* 0 : USBFS */</span></div><div class="line">    {</div><div class="line">        video-&gt;ux_host_class_video_transfer_request_start_index = 0;</div><div class="line">        video-&gt;ux_host_class_video_transfer_request_end_index   = 0;</div><div class="line"></div><div class="line">        channel.ux_host_class_video_parameter_format_requested         = video-&gt;ux_host_class_video_current_format;</div><div class="line">        channel.ux_host_class_video_parameter_frame_requested          = video-&gt;ux_host_class_video_current_frame;</div><div class="line">        channel.ux_host_class_video_parameter_frame_interval_requested =</div><div class="line">            video-&gt;ux_host_class_video_current_frame_interval;</div><div class="line">        channel.ux_host_class_video_parameter_channel_bandwidth_selection = max_buffer_size;</div><div class="line"></div><div class="line">        status = ux_host_class_video_ioctl(video, UX_HOST_CLASS_VIDEO_IOCTL_CHANNEL_START, &amp;channel);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">/* Start video transfer.  */</span></div><div class="line">        status = ux_host_class_video_start(video);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Setting these to zero is a hack since we&#39;re mixing old and new APIs (new API does this and is required for reads). */</span></div><div class="line">            video-&gt;ux_host_class_video_transfer_request_start_index = 0;</div><div class="line">            video-&gt;ux_host_class_video_transfer_request_end_index   = 0;</div><div class="line"></div><div class="line">            channel.ux_host_class_video_parameter_format_requested =</div><div class="line">                video-&gt;ux_host_class_video_current_format;</div><div class="line">            channel.ux_host_class_video_parameter_frame_requested =</div><div class="line">                video-&gt;ux_host_class_video_current_frame;</div><div class="line">            channel.ux_host_class_video_parameter_frame_interval_requested =</div><div class="line">                video-&gt;ux_host_class_video_current_frame_interval;</div><div class="line">            channel.ux_host_class_video_parameter_channel_bandwidth_selection = 1024;</div><div class="line"></div><div class="line">            status = ux_host_class_video_ioctl(video, UX_HOST_CLASS_VIDEO_IOCTL_CHANNEL_START, &amp;channel);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate space for video buffer. */</span></div><div class="line">    <span class="keywordflow">for</span> (buffer_index = 0; buffer_index &lt; MAX_NUM_BUFFERS; buffer_index++)</div><div class="line">    {</div><div class="line">        buffer_ptr[buffer_index] = &amp;g_video_buffer[max_buffer_size * buffer_index];</div><div class="line">    }</div><div class="line"></div><div class="line">    buffer_index = 0;</div><div class="line">    frame_count  = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Add the buffer back for video transfer. */</span></div><div class="line">        ux_host_class_video_transfer_buffer_add(video, buffer_ptr[buffer_index]);</div><div class="line"></div><div class="line">        <span class="comment">/* Increment the buffer_index, and wrap to zero if it exceeds the</span></div><div class="line"><span class="comment">         * maximum number of buffers. */</span></div><div class="line">        buffer_index = (buffer_index + 1);</div><div class="line">        <span class="keywordflow">if</span> (buffer_index &gt;= MAX_NUM_BUFFERS)</div><div class="line">        {</div><div class="line">            buffer_index = 0;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Suspend here until a transfer callback is called. */</span></div><div class="line">        status = tx_semaphore_get(&amp;g_data_received_semaphore, 100);</div><div class="line">        <span class="keywordflow">if</span> (TX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Check camera status */</span></div><div class="line">            status = tx_event_flags_get(&amp;g_device_insert_eventflag,</div><div class="line">                                        EVENTFLAG_USB_DEVICE_INSERTED,</div><div class="line">                                        TX_OR,</div><div class="line">                                        (ULONG *) &amp;actual_flags,</div><div class="line">                                        0);</div><div class="line">            <span class="keywordflow">if</span> (TX_SUCCESS == status)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Stop video transfer.  */</span></div><div class="line">                ux_host_class_video_stop(video);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Received data. The callback function needs to obtain the actual</span></div><div class="line"><span class="comment">         * number of bytes received, so the application routine can read the</span></div><div class="line"><span class="comment">         * correct amount of data from the buffer. */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Application can now consume video data while the video device stores</span></div><div class="line"><span class="comment">         * the data into the other buffer. */</span></div><div class="line"></div><div class="line">        frame_count++;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX HAUD Example</h2>
<p>HAUD example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Macro definitions</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><span class="preprocessor"> #define RESET_VALUE                       (0x00)</span></div><div class="line"><span class="preprocessor"> #define MEMPOOL_SIZE                      (18432)</span></div><div class="line"><span class="preprocessor"> #define VALUE_4                           (4)</span></div><div class="line"><span class="preprocessor"> #define EVENTFLAG_USB_DEVICE_INSERTED     (0x01)</span></div><div class="line"></div><div class="line"><span class="comment">/* Define the number of buffers used in this demo. */</span></div><div class="line"><span class="preprocessor"> #define MAX_NUM_BUFFERS                   2</span></div><div class="line"></div><div class="line"><span class="preprocessor"> #define USBFS_ISO_PIPE_MAX_PAKCET_SIZE    (256)</span></div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Private function prototypes</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_transfer_request_done_callback(UX_TRANSFER * transfer_request);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_parameter_interval_list(UX_HOST_CLASS_AUDIO * audio);</div><div class="line">UINT usbx_haudio_parameter_frame_list(UX_HOST_CLASS_AUDIO * audio);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_parameter_list(UX_HOST_CLASS_AUDIO * audio);</div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_process_function(UX_HOST_CLASS_AUDIO * audio);</div><div class="line">UINT ux_host_usr_event_notification(ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance);</div><div class="line"></div><div class="line"><span class="comment">/***********************************************************************************************************************</span></div><div class="line"><span class="comment"> *  Private global variables</span></div><div class="line"><span class="comment"> ***********************************************************************************************************************/</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / VALUE_4];</div><div class="line">audio <span class="keyword">class </span>instance * /</div><div class="line">UX_HOST_CLASS_AUDIO * <span class="keyword">volatile</span> audio_host_class;</div><div class="line"></div><div class="line">TX_EVENT_FLAGS_GROUP g_device_insert_eventflag;</div><div class="line">TX_SEMAPHORE         g_data_received_semaphore;</div><div class="line"></div><div class="line"><span class="comment">/* audio buffer */</span></div><div class="line">UCHAR g_audio_buffer[10 * 1024];</div><div class="line"></div><div class="line"><span class="comment">/* HAUD Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> usbx_haud_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t  status       = RESET_VALUE;</div><div class="line">    ULONG     actual_flags = RESET_VALUE;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err          = FSP_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    status = ux_system_initialize(g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, RESET_VALUE);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* ux host stack initialization */</span></div><div class="line">    status = ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    err = <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    tx_event_flags_create(&amp;g_device_insert_eventflag, (CHAR *) <span class="stringliteral">&quot;Device Insert Event Flags&quot;</span>);</div><div class="line">    tx_semaphore_create(&amp;g_data_received_semaphore, <span class="stringliteral">&quot;payload semaphore&quot;</span>, 0);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Suspend here until a USBX Host Class Instance gets ready. */</span></div><div class="line">        tx_event_flags_get(&amp;g_device_insert_eventflag,</div><div class="line">                           EVENTFLAG_USB_DEVICE_INSERTED,</div><div class="line">                           TX_OR,</div><div class="line">                           (ULONG *) &amp;actual_flags,</div><div class="line">                           TX_WAIT_FOREVER);</div><div class="line"></div><div class="line">        <span class="comment">/* This delay is required for now to get valid ISO IN UX_ENDPOINT instance. */</span></div><div class="line">        tx_thread_sleep(100);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != audio_host_class)</div><div class="line">        {</div><div class="line">            usbx_haudio_process_function(audio_host_class);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* USBX Host event notification callback function */</span></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS ==</div><div class="line">        _ux_utility_memory_compare(_ux_system_host_class_audio_name, host_class,</div><div class="line">                                   _ux_utility_string_length_get(_ux_system_host_class_audio_name)))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_INSERTION == event) <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">        {</div><div class="line">            audio_host_class = instance;</div><div class="line"></div><div class="line">            <span class="comment">/* Set the event flag to let application know the device insertion. */</span></div><div class="line">            tx_event_flags_set(&amp;g_device_insert_eventflag, EVENTFLAG_USB_DEVICE_INSERTED, TX_OR);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVAL == event)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Clear the event flag in case the camera was removed before the application could clear it. */</span></div><div class="line">            tx_event_flags_set(&amp;g_device_insert_eventflag, (ULONG) ~EVENTFLAG_USB_DEVICE_INSERTED, TX_AND);</div><div class="line"></div><div class="line">            audio_host_class = NULL;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Video data received callback function. */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_transfer_request_done_callback (UX_TRANSFER * transfer_request)</div><div class="line">{</div><div class="line">    <span class="comment">/* This is the callback function invoked by Audio class after a packet of</span></div><div class="line"><span class="comment">     * data is received. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* The actual number of bytes being received into the data buffer is</span></div><div class="line"><span class="comment">     * recorded in tranfer_request -&gt; ux_transfer_request_actual_length. */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Since this callback function executes in the USB host controller</span></div><div class="line"><span class="comment">     * thread, a semaphore is released so the application can pick up the</span></div><div class="line"><span class="comment">     * audio data in application thread. */</span></div><div class="line"></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(transfer_request);</div><div class="line"></div><div class="line">    tx_semaphore_put(&amp;g_data_received_semaphore);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the interval types */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_parameter_interval_list (UX_HOST_CLASS_AUDIO * audio; )</div><div class="line">{</div><div class="line">    UX_HOST_CLASS_AUDIO_FRAME_DESCRIPTOR frame_descriptor;</div><div class="line"></div><div class="line">    ULONG min_frame_interval;</div><div class="line">    ULONG max_frame_interval;</div><div class="line">    ULONG frame_interval_step;</div><div class="line">    <span class="keywordtype">int</span>   i;</div><div class="line"></div><div class="line">    <span class="comment">/* Make the descriptor machine independent.  */</span></div><div class="line">    _ux_utility_descriptor_parse(audio-&gt;ux_host_class_audio_current_frame_address,</div><div class="line">                                 _ux_system_class_audio_frame_descriptor_structure,</div><div class="line">                                 UX_HOST_CLASS_AUDIO_FRAME_DESCRIPTOR_ENTRIES,</div><div class="line">                                 (UCHAR *) &amp;frame_descriptor);</div><div class="line"></div><div class="line">    <span class="comment">/* Check the frame interval type.  */</span></div><div class="line">    <span class="keywordflow">if</span> (0 == frame_descriptor.bFrameIntervalType)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Frame interval type is continuous.  */</span></div><div class="line">        min_frame_interval  = _ux_utility_long_get(audio-&gt;ux_host_class_audio_current_frame_address + 26);</div><div class="line">        max_frame_interval  = _ux_utility_long_get(audio-&gt;ux_host_class_audio_current_frame_address + 30);</div><div class="line">        frame_interval_step = _ux_utility_long_get(audio-&gt;ux_host_class_audio_current_frame_address + 34);</div><div class="line"></div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(min_frame_interval);</div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(max_frame_interval);</div><div class="line">        <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(frame_interval_step);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the frame resolutions */</span></div><div class="line">UINT usbx_haudio_parameter_frame_list (UX_HOST_CLASS_AUDIO * audio)</div><div class="line">{</div><div class="line">    ULONG frame_index;</div><div class="line">    UX_HOST_CLASS_AUDIO_PARAMETER_FRAME_DATA frame_parameter;</div><div class="line"></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">/* frame resolutions */</span></div><div class="line">    <span class="keywordflow">for</span> (frame_index = 1; frame_index &lt;= audio-&gt;ux_host_class_audio_number_frames; frame_index++)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Get frame data for current frame index.  */</span></div><div class="line">        frame_parameter.ux_host_class_audio_parameter_frame_requested = frame_index;</div><div class="line">        status = _ux_host_class_audio_frame_data_get(audio, &amp;frame_parameter);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> status;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Save the current frame index.  */</span></div><div class="line">        audio-&gt;ux_host_class_audio_current_frame = frame_index;</div><div class="line"></div><div class="line">        usbx_haudio_parameter_interval_list(audio);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Show the device parameters */</span></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_parameter_list (UX_HOST_CLASS_AUDIO * audio)</div><div class="line">{</div><div class="line">    ULONG format_index;</div><div class="line">    UX_HOST_CLASS_AUDIO_PARAMETER_FORMAT_DATA format_parameter;</div><div class="line"></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line">    <span class="keywordtype">int</span>  i;</div><div class="line"></div><div class="line">    <span class="comment">/* format types */</span></div><div class="line">    <span class="keywordflow">for</span> (format_index = 1; format_index &lt;= audio-&gt;ux_host_class_audio_number_formats; format_index++)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Get format data for current format index.  */</span></div><div class="line">        format_parameter.ux_host_class_audio_parameter_format_requested = format_index;</div><div class="line">        status = _ux_host_class_audio_format_data_get(audio, &amp;format_parameter);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS == status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Save number of frames in the audio instance.  */</span></div><div class="line">            audio-&gt;ux_host_class_audio_number_frames =</div><div class="line">                format_parameter.ux_host_class_audio_parameter_number_frame_descriptors;</div><div class="line"></div><div class="line">            usbx_haudio_parameter_frame_list(audio);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> usbx_haudio_process_function (UX_HOST_CLASS_AUDIO * audio)</div><div class="line">{</div><div class="line">    <span class="comment">/* This demo uses two buffers. One buffer is used by audio device while the</span></div><div class="line"><span class="comment">     * application consumes data in the other buffer. */</span></div><div class="line">    UCHAR * buffer_ptr[MAX_NUM_BUFFERS];</div><div class="line"></div><div class="line">    <span class="comment">/* Index variable keeping track of the current buffer being used by the audio device. */</span></div><div class="line">    ULONG buffer_index;</div><div class="line"></div><div class="line">    <span class="comment">/* Maximum buffer requirement reported by the audio device. */</span></div><div class="line">    ULONG max_buffer_size;</div><div class="line"></div><div class="line">    UINT  status;</div><div class="line">    ULONG actual_flags;</div><div class="line">    UINT  frame_count;</div><div class="line"></div><div class="line">    UX_HOST_CLASS_AUDIO_PARAMETER_CHANNEL channel;</div><div class="line"></div><div class="line">    <span class="comment">/* List parameters */</span></div><div class="line">    usbx_haudio_parameter_list(audio);</div><div class="line"></div><div class="line">    <span class="comment">/* Set audio parameters. This setting value is a dummy.</span></div><div class="line"><span class="comment">     * Depending on the application, set the necessary parameters. */</span></div><div class="line">    status = ux_host_class_audio_frame_parameters_set(audio, UX_HOST_CLASS_AUDIO_VS_FORMAT_MJPEG, 176, 144, 333333);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the user callback function of audio class. */</span></div><div class="line">    ux_host_class_audio_transfer_callback_set(audio, usbx_haudio_transfer_request_done_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* USBFS&#39;s Max Packet Size is 256 */</span></div><div class="line">    <span class="keywordflow">if</span> (0 == g_basic0_cfg.module_number) <span class="comment">/* 0 : USBFS */</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (max_buffer_size &gt; USBFS_ISO_PIPE_MAX_PAKCET_SIZE)</div><div class="line">        {</div><div class="line">            max_buffer_size = USBFS_ISO_PIPE_MAX_PAKCET_SIZE;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Clear semaphore to zero */</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (TX_NO_INSTANCE == tx_semaphore_get(&amp;g_data_received_semaphore, 0))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (0 == g_basic0_cfg.module_number) <span class="comment">/* 0 : USBFS */</span></div><div class="line">    {</div><div class="line">        audio-&gt;ux_host_class_audio_transfer_request_start_index = 0;</div><div class="line">        audio-&gt;ux_host_class_audio_transfer_request_end_index   = 0;</div><div class="line"></div><div class="line">        channel.ux_host_class_audio_parameter_format_requested         = audio-&gt;ux_host_class_audio_current_format;</div><div class="line">        channel.ux_host_class_audio_parameter_frame_requested          = audio-&gt;ux_host_class_audio_current_frame;</div><div class="line">        channel.ux_host_class_audio_parameter_frame_interval_requested =</div><div class="line">            audio-&gt;ux_host_class_audio_current_frame_interval;</div><div class="line">        channel.ux_host_class_audio_parameter_channel_bandwidth_selection = max_buffer_size;</div><div class="line"></div><div class="line">        status = ux_host_class_audio_ioctl(audio, UX_HOST_CLASS_AUDIO_IOCTL_CHANNEL_START, &amp;channel);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">/* Start audio transfer.  */</span></div><div class="line">        status = ux_host_class_audio_start(audio);</div><div class="line">        <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Setting these to zero is a hack since we&#39;re mixing old and new APIs (new API does this and is required for reads). */</span></div><div class="line">            audio-&gt;ux_host_class_audio_transfer_request_start_index = 0;</div><div class="line">            audio-&gt;ux_host_class_audio_transfer_request_end_index   = 0;</div><div class="line"></div><div class="line">            channel.ux_host_class_audio_parameter_format_requested =</div><div class="line">                audio-&gt;ux_host_class_audio_current_format;</div><div class="line">            channel.ux_host_class_audio_parameter_frame_requested =</div><div class="line">                audio-&gt;ux_host_class_audio_current_frame;</div><div class="line">            channel.ux_host_class_audio_parameter_frame_interval_requested =</div><div class="line">                audio-&gt;ux_host_class_audio_current_frame_interval;</div><div class="line">            channel.ux_host_class_audio_parameter_channel_bandwidth_selection = 1024;</div><div class="line"></div><div class="line">            status = ux_host_class_audio_ioctl(audio, UX_HOST_CLASS_AUDIO_IOCTL_CHANNEL_START, &amp;channel);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate space for audio buffer. */</span></div><div class="line">    <span class="keywordflow">for</span> (buffer_index = 0; buffer_index &lt; MAX_NUM_BUFFERS; buffer_index++)</div><div class="line">    {</div><div class="line">        buffer_ptr[buffer_index] = &amp;g_audio_buffer[max_buffer_size * buffer_index];</div><div class="line">    }</div><div class="line"></div><div class="line">    buffer_index = 0;</div><div class="line">    frame_count  = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Increment the buffer_index, and wrap to zero if it exceeds the</span></div><div class="line"><span class="comment">         * maximum number of buffers. */</span></div><div class="line">        buffer_index = (buffer_index + 1);</div><div class="line">        <span class="keywordflow">if</span> (buffer_index &gt;= MAX_NUM_BUFFERS)</div><div class="line">        {</div><div class="line">            buffer_index = 0;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Suspend here until a transfer callback is called. */</span></div><div class="line">        status = tx_semaphore_get(&amp;g_data_received_semaphore, 100);</div><div class="line">        <span class="keywordflow">if</span> (TX_SUCCESS != status)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Check camera status */</span></div><div class="line">            status = tx_event_flags_get(&amp;g_device_insert_eventflag,</div><div class="line">                                        EVENTFLAG_USB_DEVICE_INSERTED,</div><div class="line">                                        TX_OR,</div><div class="line">                                        (ULONG *) &amp;actual_flags,</div><div class="line">                                        0);</div><div class="line">            <span class="keywordflow">if</span> (TX_SUCCESS == status)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Stop audio transfer.  */</span></div><div class="line">                ux_host_class_audio_stop(audio);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Received data. The callback function needs to obtain the actual</span></div><div class="line"><span class="comment">         * number of bytes received, so the application routine can read the</span></div><div class="line"><span class="comment">         * correct amount of data from the buffer. */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Application can now consume audio data while the audio device stores</span></div><div class="line"><span class="comment">         * the data into the other buffer. */</span></div><div class="line"></div><div class="line">        frame_count++;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX DFU Example</h2>
<p>DFU example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> *  Macro definitions</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="preprocessor">#define CDCACM_FLAG                           ((ULONG) 0x0001)</span></div><div class="line"><span class="preprocessor">#define CDCACM_ACTIVATE_FLAG                  ((ULONG) 0x0004)</span></div><div class="line"><span class="preprocessor">#define CDCACM_DEACTIVATE_FLAG                ((ULONG) 0x0008)</span></div><div class="line"><span class="preprocessor">#define DFU_FLAG                              ((ULONG) 0x0001)</span></div><div class="line"><span class="preprocessor">#define DFU_ACTIVATE_FLAG                     ((ULONG) 0x0004)</span></div><div class="line"><span class="preprocessor">#define DFU_DEACTIVATE_FLAG                   ((ULONG) 0x0008)</span></div><div class="line"><span class="preprocessor">#define DFU_DETACH_REQUEST_FLAG               ((ULONG) 0x0200)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define RESET_VALUE                           (0U)</span></div><div class="line"><span class="preprocessor">#define CONFIG_NUMB1                          (1U)</span></div><div class="line"><span class="preprocessor">#define CONFIG_NUMB0                          (0U)</span></div><div class="line"><span class="preprocessor">#define INTERFACE_NUMB0                       (0U)</span></div><div class="line"><span class="preprocessor">#define INTERFACE_NUMB1                       (1U)</span></div><div class="line"><span class="preprocessor">#define INTERFACE_NUMB2                       (2U)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define DFU_DEVICE_FRAME_LENGTH_FULL_SPEED    (45U)</span></div><div class="line"><span class="preprocessor">#define DFU_STRING_FRAMEWORK_LENGTH           (94U)</span></div><div class="line"><span class="preprocessor">#define DFU_FIRM_UPDATE_MAX_TRY               (1U)</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Exported global variables and functions (to be accessed by other files)</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">extern</span> uint8_t g_device_framework_full_speed[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_device_framework_hi_speed[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_language_id_framework[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_string_framework[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_dfu_device_framework_full_speed[];</div><div class="line"><span class="keyword">extern</span> uint8_t g_dfu_string_framework[];</div><div class="line"><span class="keyword">extern</span> uint32_t usb_peri_usbx_initialize(uint32_t dcd_io);</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Global functions and variables</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT usbx_status_callback(ULONG status);</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Private global variables and functions</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate(<span class="keywordtype">void</span> * cdc_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate(<span class="keywordtype">void</span> * cdc_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbx_pcdc_operations(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"><span class="comment">/* Mempool size of 18k is required for USBX device class pre built libraries</span></div><div class="line"><span class="comment"> * and it is valid only if it with default USBX configurations. */</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / BYTE_SIZE];</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM_PARAMETER g_ux_device_class_cdc_acm0_parameter;</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM         * g_cdc;</div><div class="line"><span class="keyword">static</span> ULONG   g_actual_length;</div><div class="line"><span class="keyword">static</span> uint8_t g_buf[DATA_LEN];</div><div class="line"></div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_DFU_PARAMETER g_ux_device_class_dfu_parameter;</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_DFU         * g_dfu;</div><div class="line"><span class="keyword">static</span> UINT g_dfu_firmware_update_done_count = 0;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> dfu_register_function(UINT if_num);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mode_change_dfu_to_cdc(<span class="keywordtype">void</span>);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mode_change_cdc_to_dfu(<span class="keywordtype">void</span>);</div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_write(<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG block_number, UCHAR * data_pointer, ULONG length, ULONG * media_status);</div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_get_status(<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG * media_status);</div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_notify(<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG notification);</div><div class="line"></div><div class="line"><span class="comment">/* PCDC ACM &amp; DFU Thread entry function */</span></div><div class="line"><span class="keywordtype">void</span> pcdc_dfu_thread_entry (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* To check ux api return status */</span></div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">/* To check fsp api return status */</span></div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err          = FSP_SUCCESS;</div><div class="line">    ULONG     actual_flags = 0x0000;</div><div class="line"></div><div class="line">    UX_SLAVE_CLASS_DFU * dfu;</div><div class="line">    UCHAR                state;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    status = ux_system_initialize(g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, RESET_VALUE);</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack initialization */</span></div><div class="line">    status = ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                                        DEVICE_FRAME_LENGTH_HIGH_SPEED,</div><div class="line">                                        g_device_framework_full_speed,</div><div class="line">                                        DEVICE_FRAME_LENGTH_FULL_SPEED,</div><div class="line">                                        g_string_framework,</div><div class="line">                                        STRING_FRAMEWORK_LENGTH,</div><div class="line">                                        g_language_id_framework,</div><div class="line">                                        LANGUAGE_ID_FRAME_WORK_LENGTH,</div><div class="line">                                        &amp;usbx_status_callback);</div><div class="line"></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate   = ux_cdc_device0_instance_activate;</div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack class registration */</span></div><div class="line">    status = ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name,</div><div class="line">                                            _ux_device_class_cdc_acm_entry,</div><div class="line">                                            CONFIG_NUMB1,</div><div class="line">                                            INTERFACE_NUMB0,</div><div class="line">                                            (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack class registration (DFU)*/</span></div><div class="line">    dfu_register_function(INTERFACE_NUMB2); <span class="comment">/* Input : IF number */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    err = <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic1_ctrl, &amp;g_basic1_cfg);</div><div class="line"></div><div class="line">    <span class="comment">/* wait for enumeration event */</span></div><div class="line">    status = tx_event_flags_get(&amp;g_cdcacm_event_flags0, CDCACM_ACTIVATE_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    <span class="keywordflow">if</span> ((actual_flags &amp; CDCACM_ACTIVATE_FLAG) &amp;&amp; (TX_SUCCESS == status))</div><div class="line">    {</div><div class="line">        <span class="comment">/* do nothing */</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(actual_flags &amp; CDCACM_ACTIVATE_FLAG))</div><div class="line">    {</div><div class="line">        <span class="comment">/* do nothing */</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* usb pcdc operations will echo the user input on serial terminal*/</span></div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        state = ux_device_class_dfu_state_get(dfu);</div><div class="line">        <span class="keywordflow">if</span> (UX_SYSTEM_DFU_STATE_APP_IDLE == state)</div><div class="line">        {</div><div class="line">            usbx_pcdc_operations();</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(1);</div><div class="line"></div><div class="line">        tx_event_flags_get(&amp;g_cdcacm_event_flags0, CDCACM_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (actual_flags &amp; CDCACM_FLAG)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (actual_flags &amp; DFU_DETACH_REQUEST_FLAG)</div><div class="line">            {</div><div class="line">                state = ux_device_class_dfu_state_get(dfu);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (UX_SYSTEM_DFU_STATE_APP_DETACH == state)</div><div class="line">                {</div><div class="line">                    mode_change_cdc_to_dfu();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_SYSTEM_DFU_STATE_DFU_MANIFEST_WAIT_RESET == state)</div><div class="line">                {</div><div class="line">                    mode_change_dfu_to_cdc();</div><div class="line">                }</div><div class="line"></div><div class="line">                tx_event_flags_set(&amp;g_cdcacm_event_flags0, ~(DFU_DETACH_REQUEST_FLAG), TX_AND);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_sleep(100);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pcdc_operations</span></div><div class="line"><span class="comment"> * Description     : In this function, it performs the usb write/read operation and echo back the user input on serial terminal</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbx_pcdc_operations (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UX_SLAVE_CLASS_DFU       * dfu;</div><div class="line">    UCHAR                      state;</div><div class="line">    UINT                       status    = UX_SUCCESS;</div><div class="line">    uint32_t                   data_size = RESET_VALUE;</div><div class="line">    <span class="keyword">volatile</span> UX_SLAVE_DEVICE * device;</div><div class="line">    device = &amp;_ux_system_slave-&gt;ux_system_slave_device;</div><div class="line"></div><div class="line">    <span class="comment">/* Wait until usb device is configured to slave */</span></div><div class="line">    <span class="keywordflow">if</span> (device-&gt;ux_slave_device_state != UX_DEVICE_CONFIGURED)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Clear the buffer */</span></div><div class="line">    memset(g_buf, RESET_VALUE, <span class="keyword">sizeof</span>(g_buf));</div><div class="line"></div><div class="line">    <span class="comment">/* USB Reads the input data from the user from serial terminal */</span></div><div class="line">    status = ux_device_class_cdc_acm_read(g_cdc, g_buf, DATA_LEN, &amp;g_actual_length);</div><div class="line"></div><div class="line">    <span class="comment">/* update the data length from the read input */</span></div><div class="line">    data_size = g_actual_length;</div><div class="line"></div><div class="line">    state = ux_device_class_dfu_state_get(dfu);</div><div class="line">    <span class="keywordflow">if</span> (UX_SYSTEM_DFU_STATE_APP_DETACH == state)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Write back the read data on to the serial terminal */</span></div><div class="line">    status = ux_device_class_cdc_acm_write(g_cdc, g_buf, data_size, &amp;g_actual_length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (g_actual_length == device-&gt;ux_slave_device_descriptor.bMaxPacketSize0)</div><div class="line">    {</div><div class="line">        <span class="comment">/* 0-Length-Packet */</span></div><div class="line">        ux_device_class_cdc_acm_write(g_cdc, g_buf, 0, &amp;g_actual_length);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_pcdc_operations</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_cdc = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">    tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_ACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line">    g_cdc = UX_NULL;</div><div class="line">    tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_DEACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_dfu_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * dfu_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_dfu_device0_instance_activate (<span class="keywordtype">void</span> * dfu_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the DFU instance.  */</span></div><div class="line">    g_dfu = (UX_SLAVE_CLASS_DFU *) dfu_instance;</div><div class="line">    tx_event_flags_set(&amp;g_dfu_event_flags0, DFU_ACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_dfu_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_dfu_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear dfu_instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_dfu_device0_instance_deactivate (<span class="keywordtype">void</span> * dfu_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(dfu_instance);</div><div class="line">    g_dfu = UX_NULL;</div><div class="line">    tx_event_flags_set(&amp;g_dfu_event_flags0, DFU_DEACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_dfu_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_status_callback</span></div><div class="line"><span class="comment"> * Description     : Callback on device state change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status : New USB Device Status</span></div><div class="line"><span class="comment"> * Return value    : 0</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT usbx_status_callback (ULONG status)</div><div class="line">{</div><div class="line">    UX_SLAVE_CLASS_DFU * dfu;</div><div class="line">    UCHAR                state;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">        {</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_FLAG, TX_OR);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">        {</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_event_flags0, ~CDCACM_FLAG, TX_AND);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_FORCE_DISCONNECT:</div><div class="line">        {</div><div class="line">            state = ux_device_class_dfu_state_get(dfu);</div><div class="line">            <span class="keywordflow">if</span> ((UX_SYSTEM_DFU_STATE_APP_DETACH == state) ||</div><div class="line">                (UX_SYSTEM_DFU_STATE_DFU_MANIFEST_WAIT_RESET == state))</div><div class="line">            {</div><div class="line">                tx_event_flags_set(&amp;g_cdcacm_event_flags0, DFU_DETACH_REQUEST_FLAG, TX_OR);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">        {</div><div class="line">            <span class="comment">/* do nothing */</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : dfu_register_function</span></div><div class="line"><span class="comment"> * Description     : Register the DFU class device</span></div><div class="line"><span class="comment"> * Arguments       : UINT if_num : Interface number</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> dfu_register_function (UINT if_num)</div><div class="line">{</div><div class="line">    UINT status = UX_SUCCESS;</div><div class="line"></div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_instance_activate   = ux_dfu_device0_instance_activate;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_instance_deactivate =</div><div class="line">        ux_dfu_device0_instance_deactivate;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_framework =</div><div class="line">        g_dfu_device_framework_full_speed;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_framework_length =</div><div class="line">        DFU_DEVICE_FRAME_LENGTH_FULL_SPEED;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_write      = dfu_dammy_write;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_get_status = dfu_dammy_get_status;</div><div class="line">    g_ux_device_class_dfu_parameter.ux_slave_class_dfu_parameter_notify     = dfu_dammy_notify;</div><div class="line"></div><div class="line">    status =</div><div class="line">        ux_device_stack_class_register(_ux_system_slave_class_dfu_name,</div><div class="line">                                       ux_device_class_dfu_entry,</div><div class="line">                                       CONFIG_NUMB1,</div><div class="line">                                       if_num,</div><div class="line">                                       (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_dfu_parameter);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (UX_SUCCESS != status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            tx_thread_sleep(1);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function dfu_register_function</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : dfu_dammy_write</span></div><div class="line"><span class="comment"> * Description     : Write firmware data to media (e.g. non-volatile memory)</span></div><div class="line"><span class="comment"> * Arguments       : VOID *dfu, ULONG block_number, UCHAR * data_pointer, ULONG length, ULONG *media_status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS (or write err result)</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_write (<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG block_number, UCHAR * data_pointer, ULONG length, ULONG * media_status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function dfu_dammy_write</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : dfu_dammy_get_status</span></div><div class="line"><span class="comment"> * Description     : Outputs the status of writing firmware data to media (e.g. non-volatile memory)</span></div><div class="line"><span class="comment"> * Arguments       : VOID *dfu, ULONG *media_status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_get_status (<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG * media_status)</div><div class="line">{</div><div class="line">    *media_status = UX_SLAVE_CLASS_DFU_MEDIA_STATUS_OK;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function dfu_dammy_get_status</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : dfu_dammy_notify</span></div><div class="line"><span class="comment"> * Description     : Notifications about transferring firmware data to applications</span></div><div class="line"><span class="comment"> * Arguments       : VOID *dfu, ULONG notification</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> UINT dfu_dammy_notify (<a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * dfu, ULONG notification)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function dfu_dammy_notify</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : mode_change_cdc_to_dfu</span></div><div class="line"><span class="comment"> * Description     : Switch from normal mode (CDC+DFU) to DFU mode.</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mode_change_cdc_to_dfu (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    INT err;</div><div class="line">    UX_SLAVE_CLASS_DFU * dfu;</div><div class="line">    UCHAR                state;</div><div class="line">    UINT                 status;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (DFU_FIRM_UPDATE_MAX_TRY &lt;= g_dfu_firmware_update_done_count)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    err = <a class="code" href="group___u_s_b.html#ga42c6c75ae96e3860b726d1b0dcbf110d">R_USB_Close</a>(&amp;g_basic1_ctrl);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    status = ux_device_stack_class_unregister(_ux_system_slave_class_cdc_acm_name, _ux_device_class_cdc_acm_entry);</div><div class="line"></div><div class="line">    status = ux_device_stack_class_unregister(_ux_system_slave_class_dfu_name, _ux_device_class_dfu_entry);</div><div class="line"></div><div class="line">    status = ux_device_stack_uninitialize();</div><div class="line"></div><div class="line">    status = ux_device_stack_initialize(UX_NULL,</div><div class="line">                                        UX_NULL,</div><div class="line">                                        g_dfu_device_framework_full_speed,</div><div class="line">                                        DFU_DEVICE_FRAME_LENGTH_FULL_SPEED,</div><div class="line">                                        g_dfu_string_framework,</div><div class="line">                                        DFU_STRING_FRAMEWORK_LENGTH,</div><div class="line">                                        g_language_id_framework,</div><div class="line">                                        LANGUAGE_ID_FRAME_WORK_LENGTH,</div><div class="line">                                        &amp;usbx_status_callback);</div><div class="line"></div><div class="line">    dfu_register_function(INTERFACE_NUMB0); <span class="comment">/* Input : IF number */</span></div><div class="line"></div><div class="line">    err = <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function mode_change_cdc_to_dfu</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : mode_change_dfu_to_cdc</span></div><div class="line"><span class="comment"> * Description     : Switches from DFU mode to normal mode (CDC+DFU).</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mode_change_dfu_to_cdc (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UX_SLAVE_CLASS_DFU * dfu;</div><div class="line">    UCHAR                state;</div><div class="line">    UINT                 status;</div><div class="line">    INT err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (DFU_FIRM_UPDATE_MAX_TRY &lt;= g_dfu_firmware_update_done_count)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_dfu_firmware_update_done_count++;</div><div class="line"></div><div class="line">    err = <a class="code" href="group___u_s_b.html#ga42c6c75ae96e3860b726d1b0dcbf110d">R_USB_Close</a>(&amp;g_basic0_ctrl);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    status = ux_device_stack_class_unregister(_ux_system_slave_class_dfu_name, _ux_device_class_dfu_entry);</div><div class="line"></div><div class="line">    status = ux_device_stack_uninitialize();</div><div class="line"></div><div class="line">    status = ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                                        DEVICE_FRAME_LENGTH_HIGH_SPEED,</div><div class="line">                                        g_device_framework_full_speed,</div><div class="line">                                        DEVICE_FRAME_LENGTH_FULL_SPEED,</div><div class="line">                                        g_string_framework,</div><div class="line">                                        STRING_FRAMEWORK_LENGTH,</div><div class="line">                                        g_language_id_framework,</div><div class="line">                                        LANGUAGE_ID_FRAME_WORK_LENGTH,</div><div class="line">                                        &amp;usbx_status_callback);</div><div class="line"></div><div class="line">    status = ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name,</div><div class="line">                                            _ux_device_class_cdc_acm_entry,</div><div class="line">                                            CONFIG_NUMB1,</div><div class="line">                                            INTERFACE_NUMB0,</div><div class="line">                                            (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    dfu_register_function(INTERFACE_NUMB2); <span class="comment">/* Input:IF number */</span></div><div class="line"></div><div class="line">    err = <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic1_ctrl, &amp;g_basic1_cfg);</div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h2>USBX Composite Example</h2>
<p>USBX Composite (PCDC + PMSC) example is as follows.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/* Mempool size of 14k is required for USBX device class pre built libraries</span></div><div class="line"><span class="comment"> * and it is valid only if it with default USBX configurations. */</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / BYTE_SIZE];</div><div class="line"><span class="keyword">static</span> ULONG    actual_flags = RESET_VALUE;</div><div class="line"></div><div class="line"><span class="comment">/* Mempool size of 18k is required for USBX device class pre built libraries</span></div><div class="line"><span class="comment"> * and it is valid only if it with default USBX configurations. */</span></div><div class="line"><span class="keyword">static</span> uint32_t g_ux_pool_memory[MEMPOOL_SIZE / BYTE_SIZE];</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM_PARAMETER g_ux_device_class_cdc_acm0_parameter;</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM         * g_cdc;</div><div class="line"><span class="keyword">static</span> ULONG   g_actual_length;</div><div class="line"><span class="keyword">static</span> uint8_t g_buf[DATA_LEN];</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span>    b_print_status = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">/* Private function declarations. */</span></div><div class="line">UINT usbx_status_callback(ULONG status);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate(<span class="keywordtype">void</span> * cdc_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate(<span class="keywordtype">void</span> * cdc_instance);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usb_connection_status_check(<span class="keywordtype">void</span>);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbx_pcdc_operations(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_composite_pcdc_mmsc_sample</span></div><div class="line"><span class="comment"> * Description     : Application Thread entry function</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> usbx_composite_pcdc_mmsc_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* ux_system_initialization */</span></div><div class="line">    ux_system_initialize(g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, RESET_VALUE);</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack initialization */</span></div><div class="line">    ux_device_stack_initialize(g_device_framework_hi_speed,</div><div class="line">                               DEVICE_FRAME_LENGTH_HIGH_SPEED,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               DEVICE_FRAME_LENGTH_FULL_SPEED,</div><div class="line">                               g_string_framework,</div><div class="line">                               STRING_FRAMEWORK_LENGTH,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               LANGUAGE_ID_FRAME_WORK_LENGTH,</div><div class="line">                               &amp;usbx_status_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* The activate command is used when the host has sent a SET_CONFIGURATION command</span></div><div class="line"><span class="comment">     * and this interface has to be mounted. Both Bulk endpoints have to be mounted</span></div><div class="line"><span class="comment">     * and the cdc_acm thread needs to be activated.  */</span></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate = ux_cdc_device0_instance_activate;</div><div class="line"></div><div class="line">    <span class="comment">/* The deactivate command is used when the device has been extracted.</span></div><div class="line"><span class="comment">     * The device endpoints have to be dismounted and the cdc_acm thread canceled.  */</span></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line"></div><div class="line">    <span class="comment">/* ux_device stack class registration */</span></div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name,</div><div class="line">                                   _ux_device_class_cdc_acm_entry,</div><div class="line">                                   CONFIG_NUMB,</div><div class="line">                                   INTERFACE_NUMB0,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    <span class="comment">/* Open usb driver */</span></div><div class="line">    <a class="code" href="group___u_s_b.html#gab9810a1d8e322cb89a9a7f9ca84a368f">R_USB_Open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="comment">/*  Wait until device inserted.*/</span></div><div class="line">    tx_event_flags_get(&amp;g_msc_event_flags0, USB_MSC_PLUG_IN, TX_AND_CLEAR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    <span class="keywordflow">if</span> (USB_MSC_PLUG_IN == actual_flags)</div><div class="line">    {</div><div class="line">        ;                              <span class="comment">/* USB MSC device is plugged in */</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Reset the event flag */</span></div><div class="line">    actual_flags = RESET_VALUE;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        <span class="comment">/*  Check if USB is plugged out.*/</span></div><div class="line">        tx_event_flags_get(&amp;g_msc_event_flags0, USB_MSC_PLUG_OUT, TX_AND_CLEAR, &amp;actual_flags, TX_NO_WAIT);</div><div class="line">        <span class="keywordflow">if</span> (USB_MSC_PLUG_OUT == (actual_flags &amp; USB_MSC_PLUG_OUT))</div><div class="line">        {</div><div class="line">            <span class="comment">/* Reset the event flag */</span></div><div class="line">            actual_flags = RESET_VALUE;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/*  Check if USB is plugged in. */</span></div><div class="line">        tx_event_flags_get(&amp;g_msc_event_flags0, USB_MSC_PLUG_IN, TX_AND_CLEAR, &amp;actual_flags, TX_NO_WAIT);</div><div class="line">        <span class="keywordflow">if</span> (USB_MSC_PLUG_IN == (actual_flags &amp; USB_MSC_PLUG_IN))</div><div class="line">        {</div><div class="line">            <span class="comment">/* Reset the event flag */</span></div><div class="line">            actual_flags = RESET_VALUE;</div><div class="line">        }</div><div class="line"></div><div class="line">        usbx_pcdc_operations();</div><div class="line"></div><div class="line">        tx_thread_sleep(1);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_composite_pcdc_mmsc_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_status_callback</span></div><div class="line"><span class="comment"> * Description     : In this function, usb callback events will be captured into one variable.</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status. Whenever any event occurred, status gets update.</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT usbx_status_callback (ULONG status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_ATTACHED:</div><div class="line">        {</div><div class="line">            <span class="comment">/* Set USB PLUG-IN event.*/</span></div><div class="line">            tx_event_flags_set(&amp;g_msc_event_flags0, USB_MSC_PLUG_IN, TX_OR);</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_FLAG, TX_OR);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> UX_DEVICE_REMOVED:</div><div class="line">        {</div><div class="line">            <span class="comment">/* Set USB PLUG-OUT event.*/</span></div><div class="line">            tx_event_flags_set(&amp;g_msc_event_flags0, USB_MSC_PLUG_OUT, TX_OR);</div><div class="line">            tx_event_flags_set(&amp;g_cdcacm_event_flags0, ~CDCACM_FLAG, TX_AND);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">        {</div><div class="line">            <span class="comment">/* do nothing */</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_status_callback</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_cdc = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">    tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_ACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line">    g_cdc = UX_NULL;</div><div class="line">    tx_event_flags_set(&amp;g_cdcacm_event_flags0, CDCACM_DEACTIVATE_FLAG, TX_OR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usb_connection_status_check</span></div><div class="line"><span class="comment"> * Description     : In this function, checks the USB device status</span></div><div class="line"><span class="comment"> *                   and notifies the user by printing the status message</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usb_connection_status_check (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG actual_flags = RESET_VALUE;</div><div class="line"></div><div class="line">    <span class="comment">/* wait for usb connection event */</span></div><div class="line">    tx_event_flags_get(&amp;g_cdcacm_event_flags0, CDCACM_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line">    <span class="keywordflow">if</span> (actual_flags &amp; CDCACM_FLAG)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<span class="keyword">true</span> != b_print_status)</div><div class="line">        {</div><div class="line">            b_print_status = <span class="keyword">true</span>;     <span class="comment">// flag is updated</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <span class="comment">/* do nothing */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        b_print_status = <span class="keyword">false</span>;        <span class="comment">// clear the flag</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> (!(actual_flags &amp; CDCACM_FLAG))</div><div class="line">        {</div><div class="line">            ;                          <span class="comment">/* wait until the event update */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usb_connection_status_check</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : usbx_pcdc_operations</span></div><div class="line"><span class="comment"> * Description     : In this function, it performs the usb write/read operation</span></div><div class="line"><span class="comment"> *                   and echo back the user input on serial terminal</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbx_pcdc_operations (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t data_size = RESET_VALUE;</div><div class="line">    <span class="keyword">volatile</span> UX_SLAVE_DEVICE * device;</div><div class="line">    device = &amp;_ux_system_slave-&gt;ux_system_slave_device;</div><div class="line"></div><div class="line">    <span class="comment">/* Verify the status of usb */</span></div><div class="line">    usb_connection_status_check();</div><div class="line"></div><div class="line">    tx_event_flags_get(&amp;g_cdcacm_event_flags0, CDCACM_ACTIVATE_FLAG, TX_OR, &amp;actual_flags, TX_WAIT_FOREVER);</div><div class="line"></div><div class="line">    <span class="comment">/* USB writes the display message on serial terminal */</span></div><div class="line">    ux_device_class_cdc_acm_write(g_cdc,</div><div class="line">                                  (UCHAR *) <span class="stringliteral">&quot;\r\nEnter any Key to echo back the entered data \r\nUser Input :&quot;</span>,</div><div class="line">                                  WRITE_DATA_LEN,</div><div class="line">                                  &amp;g_actual_length);</div><div class="line"></div><div class="line">    <span class="comment">/* Clear the buffer */</span></div><div class="line">    memset(g_buf, RESET_VALUE, <span class="keyword">sizeof</span>(g_buf));</div><div class="line"></div><div class="line">    <span class="comment">/* USB Reads the input data from the user from serial terminal */</span></div><div class="line">    ux_device_class_cdc_acm_read(g_cdc, g_buf, DATA_LEN, &amp;g_actual_length);</div><div class="line"></div><div class="line">    <span class="comment">/* update the data length from the read input */</span></div><div class="line">    data_size = g_actual_length;</div><div class="line"></div><div class="line">    <span class="comment">/* Write back the read data on to the serial terminal */</span></div><div class="line">    ux_device_class_cdc_acm_write(g_cdc, g_buf, data_size, &amp;g_actual_length);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function usbx_pcdc_operations</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div></div><!-- fragment --> <h2>USBX OTG Example</h2>
<p>OTG example is as follows.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define VALUE_108    (108)</span></div><div class="line"><span class="preprocessor">#define VALUE_105    (105)</span></div><div class="line"><span class="preprocessor">#define VALUE_98     (98)</span></div><div class="line"><span class="preprocessor">#define VALUE_2      (2)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_apl_status_peri = 0;</div><div class="line"></div><div class="line"><span class="keyword">volatile</span> uint8_t      g_apl_state          = UX_DEVICE_REMOVED;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_apl_usb_mode       = UX_OTG_MODE_IDLE;</div><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> ULONG g_change_device_mode = UX_OTG_MODE_IDLE;</div><div class="line"></div><div class="line"><span class="keyword">static</span> UX_HOST_CLASS_CDC_ACM           * g_p_cdc_acm_host = UX_NULL;</div><div class="line"><span class="keyword">static</span> UX_SLAVE_CLASS_CDC_ACM * <span class="keyword">volatile</span> g_p_cdc_peri     = UX_NULL;</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_status_change_cb</span></div><div class="line"><span class="comment"> * Description     : USB callback function for USB status change</span></div><div class="line"><span class="comment"> * Arguments       : ULONG status  : USB status</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT apl_status_change_cb (ULONG status)</div><div class="line">{</div><div class="line">    <span class="comment">// Debug OTG-A Detach</span></div><div class="line">    <span class="keywordflow">if</span> ((UX_DEVICE_REMOVED == g_apl_status_peri) &amp;&amp; (UX_DEVICE_RESUMED == status))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_apl_status_peri = status;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_status_change_cb</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_cdc_peri = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_p_cdc_peri = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* USB OTG Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : apl_device_swich_complete_cb</span></div><div class="line"><span class="comment"> * Description     : Callback function called when switcning Host or Peri</span></div><div class="line"><span class="comment"> * Arguments       : UX_OTG_MODE_SLAVE/UX_OTG_MODE_HOST/UX_OTG_MODE_IDLE</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> apl_device_swich_complete_cb (ULONG mode)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (UX_OTG_MODE_SLAVE == mode)</div><div class="line">    {</div><div class="line">        _ux_system_otg-&gt;ux_system_otg_slave_role_swap_flag = 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_change_device_mode = mode;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_host_apl</span></div><div class="line"><span class="comment"> * Description     : OTG sample program</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> apl_otg_sample (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t   is_host_request_flag = USB_NO;</div><div class="line">    uint8_t   is_host_apl_complete = USB_NO;</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gadfb1288da0fcc7ae1dc88c58601374f8">fsp_err_t</a> err;</div><div class="line"></div><div class="line">    ux_system_initialize((CHAR *) g_ux_pool_memory, MEMPOOL_SIZE, UX_NULL, 0);</div><div class="line"></div><div class="line">    <span class="comment">// B device initialization</span></div><div class="line">    ux_device_stack_initialize(UX_NULL,</div><div class="line">                               UX_NULL,</div><div class="line">                               g_device_framework_full_speed,</div><div class="line">                               VALUE_98,</div><div class="line">                               g_string_framework,</div><div class="line">                               VALUE_105,</div><div class="line">                               g_language_id_framework,</div><div class="line">                               VALUE_2,</div><div class="line">                               apl_status_change_cb);</div><div class="line"></div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_activate   = ux_cdc_device0_instance_activate;</div><div class="line">    g_ux_device_class_cdc_acm0_parameter.ux_slave_class_cdc_acm_instance_deactivate =</div><div class="line">        ux_cdc_device0_instance_deactivate;</div><div class="line">    ux_device_stack_class_register(_ux_system_slave_class_cdc_acm_name,</div><div class="line">                                   _ux_device_class_cdc_acm_entry,</div><div class="line">                                   1,</div><div class="line">                                   0x00,</div><div class="line">                                   (<span class="keywordtype">void</span> *) &amp;g_ux_device_class_cdc_acm0_parameter);</div><div class="line"></div><div class="line">    <span class="comment">// A device initialization</span></div><div class="line">    ux_host_stack_initialize(ux_host_usr_event_notification);</div><div class="line"></div><div class="line">    <a class="code" href="group___u_s_b.html#ga66b9f21c7fc7cce60388edeaf7861d0e">R_USB_OtgCallbackSet</a>(&amp;g_basic0_ctrl, apl_device_swich_complete_cb);</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined(APL_USB_OTG_A_DEVICE)</span></div><div class="line">    err = <a class="code" href="group___i_c_u.html#ga036e85b235d213b257cae159b9eba0a3">R_ICU_ExternalIrqOpen</a>(&amp;g_external_irq0_ctrl, &amp;g_external_irq0_cfg);</div><div class="line">    assert(FSP_SUCCESS == err);</div><div class="line">    err = <a class="code" href="group___i_c_u.html#ga56b7181d7a70a5b8655659d760993ad1">R_ICU_ExternalIrqEnable</a>(&amp;g_external_irq0_ctrl);</div><div class="line">    assert(FSP_SUCCESS == err);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    err = g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#a71c50854a60a443915487767eac07b01">open</a>(&amp;g_basic0_ctrl, &amp;g_basic0_cfg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (FSP_SUCCESS != err)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">while</span> (1)</div><div class="line">        {</div><div class="line">            ;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined(APL_USB_OTG_A_DEVICE)</span></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_OTG_MODE_HOST == g_change_device_mode)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif                                 </span><span class="comment">/* defined(APL_USB_OTG_A_DEVICE) */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (g_change_device_mode != g_apl_usb_mode)</div><div class="line">        {</div><div class="line">            g_apl_usb_mode = g_change_device_mode;</div><div class="line"></div><div class="line">            <span class="keywordflow">switch</span> (g_apl_usb_mode)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">case</span> UX_OTG_MODE_HOST:</div><div class="line">                {</div><div class="line">                    is_host_request_flag = USB_NO;</div><div class="line"></div><div class="line">                    <span class="keywordflow">if</span> (USB_NO == is_host_apl_complete)</div><div class="line">                    {</div><div class="line">                        otg_host_apl();</div><div class="line">                        is_host_apl_complete = USB_YES;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> UX_OTG_MODE_SLAVE:</div><div class="line">                {</div><div class="line">                    is_host_apl_complete = USB_NO;</div><div class="line">                    <span class="keywordflow">if</span> (USB_NO == is_host_request_flag)</div><div class="line">                    {</div><div class="line">                        err = otg_peri_apl();</div><div class="line">                        <span class="keywordflow">if</span> (0 == err)</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">if</span> (UX_OTG_FEATURE_A_HNP_SUPPORT ==</div><div class="line">                                (_ux_system_otg-&gt;ux_system_otg_slave_set_feature_flag &amp; UX_OTG_FEATURE_A_HNP_SUPPORT))</div><div class="line">                            {</div><div class="line">                                _ux_system_otg-&gt;ux_system_otg_slave_role_swap_flag = UX_OTG_HOST_REQUEST_FLAG;</div><div class="line">                                is_host_request_flag = USB_YES;</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                {</div><div class="line">                    <span class="comment">/* UX_MODE_IDLE */</span></div><div class="line">                    is_host_request_flag = USB_NO;</div><div class="line">                    is_host_apl_complete = USB_NO;</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function apl_otg_sample</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* USB Host Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_host_usr_event_notification</span></div><div class="line"><span class="comment"> * Description     : Callback function called when completing USB event</span></div><div class="line"><span class="comment"> * Arguments       : ULONG event               : Completed USB Event</span></div><div class="line"><span class="comment"> *                 : UX_HOST_CLASS *host_class : Pointer to UX_HOST_CLASS structure</span></div><div class="line"><span class="comment"> *                 : VOID * instance           : Pointer to HCDC instance</span></div><div class="line"><span class="comment"> * Return value    : UX_SUCCESS</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">UINT ux_host_usr_event_notification (ULONG event, UX_HOST_CLASS * host_class, <a class="code" href="group___r_m___f_i_l_e_x___l_e_v_e_l_x___n_o_r.html#ga7f319bfc2492a2136964194204e7a8cf">VOID</a> * instance)</div><div class="line">{</div><div class="line">    (void) host_class;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (UX_DEVICE_INSERTION == event)  <span class="comment">/* Check if there is a device insertion. */</span></div><div class="line">    {</div><div class="line">        g_p_cdc_host = (UX_HOST_CLASS_CDC_ACM *) instance;</div><div class="line">        <span class="keywordflow">if</span> (UX_HOST_CLASS_CDC_DATA_CLASS !=</div><div class="line">            g_p_cdc_host-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass)</div><div class="line">        {</div><div class="line">            <span class="comment">/* It seems the DATA class is on the second interface. Or we hope !  */</span></div><div class="line">            g_p_cdc_host = g_p_cdc_host-&gt;ux_host_class_cdc_acm_next_instance;</div><div class="line"></div><div class="line">            <span class="comment">/* Check again this interface, if this is not the data interface, we give up.  */</span></div><div class="line">            <span class="keywordflow">if</span> (UX_HOST_CLASS_CDC_DATA_CLASS !=</div><div class="line">                g_p_cdc_host-&gt;ux_host_class_cdc_acm_interface-&gt;ux_interface_descriptor.bInterfaceClass)</div><div class="line">            {</div><div class="line">                <span class="comment">/* We did not find a proper data interface. */</span></div><div class="line">                g_p_cdc_host = UX_NULL;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (UX_NULL != g_p_cdc_host)</div><div class="line">        {</div><div class="line">            g_host_apl_event = UX_DEVICE_INSERTION;</div><div class="line">        }</div><div class="line"></div><div class="line">        tx_thread_wait_abort(&amp;new_thread0);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((UX_DEVICE_REMOVAL == event) || (UX_DEVICE_DISCONNECTION == event)) <span class="comment">/* Check if there is a device removal. */</span></div><div class="line">    {</div><div class="line">        g_host_apl_event = UX_DEVICE_REMOVAL;</div><div class="line">        g_p_cdc_host     = UX_NULL;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> UX_SUCCESS;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_host_usr_event_notification</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_host_apl</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> otg_host_apl (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ULONG status;</div><div class="line">    m</div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">    {</div><div class="line">        g_write_buf_host[counter] = (uint8_t) counter;</div><div class="line">    }</div><div class="line"></div><div class="line">    g_host_apl_event = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_INSERTION == g_host_apl_event)</div><div class="line">        {</div><div class="line">            g_host_apl_event = 0;</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (countor = 0; countor &lt; 5000; countor++)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (0 == g_is_communicate)</div><div class="line">                {</div><div class="line">                    tx_thread_sleep(100);</div><div class="line">                    g_is_communicate = 1;</div><div class="line">                }</div><div class="line"></div><div class="line">                g_write_actual_length = 0;</div><div class="line">                status                = ux_host_class_cdc_acm_write(g_p_cdc_host,</div><div class="line">                                                                    g_write_buf_host,</div><div class="line">                                                                    DATA_LEN,</div><div class="line">                                                                    &amp;g_write_actual_length_host);</div><div class="line">                <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_write_actual_length_host))</div><div class="line">                {</div><div class="line">                    g_read_actual_length_host = 0;</div><div class="line">                    buffer_clear(g_host_read_buf);</div><div class="line">                    status = ux_host_class_cdc_acm_read(g_p_cdc_host,</div><div class="line">                                                        g_read_buf_host,</div><div class="line">                                                        DATA_LEN,</div><div class="line">                                                        &amp;g_read_actual_length_host);</div><div class="line">                    <span class="keywordflow">if</span> ((UX_SUCCESS == status) &amp;&amp; (DATA_LEN == g_read_actual_length_host))</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">for</span> (counter = 0; counter &lt; DATA_LEN; counter++)</div><div class="line">                        {</div><div class="line">                            <span class="keywordflow">if</span> ((uint8_t) counter != g_read_buf_host[counter])</div><div class="line">                            {</div><div class="line">                                <span class="keywordflow">while</span> (1)</div><div class="line">                                {</div><div class="line">                                    ;</div><div class="line">                                }</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVAL == g_host_apl_event)</div><div class="line">        {</div><div class="line">            g_host_apl_event = 0;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function otg_host_apl</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/* USB Peripheral Application */</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> * Description     : Get instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to the area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_activate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <span class="comment">/* Save the CDC instance.  */</span></div><div class="line">    g_p_cdc_peri = (UX_SLAVE_CLASS_CDC_ACM *) cdc_instance;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_activate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> * Description     : Clear instance</span></div><div class="line"><span class="comment"> * Arguments       : void * cdc_instance  : Pointer to area store the instance pointer</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> ux_cdc_device0_instance_deactivate (<span class="keywordtype">void</span> * cdc_instance)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_e_n_e_s_a_s___e_r_r_o_r___c_o_d_e_s.html#gaf0afcbc9a110ac9366a811d96ee06029">FSP_PARAMETER_NOT_USED</a>(cdc_instance);</div><div class="line"></div><div class="line">    g_p_cdc_peri = UX_NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function ux_cdc_device0_instance_deactivate</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * Function Name   : otg_peri_apl</span></div><div class="line"><span class="comment"> * Description     : Application task (loopback processing)</span></div><div class="line"><span class="comment"> * Arguments       : none</span></div><div class="line"><span class="comment"> * Return value    : none</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line">uint8_t otg_peri_apl (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    UINT     ret;</div><div class="line">    ULONG    size;</div><div class="line">    uint16_t counter = 0;</div><div class="line"></div><div class="line">    g_apl_status_peri = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (counter = 0; counter &lt; 5000; )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (UX_DEVICE_CONFIGURED == g_apl_status_peri)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">while</span> (g_p_cdc_peri == UX_NULL)</div><div class="line">            {</div><div class="line">                ;</div><div class="line">            }</div><div class="line"></div><div class="line">            ret = _ux_device_class_cdc_acm_read(g_p_cdc_peri, g_buf_peri, DATA_LEN, &amp;g_actual_length_peri);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (UX_SUCCESS == ret)</div><div class="line">            {</div><div class="line">                size = g_actual_length_peri;</div><div class="line">                ux_device_class_cdc_acm_write(g_p_cdc_peri, g_buf_peri, size, &amp;g_actual_length_peri);</div><div class="line">                counter++;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UX_DEVICE_REMOVED == g_apl_status_peri)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (0 != counter)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (5000 == counter)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> APL_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> APL_ERROR;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/******************************************************************************</span></div><div class="line"><span class="comment"> * End of function otg_peri_apl</span></div><div class="line"><span class="comment"> ******************************************************************************/</span></div><div class="line"></div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v6.2.0 User's Manual Copyright © (2025) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
